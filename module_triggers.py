from header_common import *
from header_operations import *
from header_parties import *
from header_items import *
from header_skills import *
from header_triggers import *
from header_troops import *

from module_constants import *

####################################################################################################################
#  Each trigger contains the following fields:
# 1) Check interval: How frequently this trigger will be checked
# 2) Delay interval: Time to wait before applying the consequences of the trigger
#    After its conditions have been evaluated as true.
# 3) Re-arm interval. How much time must pass after applying the consequences of the trigger for the trigger to become active again.
#    You can put the constant ti_once here to make sure that the trigger never becomes active again after it fires once.
# 4) Conditions block (list). This must be a valid operation block. See header_operations.py for reference.
#    Every time the trigger is checked, the conditions block will be executed.
#    If the conditions block returns true, the consequences block will be executed.
#    If the conditions block is empty, it is assumed that it always evaluates to true.
# 5) Consequences block (list). This must be a valid operation block. See header_operations.py for reference. 
####################################################################################################################

# Some constants for use below
merchant_inventory_space = 30
num_merchandise_goods = 36



triggers = [
# Tutorial:
  (0.1, 0, ti_once, [(map_free,0)], 
  [
     (call_script, "script_spawn_bandit_low_level"),
     (call_script, "script_spawn_bandit_low_level"),
     (call_script, "script_refresh_center_merchant_gold"),
     (call_script, "script_spawn_fantasy"),
     (dialog_box,"str_tutorial_map2","str_tutorial_map1"),
     #(change_screen_notes, 5, 1),
     (try_begin),
       (eq, "$game_mode", game_mode_heroes),
       (change_screen_notes, 5, 6),
     (else_try),
       (change_screen_notes, 5, 1),
     (try_end),

     
     
  ]),

 # (0.1, 0, ti_once, [(map_free,0)], [(dialog_box,"str_tutorial_map2"),(change_screen_notes, 5, 1),]),
## CC
  (0.0, 0, ti_once, [], []),

  (1, 0, 5, [(map_free),], 
    [
      (try_for_range, ":center_no", walled_centers_begin, walled_centers_end),
        (store_faction_of_party, ":center_faction", ":center_no"),
        (neg|eq, ":center_faction", "fac_commoners"),
        (store_relation, ":cur_relation", "fac_player_supporters_faction", ":center_faction"),
        (lt, ":cur_relation", 0),
        (store_distance_to_party_from_party, ":dist", "p_main_party", ":center_no"),
        (lt, ":dist", 2),
        (display_message, "@You are near to the enemy's realm, the speed of your party have been greatly reduced!", 0xff3333),
      (try_end),
    ]),
## CC

# Refresh Merchants, Armor sellers, Weapon sellers and Horse sellers
  (0.0, 0, 168.0, [],
  [    
    (call_script, "script_refresh_center_inventories"),
    (call_script, "script_refresh_center_armories"),
    (call_script, "script_refresh_center_weaponsmiths"),
    (call_script, "script_refresh_center_stables"),
                     ]),
  

#############

#Captivity:

#  (1.0, 0, 0.0, [],
#   [
#       (ge,"$captivity_mode",1),
#       (store_current_hours,reg(1)),
#       (val_sub,reg(1),"$captivity_end_time"),
#       (ge,reg(1),0),
#       (display_message,"str_nobleman_reached_destination"),
#       (jump_to_menu,"$captivity_end_menu"),
#    ]),


  (5.7, 0, 0.0, 
  [
  ],
  [
  ]),



  (1.0, 0.0, 0.0, [
  (check_quest_active, "qst_track_down_bandits"),
  (neg|check_quest_failed, "qst_track_down_bandits"),
  (neg|check_quest_succeeded, "qst_track_down_bandits"),
  
  ],
   [
    (quest_get_slot, ":bandit_party", "qst_track_down_bandits", slot_quest_target_party),
    (try_begin),
        (party_is_active, ":bandit_party"),
        (store_faction_of_party, ":bandit_party_faction", ":bandit_party"),
        (neg|is_between, ":bandit_party_faction", kingdoms_begin, kingdoms_end), #ie, the party has not respawned as a non-bandit
        
        
        (assign, ":spot_range", 8),
        (try_begin),
            (is_currently_night),
            (assign, ":spot_range", 5),
        (try_end),
        
        (try_for_parties, ":party"),
            (gt, ":party", "p_spawn_points_end"),
            
            (store_faction_of_party, ":faction", ":party"),
            (is_between, ":faction", kingdoms_begin, kingdoms_end),
            
            
            (store_distance_to_party_from_party, ":distance", ":party", ":bandit_party"),
            (lt, ":distance", ":spot_range"),
            (try_begin),
                (eq, "$cheat_mode", 1),
                (str_store_party_name, s4, ":party"),
                (display_message, "@{!}DEBUG -- Wanted bandits spotted by {s4}"),
            (try_end),
            
            (call_script, "script_get_closest_center", ":bandit_party"),
            (assign, ":nearest_center", reg0),
#            (try_begin),
#                (get_party_ai_current_behavior, ":behavior", ":party"),
#                (eq, ":behavior", ai_bhvr_attack_party),
#                (call_script, "script_add_log_entry",  logent_party_chases_wanted_bandits, ":party",  ":nearest_center", ":bandit_party", -1),
#            (else_try),
#                (eq, ":behavior", ai_bhvr_avoid_party),
#                (call_script, "script_add_log_entry",  logent_party_runs_from_wanted_bandits, ":party",  ":nearest_center", ":bandit_party", -1),
#            (else_try),
            (call_script, "script_add_log_entry",  logent_party_spots_wanted_bandits, ":party",  ":nearest_center", ":bandit_party", -1),
#            (try_end),
        (try_end),
    (else_try), #Party not found
        (display_message, "str_bandits_eliminated_by_another"),
        (call_script, "script_abort_quest", "qst_track_down_bandits", 0),
    (try_end),
   ]),

  (1.0, 0.0, 0.0, [
  (check_quest_active, "qst_hunted_down_bandits"),
  (neg|check_quest_failed, "qst_hunted_down_bandits"),
  (neg|check_quest_succeeded, "qst_hunted_down_bandits"),
  ],
   [
    (quest_get_slot, ":bandit_party", "qst_hunted_down_bandits", slot_quest_target_party),
    (try_begin),
      (neg|party_is_active, ":bandit_party"),
      (display_message, "str_bandits_eliminated_by_another"),
      (call_script, "script_abort_quest", "qst_hunted_down_bandits", 0),
    (try_end),
   ]),


#Tax Collectors
# Prisoner Trains
#  (4.1, 0, 0.0, [],
#                     [
#                         (assign, "$pin_faction", "fac_swadians"),
#                         (assign, "$pin_party_template", "pt_swadian_prisoner_train"),
#                         (assign, "$pin_limit", peak_prisoner_trains),
#                         (call_script,"script_cf_spawn_party_at_faction_town_if_below_limit"),
#                         (party_set_ai_behavior,"$pout_party",ai_bhvr_travel_to_party),
#                         (party_set_ai_object,"$pout_party","$pout_town"),
#                    ]),
#
#  (4.1, 0, 0.0, [],
#                     [
#                         (assign, "$pin_faction", "fac_vaegirs"),
#                         (assign, "$pin_party_template", "pt_vaegir_prisoner_train"),
#                         (assign, "$pin_limit", peak_prisoner_trains),
#                         (call_script,"script_cf_spawn_party_at_faction_town_if_below_limit"),
#                         (party_set_ai_behavior,"$pout_party",ai_bhvr_travel_to_party),
#                         (party_set_ai_object,"$pout_party","$pout_town"),
#                    ]),

  (2.0, 0, 0, [(store_random_party_of_template, reg(2), "pt_prisoner_train_party"),
               (party_is_in_any_town,reg(2)),
               ],
              [(store_faction_of_party, ":faction_no", reg(2)),
               (call_script,"script_cf_select_random_walled_center_with_faction", ":faction_no", -1),
               (party_set_ai_behavior,reg(2),ai_bhvr_travel_to_party),
               (party_set_ai_object,reg(2),reg0),
               (party_set_flags, reg(2), pf_default_behavior, 0),
            ]),

##Caravans
#  (4.2, 0, 0.0, [],
#                     [
#                         (assign, "$pin_faction", "fac_swadians"),
#                         (assign, "$pin_party_template", "pt_swadian_caravan"),
#                         (assign, "$pin_limit", peak_kingdom_caravans),
#                         (call_script,"script_cf_spawn_party_at_faction_town_if_below_limit"),
#                         (party_set_ai_behavior,"$pout_party",ai_bhvr_travel_to_party),
#                         (party_set_ai_object,"$pout_party","$pout_town"),
#                    ]),

#  (4.2, 0, 0.0, [],
#                     [
#                         (assign, "$pin_faction", "fac_vaegirs"),
#                         (assign, "$pin_party_template", "pt_vaegir_caravan"),
#                         (assign, "$pin_limit", peak_kingdom_caravans),
#                         (call_script,"script_cf_spawn_party_at_faction_town_if_below_limit"),
#                         (party_set_ai_behavior,"$pout_party",ai_bhvr_travel_to_party),
#                         (party_set_ai_object,"$pout_party","$pout_town"),
#                    ]),

##  (2.0, 0, 0, [(store_random_party_of_template, reg(2), "pt_kingdom_caravan_party"),
##               (party_is_in_any_town,reg(2)),
##               ],
##              [(store_faction_of_party, ":faction_no", reg(2)),
##               (call_script,"script_cf_select_random_town_with_faction", ":faction_no"),
##               (party_set_ai_behavior,reg(2),ai_bhvr_travel_to_party),
##               (party_set_ai_object,reg(2),reg0),
##               (party_set_flags, reg(2), pf_default_behavior, 0),
##            ]),
  
  (4.0, 0, 0.0,
   [
     (eq, "$caravan_escort_state", 1), #cancel caravan_escort_state if caravan leaves the destination
     (assign, ":continue", 0),
     (try_begin),
       (neg|party_is_active, "$caravan_escort_party_id"),
       (assign, ":continue", 1),
     (else_try),
       (get_party_ai_object, ":ai_object", "$caravan_escort_party_id"),
       (neq, ":ai_object", "$caravan_escort_destination_town"),
       (assign, ":continue", 1),
     (try_end),
     (eq, ":continue", 1),
                ],
   [
     (assign, "$caravan_escort_state", 0),
                      ]),

#Messengers
#  (4.2, 0, 0.0, [],
#   [(assign, "$pin_faction", "fac_swadians"),
#    (assign, "$pin_party_template", "pt_swadian_messenger"),
#    (assign, "$pin_limit", peak_kingdom_messengers),
#    (call_script,"script_cf_spawn_party_at_faction_town_if_below_limit"),
#    (party_set_ai_behavior,"$pout_party",ai_bhvr_travel_to_party),
#    (party_set_ai_object,"$pout_party","$pout_town"),
#    ]),

#  (4.2, 0, 0.0, [],
#   [(assign, "$pin_faction", "fac_vaegirs"),
#    (assign, "$pin_party_template", "pt_vaegir_messenger"),
#    (assign, "$pin_limit", peak_kingdom_caravans),
#    (call_script,"script_cf_spawn_party_at_faction_town_if_below_limit"),
#    (party_set_ai_behavior,"$pout_party",ai_bhvr_travel_to_party),
#    (party_set_ai_object,"$pout_party","$pout_town"),
#    ]),

  (1.5, 0, 0, [(store_random_party_of_template, reg(2), "pt_messenger_party"),
               (party_is_in_any_town,reg(2)),
               ],
   [(store_faction_of_party, ":faction_no", reg(2)),
    (call_script,"script_cf_select_random_walled_center_with_faction", ":faction_no", -1),
    (party_set_ai_behavior,reg(2),ai_bhvr_travel_to_party),
    (party_set_ai_object,reg(2),reg0),
    (party_set_flags, reg(2), pf_default_behavior, 0),
    ]),
  
  

#Deserters

#  (10.2, 0, 0.0, [],
#                     [
#                         (assign, "$pin_faction", "fac_swadians"),
#                         (assign, "$pin_party_template", "pt_swadian_deserters"),
#                         (assign, "$pin_limit", 4),
#                         (call_script,"script_cf_spawn_party_at_faction_town_if_below_limit"),
#                    ]),
  
#  (10.2, 0, 0.0, [],
#                     [
#                         (assign, "$pin_faction", "fac_vaegirs"),
#                         (assign, "$pin_party_template", "pt_vaegir_deserters"),
#                         (assign, "$pin_limit", 4),
#                         (call_script,"script_cf_spawn_party_at_faction_town_if_below_limit"),
#                    ]),

#Kingdom Parties
  (3.0, 0, 0.0, [],
   [(try_for_range, ":cur_kingdom", kingdoms_begin, kingdoms_end),
      (faction_slot_eq, ":cur_kingdom", slot_faction_state, sfs_active),
      (neq, ":cur_kingdom", "fac_player_supporters_faction"),
##     
        (eq,1, 0), 
        (eq, "$game_mode", game_mode_heroes),
        (is_between, ":cur_kingdom", bandit_kingdoms_begin, bandit_kingdoms_end),
##        
      (try_begin),
        (store_random_in_range, ":random_no", 0, 100),
        (lt, ":random_no", 10),
        (call_script, "script_create_kingdom_party_if_below_limit", ":cur_kingdom", spt_raider),
      (try_end),
      (try_begin),
        (store_random_in_range, ":random_no", 0, 100),
        (lt, ":random_no", 10),
        (call_script, "script_create_kingdom_party_if_below_limit", ":cur_kingdom", spt_scout),
      (try_end),
      (try_begin),
        (store_random_in_range, ":random_no", 0, 100),
        (lt, ":random_no", 10),
        (call_script, "script_create_kingdom_party_if_below_limit", ":cur_kingdom", spt_patrol),
      (try_end),
##      (try_begin),
##        (store_random_in_range, ":random_no", 0, 100),
##        (lt, ":random_no", 10),
##        (call_script, "script_create_kingdom_party_if_below_limit", ":cur_kingdom", spt_messenger),
##      (try_end),
##      (try_begin),
##        (store_random_in_range, ":random_no", 0, 100),
##        (lt, ":random_no", 10),
##        (call_script, "script_create_kingdom_party_if_below_limit", ":cur_kingdom", spt_kingdom_caravan),
##      (try_end),
      (try_begin),
        (store_random_in_range, ":random_no", 0, 100),
        (lt, ":random_no", 10),
        (call_script, "script_create_kingdom_party_if_below_limit", ":cur_kingdom", spt_prisoner_train),
      (try_end),
    (try_end),
    ]),



##### TODO: QUESTS COMMENT OUT BEGIN

###########################################################################
### Random Governer Quest triggers
###########################################################################

# Incriminate Loyal Advisor quest
  (0.2, 0.0, 0.0,
   [
       (check_quest_active, "qst_incriminate_loyal_commander"),
       (neg|check_quest_concluded, "qst_incriminate_loyal_commander"),
       (quest_slot_eq, "qst_incriminate_loyal_commander", slot_quest_current_state, 2),
       (quest_get_slot, ":quest_target_center", "qst_incriminate_loyal_commander", slot_quest_target_center),
       (quest_get_slot, ":quest_target_party", "qst_incriminate_loyal_commander", slot_quest_target_party),
       (try_begin),
         (neg|party_is_active, ":quest_target_party"),
         (quest_set_slot, "qst_incriminate_loyal_commander", slot_quest_current_state, 3),
         (call_script, "script_fail_quest", "qst_incriminate_loyal_commander"),
       (else_try),
         (party_is_in_town, ":quest_target_party", ":quest_target_center"),
         (remove_party, ":quest_target_party"),
         (quest_set_slot, "qst_incriminate_loyal_commander", slot_quest_current_state, 3),
         (quest_get_slot, ":quest_object_troop", "qst_incriminate_loyal_commander", slot_quest_object_troop),
         (assign, ":num_available_factions", 0),
         (try_for_range, ":faction_no", kingdoms_begin, kingdoms_end),
           (faction_slot_eq, ":faction_no", slot_faction_state, sfs_active),
           (neq, ":faction_no", "fac_player_supporters_faction"),
           (neg|quest_slot_eq, "qst_incriminate_loyal_commander", slot_quest_target_faction, ":faction_no"),
           (val_add, ":num_available_factions", 1),
         (try_end),
         (try_begin),
           (gt, ":num_available_factions", 0),
           (store_random_in_range, ":random_faction", 0, ":num_available_factions"),
           (assign, ":target_faction", -1),
           (try_for_range, ":faction_no", kingdoms_begin, kingdoms_end),
             (eq, ":target_faction", -1),
             (faction_slot_eq, ":faction_no", slot_faction_state, sfs_active),
             (neq, ":faction_no", "fac_player_supporters_faction"),
             (neg|quest_slot_eq, "qst_incriminate_loyal_commander", slot_quest_target_faction, ":faction_no"),
             (val_sub, ":random_faction", 1),
             (lt, ":random_faction", 0),
             (assign, ":target_faction", ":faction_no"),
           (try_end),
         (try_end),
         (try_begin),
           (gt, ":target_faction", 0),
           (call_script, "script_change_troop_faction", ":quest_object_troop", ":target_faction"),
         (else_try),
           (call_script, "script_change_troop_faction", ":quest_object_troop", "fac_robber_knights"),
         (try_end),
         (call_script, "script_succeed_quest", "qst_incriminate_loyal_commander"),
       (try_end),
    ],
   []
   ),
# Runaway Peasants quest
  (0.2, 0.0, 0.0,
   [
       (check_quest_active, "qst_bring_back_runaway_serfs"),
       (neg|check_quest_concluded, "qst_bring_back_runaway_serfs"),
       (quest_get_slot, ":quest_object_center", "qst_bring_back_runaway_serfs", slot_quest_object_center),
       (quest_get_slot, ":quest_target_center", "qst_bring_back_runaway_serfs", slot_quest_target_center),
       (try_begin),
         (party_is_active, "$qst_bring_back_runaway_serfs_party_1"),
         (try_begin),
           (party_is_in_town, "$qst_bring_back_runaway_serfs_party_1", ":quest_target_center"),
           (remove_party, "$qst_bring_back_runaway_serfs_party_1"),
           (val_add, "$qst_bring_back_runaway_serfs_num_parties_fleed", 1),
         (else_try),
           (party_is_in_town, "$qst_bring_back_runaway_serfs_party_1", ":quest_object_center"),
           (remove_party, "$qst_bring_back_runaway_serfs_party_1"),
           (val_add, "$qst_bring_back_runaway_serfs_num_parties_returned", 1),
         (else_try),
           (store_distance_to_party_from_party, ":cur_distance", "p_main_party", "$qst_bring_back_runaway_serfs_party_1"),
           (gt, ":cur_distance", 3),
           (party_set_ai_object, "$qst_bring_back_runaway_serfs_party_1", ":quest_target_center"),
         (try_end),
       (try_end),
       (try_begin),
         (party_is_active, "$qst_bring_back_runaway_serfs_party_2"),
         (try_begin),
           (party_is_in_town, "$qst_bring_back_runaway_serfs_party_2", ":quest_target_center"),
           (remove_party, "$qst_bring_back_runaway_serfs_party_2"),
           (val_add, "$qst_bring_back_runaway_serfs_num_parties_fleed", 1),
         (else_try),
           (party_is_in_town, "$qst_bring_back_runaway_serfs_party_2", ":quest_object_center"),
           (remove_party, "$qst_bring_back_runaway_serfs_party_2"),
           (val_add, "$qst_bring_back_runaway_serfs_num_parties_returned", 1),
         (else_try),
           (store_distance_to_party_from_party, ":cur_distance", "p_main_party", "$qst_bring_back_runaway_serfs_party_2"),
           (gt, ":cur_distance", 3),
           (party_set_ai_object, "$qst_bring_back_runaway_serfs_party_2", ":quest_target_center"),
         (try_end),
       (try_end),
       (try_begin),
         (party_is_active, "$qst_bring_back_runaway_serfs_party_3"),
         (try_begin),
           (party_is_in_town, "$qst_bring_back_runaway_serfs_party_3", ":quest_target_center"),
           (remove_party, "$qst_bring_back_runaway_serfs_party_3"),
           (val_add, "$qst_bring_back_runaway_serfs_num_parties_fleed", 1),
         (else_try),
           (party_is_in_town, "$qst_bring_back_runaway_serfs_party_3", ":quest_object_center"),
           (remove_party, "$qst_bring_back_runaway_serfs_party_3"),
           (val_add, "$qst_bring_back_runaway_serfs_num_parties_returned", 1),
         (else_try),
           (store_distance_to_party_from_party, ":cur_distance", "p_main_party", "$qst_bring_back_runaway_serfs_party_3"),
           (gt, ":cur_distance", 3),
           (party_set_ai_object, "$qst_bring_back_runaway_serfs_party_3", ":quest_target_center"),
         (try_end),
       (try_end),
       (assign, ":sum_removed", "$qst_bring_back_runaway_serfs_num_parties_returned"),
       (val_add, ":sum_removed", "$qst_bring_back_runaway_serfs_num_parties_fleed"),
       (ge, ":sum_removed", 3),
       (try_begin),
         (ge, "$qst_bring_back_runaway_serfs_num_parties_returned", 3),
         (call_script, "script_succeed_quest", "qst_bring_back_runaway_serfs"),
       (else_try),
         (eq, "$qst_bring_back_runaway_serfs_num_parties_returned", 0),
         (call_script, "script_fail_quest", "qst_bring_back_runaway_serfs"),
       (else_try),
         (call_script, "script_conclude_quest", "qst_bring_back_runaway_serfs"),
       (try_end),
    ],
   []
   ),
### Defend Nobles Against Peasants quest
##  (0.2, 0.0, 0.0,
##   [
##       (check_quest_active, "qst_defend_nobles_against_peasants"),
##       (neg|check_quest_succeeded, "qst_defend_nobles_against_peasants"),
##       (neg|check_quest_failed, "qst_defend_nobles_against_peasants"),
##       (quest_get_slot, ":quest_target_center", "qst_defend_nobles_against_peasants", slot_quest_target_center),
##       (assign, ":num_active_parties", 0),
##       (try_begin),
##         (gt, "$qst_defend_nobles_against_peasants_noble_party_1", 0),
##         (party_is_active, "$qst_defend_nobles_against_peasants_noble_party_1"),
##         (val_add, ":num_active_parties", 1),
##         (party_is_in_town, "$qst_defend_nobles_against_peasants_noble_party_1", ":quest_target_center"),
##         (remove_party, "$qst_defend_nobles_against_peasants_noble_party_1"),
##         (party_get_num_companions, ":num_companions", "$qst_defend_nobles_against_peasants_noble_party_1"),
##         (val_add, "$qst_defend_nobles_against_peasants_num_nobles_saved", ":num_companions"),
##       (try_end),
##       (try_begin),
##         (gt, "$qst_defend_nobles_against_peasants_noble_party_2", 0),
##         (party_is_active, "$qst_defend_nobles_against_peasants_noble_party_2"),
##         (val_add, ":num_active_parties", 1),
##         (party_is_in_town, "$qst_defend_nobles_against_peasants_noble_party_2", ":quest_target_center"),
##         (remove_party, "$qst_defend_nobles_against_peasants_noble_party_2"),
##         (party_get_num_companions, ":num_companions", "$qst_defend_nobles_against_peasants_noble_party_2"),
##         (val_add, "$qst_defend_nobles_against_peasants_num_nobles_saved", ":num_companions"),
##       (try_end),
##       (try_begin),
##         (gt, "$qst_defend_nobles_against_peasants_noble_party_3", 0),
##         (party_is_active, "$qst_defend_nobles_against_peasants_noble_party_3"),
##         (val_add, ":num_active_parties", 1),
##         (party_is_in_town, "$qst_defend_nobles_against_peasants_noble_party_3", ":quest_target_center"),
##         (remove_party, "$qst_defend_nobles_against_peasants_noble_party_3"),
##         (party_get_num_companions, ":num_companions", "$qst_defend_nobles_against_peasants_noble_party_3"),
##         (val_add, "$qst_defend_nobles_against_peasants_num_nobles_saved", ":num_companions"),
##       (try_end),
##       (try_begin),
##         (gt, "$qst_defend_nobles_against_peasants_noble_party_4", 0),
##         (party_is_active, "$qst_defend_nobles_against_peasants_noble_party_4"),
##         (val_add, ":num_active_parties", 1),
##         (party_is_in_town, "$qst_defend_nobles_against_peasants_noble_party_4", ":quest_target_center"),
##         (remove_party, "$qst_defend_nobles_against_peasants_noble_party_4"),
##         (party_get_num_companions, ":num_companions", "$qst_defend_nobles_against_peasants_noble_party_4"),
##         (val_add, "$qst_defend_nobles_against_peasants_num_nobles_saved", ":num_companions"),
##       (try_end),
##       (try_begin),
##         (gt, "$qst_defend_nobles_against_peasants_noble_party_5", 0),
##         (party_is_active, "$qst_defend_nobles_against_peasants_noble_party_5"),
##         (val_add, ":num_active_parties", 1),
##         (party_is_in_town, "$qst_defend_nobles_against_peasants_noble_party_5", ":quest_target_center"),
##         (remove_party, "$qst_defend_nobles_against_peasants_noble_party_5"),
##         (party_get_num_companions, ":num_companions", "$qst_defend_nobles_against_peasants_noble_party_5"),
##         (val_add, "$qst_defend_nobles_against_peasants_num_nobles_saved", ":num_companions"),
##       (try_end),
##       (try_begin),
##         (gt, "$qst_defend_nobles_against_peasants_noble_party_6", 0),
##         (party_is_active, "$qst_defend_nobles_against_peasants_noble_party_6"),
##         (val_add, ":num_active_parties", 1),
##         (party_is_in_town, "$qst_defend_nobles_against_peasants_noble_party_6", ":quest_target_center"),
##         (remove_party, "$qst_defend_nobles_against_peasants_noble_party_6"),
##         (party_get_num_companions, ":num_companions", "$qst_defend_nobles_against_peasants_noble_party_6"),
##         (val_add, "$qst_defend_nobles_against_peasants_num_nobles_saved", ":num_companions"),
##       (try_end),
##       (try_begin),
##         (gt, "$qst_defend_nobles_against_peasants_noble_party_7", 0),
##         (party_is_active, "$qst_defend_nobles_against_peasants_noble_party_7"),
##         (val_add, ":num_active_parties", 1),
##         (party_is_in_town, "$qst_defend_nobles_against_peasants_noble_party_7", ":quest_target_center"),
##         (remove_party, "$qst_defend_nobles_against_peasants_noble_party_7"),
##         (party_get_num_companions, ":num_companions", "$qst_defend_nobles_against_peasants_noble_party_7"),
##         (val_add, "$qst_defend_nobles_against_peasants_num_nobles_saved", ":num_companions"),
##       (try_end),
##       (try_begin),
##         (gt, "$qst_defend_nobles_against_peasants_noble_party_8", 0),
##         (party_is_active, "$qst_defend_nobles_against_peasants_noble_party_8"),
##         (val_add, ":num_active_parties", 1),
##         (party_is_in_town, "$qst_defend_nobles_against_peasants_noble_party_8", ":quest_target_center"),
##         (remove_party, "$qst_defend_nobles_against_peasants_noble_party_8"),
##         (party_get_num_companions, ":num_companions", "$qst_defend_nobles_against_peasants_noble_party_8"),
##         (val_add, "$qst_defend_nobles_against_peasants_num_nobles_saved", ":num_companions"),
##       (try_end),
##       (eq, ":num_active_parties", 0),
##       (try_begin),
##         (store_div, ":limit", "$qst_defend_nobles_against_peasants_num_nobles_to_save", 2),
##         (ge, "$qst_defend_nobles_against_peasants_num_nobles_saved", ":limit"),
##         (call_script, "script_succeed_quest", "qst_defend_nobles_against_peasants"),
##       (else_try),
##         (call_script, "script_fail_quest", "qst_defend_nobles_against_peasants"),
##       (try_end),
##    ],
##   []
##   ),
### Capture Conspirators quest
##  (0.15, 0.0, 0.0,
##   [
##       (check_quest_active, "qst_capture_conspirators"),
##       (neg|check_quest_succeeded, "qst_capture_conspirators"),
##       (neg|check_quest_failed, "qst_capture_conspirators"),
##       (quest_get_slot, ":quest_target_center", "qst_capture_conspirators", slot_quest_target_center),
##       (quest_get_slot, ":faction_no", "qst_capture_conspirators", slot_quest_target_faction),
##       (try_begin),
##         (gt, "$qst_capture_conspirators_num_parties_to_spawn", "$qst_capture_conspirators_num_parties_spawned"),
##         (store_random_in_range, ":random_no", 0, 100),
##         (lt, ":random_no", 20),
##         (set_spawn_radius, 3),
##         (spawn_around_party,":quest_target_center","pt_conspirator"),
##         (val_add, "$qst_capture_conspirators_num_parties_spawned", 1),
##         (party_get_num_companions, ":num_companions", reg0),
##         (val_add, "$qst_capture_conspirators_num_troops_to_capture", ":num_companions"),
##         (party_set_ai_behavior, reg0, ai_bhvr_travel_to_party),
##         (party_set_ai_object, reg0, "$qst_capture_conspirators_party_1"),
##         (party_set_flags, reg0, pf_default_behavior, 0),
##         (try_begin),
##           (le, "$qst_capture_conspirators_party_2", 0),
##           (assign, "$qst_capture_conspirators_party_2", reg0),
##         (else_try),
##           (le, "$qst_capture_conspirators_party_3", 0),
##           (assign, "$qst_capture_conspirators_party_3", reg0),
##         (else_try),
##           (le, "$qst_capture_conspirators_party_4", 0),
##           (assign, "$qst_capture_conspirators_party_4", reg0),
##         (else_try),
##           (le, "$qst_capture_conspirators_party_5", 0),
##           (assign, "$qst_capture_conspirators_party_5", reg0),
##         (else_try),
##           (le, "$qst_capture_conspirators_party_6", 0),
##           (assign, "$qst_capture_conspirators_party_6", reg0),
##         (else_try),
##           (le, "$qst_capture_conspirators_party_7", 0),
##           (assign, "$qst_capture_conspirators_party_7", reg0),
##         (try_end),
##       (try_end),
##
##       (assign, ":num_active_parties", 0),
##
##       (try_begin),
##         (gt, "$qst_capture_conspirators_party_1", 0),
##         (party_is_active, "$qst_capture_conspirators_party_1"),
##         (val_add, ":num_active_parties", 1),
##         (try_begin),
##           (party_is_in_any_town, "$qst_capture_conspirators_party_1"),
##           (remove_party, "$qst_capture_conspirators_party_1"),
##         (else_try),
##           (party_get_num_attached_parties, ":num_attachments", "$qst_capture_conspirators_party_1"),
##           (gt, ":num_attachments", 0),
##           (assign, ":leave_meeting", 0),
##           (try_begin),
##             (store_sub, ":required_attachments", "$qst_capture_conspirators_num_parties_to_spawn", 1),
##             (eq, ":num_attachments", ":required_attachments"),
##             (val_add, "$qst_capture_conspirators_leave_meeting_counter", 1),
##             (ge, "$qst_capture_conspirators_leave_meeting_counter", 15),
##             (assign, ":leave_meeting", 1),
##           (try_end),
##           (try_begin),
##             (eq, "$qst_capture_conspirators_num_parties_to_spawn", "$qst_capture_conspirators_num_parties_spawned"),
##             (store_distance_to_party_from_party, ":cur_distance", "p_main_party", "$qst_capture_conspirators_party_1"),
##             (assign, ":min_distance", 3),
##             (try_begin),
##               (is_currently_night),
##               (assign, ":min_distance", 2),
##             (try_end),
##             (lt, ":cur_distance", ":min_distance"),
##             (assign, "$qst_capture_conspirators_leave_meeting_counter", 15),
##             (assign, ":leave_meeting", 1),
##           (try_end),
##           (eq, ":leave_meeting", 1),
##           (party_set_ai_behavior, "$qst_capture_conspirators_party_1", ai_bhvr_travel_to_point),
##           (party_set_flags, "$qst_capture_conspirators_party_1", pf_default_behavior, 0),
##           (party_get_position, pos1, "$qst_capture_conspirators_party_1"),
##           (call_script, "script_map_get_random_position_around_position_within_range", 15, 17),
##           (party_set_ai_target_position, "$qst_capture_conspirators_party_1", pos2),
##           (try_begin),
##             (gt, "$qst_capture_conspirators_party_2", 0),
##             (party_detach, "$qst_capture_conspirators_party_2"),
##             (party_set_ai_behavior, "$qst_capture_conspirators_party_2", ai_bhvr_travel_to_point),
##             (party_set_flags, "$qst_capture_conspirators_party_2", pf_default_behavior, 0),
##             (call_script, "script_map_get_random_position_around_position_within_range", 15, 17),
##             (party_set_ai_target_position, "$qst_capture_conspirators_party_2", pos2),
##           (try_end),
##           (try_begin),
##             (gt, "$qst_capture_conspirators_party_3", 0),
##             (party_detach, "$qst_capture_conspirators_party_3"),
##             (party_set_ai_behavior, "$qst_capture_conspirators_party_3", ai_bhvr_travel_to_point),
##             (party_set_flags, "$qst_capture_conspirators_party_3", pf_default_behavior, 0),
##             (call_script, "script_map_get_random_position_around_position_within_range", 15, 17),
##             (party_set_ai_target_position, "$qst_capture_conspirators_party_3", pos2),
##           (try_end),
##           (try_begin),
##             (gt, "$qst_capture_conspirators_party_4", 0),
##             (party_detach, "$qst_capture_conspirators_party_4"),
##             (party_set_ai_behavior, "$qst_capture_conspirators_party_4", ai_bhvr_travel_to_point),
##             (party_set_flags, "$qst_capture_conspirators_party_4", pf_default_behavior, 0),
##             (call_script, "script_map_get_random_position_around_position_within_range", 15, 17),
##             (party_set_ai_target_position, "$qst_capture_conspirators_party_4", pos2),
##           (try_end),
##           (try_begin),
##             (gt, "$qst_capture_conspirators_party_5", 0),
##             (party_detach, "$qst_capture_conspirators_party_5"),
##             (party_set_ai_behavior, "$qst_capture_conspirators_party_5", ai_bhvr_travel_to_point),
##             (party_set_flags, "$qst_capture_conspirators_party_5", pf_default_behavior, 0),
##             (call_script, "script_map_get_random_position_around_position_within_range", 15, 17),
##             (party_set_ai_target_position, "$qst_capture_conspirators_party_5", pos2),
##           (try_end),
##           (try_begin),
##             (gt, "$qst_capture_conspirators_party_6", 0),
##             (party_detach, "$qst_capture_conspirators_party_6"),
##             (party_set_ai_behavior, "$qst_capture_conspirators_party_6", ai_bhvr_travel_to_point),
##             (party_set_flags, "$qst_capture_conspirators_party_6", pf_default_behavior, 0),
##             (call_script, "script_map_get_random_position_around_position_within_range", 15, 17),
##             (party_set_ai_target_position, "$qst_capture_conspirators_party_6", pos2),
##           (try_end),
##           (try_begin),
##             (gt, "$qst_capture_conspirators_party_7", 0),
##             (party_detach, "$qst_capture_conspirators_party_7"),
##             (party_set_ai_behavior, "$qst_capture_conspirators_party_7", ai_bhvr_travel_to_point),
##             (party_set_flags, "$qst_capture_conspirators_party_7", pf_default_behavior, 0),
##             (call_script, "script_map_get_random_position_around_position_within_range", 15, 17),
##             (party_set_ai_target_position, "$qst_capture_conspirators_party_7", pos2),
##           (try_end),
##         (try_end),
##         (try_begin),
##           (get_party_ai_behavior, ":ai_behavior", "$qst_capture_conspirators_party_1"),
##           (eq, ":ai_behavior", ai_bhvr_travel_to_point),
##           (party_get_ai_target_position, pos2, "$qst_capture_conspirators_party_1"),
##           (party_get_position, pos1, "$qst_capture_conspirators_party_1"),
##           (get_distance_between_positions, ":distance", pos2, pos1),
##           (lt, ":distance", 200),
##           (call_script, "script_get_closest_walled_center_of_faction", "$qst_capture_conspirators_party_1", ":faction_no"),#Can fail
##           (ge, reg0, 0),
##           (party_set_ai_object, "$qst_capture_conspirators_party_1", reg0),
##           (party_set_ai_behavior, "$qst_capture_conspirators_party_1", ai_bhvr_travel_to_party),
##           (party_set_flags, "$qst_capture_conspirators_party_1", pf_default_behavior, 0),
##         (try_end),
##       (try_end),
##       (try_begin),
##         (gt, "$qst_capture_conspirators_party_2", 0),
##         (party_is_active, "$qst_capture_conspirators_party_2"),
##         (val_add, ":num_active_parties", 1),
##         (try_begin),
##           (party_is_in_any_town, "$qst_capture_conspirators_party_2"),
##           (try_begin),
##             (neg|party_is_in_town, "$qst_capture_conspirators_party_2", "$qst_capture_conspirators_party_1"),
##             (remove_party, "$qst_capture_conspirators_party_2"),
##           (else_try),
##             (get_party_ai_behavior, ":ai_behavior", "$qst_capture_conspirators_party_2"),
##             (neq, ":ai_behavior", ai_bhvr_hold),
##             (party_set_ai_behavior, "$qst_capture_conspirators_party_2", ai_bhvr_hold),
##             (party_attach_to_party, "$qst_capture_conspirators_party_2", "$qst_capture_conspirators_party_1"),
##             (party_set_flags, "$qst_capture_conspirators_party_2", pf_default_behavior, 0),
##           (try_end),
##         (try_end),
##         (try_begin),
##           (get_party_ai_behavior, ":ai_behavior", "$qst_capture_conspirators_party_2"),
##           (eq, ":ai_behavior", ai_bhvr_travel_to_point),
##           (party_get_ai_target_position, pos2, "$qst_capture_conspirators_party_2"),
##           (party_get_position, pos1, "$qst_capture_conspirators_party_2"),
##           (get_distance_between_positions, ":distance", pos2, pos1),
##           (lt, ":distance", 200),
##           (call_script, "script_get_closest_walled_center_of_faction", "$qst_capture_conspirators_party_2", ":faction_no"),#Can fail
##           (ge, reg0, 0),
##           (party_set_ai_object, "$qst_capture_conspirators_party_2", reg0),
##           (party_set_ai_behavior, "$qst_capture_conspirators_party_2", ai_bhvr_travel_to_party),
##           (party_set_flags, "$qst_capture_conspirators_party_2", pf_default_behavior, 0),
##         (try_end),
##       (try_end),
##       (try_begin),
##         (gt, "$qst_capture_conspirators_party_3", 0),
##         (party_is_active, "$qst_capture_conspirators_party_3"),
##         (val_add, ":num_active_parties", 1),
##         (try_begin),
##           (party_is_in_any_town, "$qst_capture_conspirators_party_3"),
##           (try_begin),
##             (neg|party_is_in_town, "$qst_capture_conspirators_party_3", "$qst_capture_conspirators_party_1"),
##             (remove_party, "$qst_capture_conspirators_party_3"),
##           (else_try),
##             (get_party_ai_behavior, ":ai_behavior", "$qst_capture_conspirators_party_3"),
##             (neq, ":ai_behavior", ai_bhvr_hold),
##             (party_set_ai_behavior, "$qst_capture_conspirators_party_3", ai_bhvr_hold),
##             (party_attach_to_party, "$qst_capture_conspirators_party_3", "$qst_capture_conspirators_party_1"),
##             (party_set_flags, "$qst_capture_conspirators_party_3", pf_default_behavior, 0),
##           (try_end),
##         (try_end),
##         (try_begin),
##           (get_party_ai_behavior, ":ai_behavior", "$qst_capture_conspirators_party_3"),
##           (eq, ":ai_behavior", ai_bhvr_travel_to_point),
##           (party_get_ai_target_position, pos2, "$qst_capture_conspirators_party_3"),
##           (party_get_position, pos1, "$qst_capture_conspirators_party_3"),
##           (get_distance_between_positions, ":distance", pos2, pos1),
##           (lt, ":distance", 200),
##           (call_script, "script_get_closest_walled_center_of_faction", "$qst_capture_conspirators_party_3", ":faction_no"),#Can fail
##           (ge, reg0, 0),
##           (party_set_ai_object, "$qst_capture_conspirators_party_3", reg0),
##           (party_set_ai_behavior, "$qst_capture_conspirators_party_3", ai_bhvr_travel_to_party),
##           (party_set_flags, "$qst_capture_conspirators_party_3", pf_default_behavior, 0),
##         (try_end),
##       (try_end),
##       (try_begin),
##         (gt, "$qst_capture_conspirators_party_4", 0),
##         (party_is_active, "$qst_capture_conspirators_party_4"),
##         (val_add, ":num_active_parties", 1),
##         (try_begin),
##           (party_is_in_any_town, "$qst_capture_conspirators_party_4"),
##           (try_begin),
##             (neg|party_is_in_town, "$qst_capture_conspirators_party_4", "$qst_capture_conspirators_party_1"),
##             (remove_party, "$qst_capture_conspirators_party_4"),
##           (else_try),
##             (get_party_ai_behavior, ":ai_behavior", "$qst_capture_conspirators_party_4"),
##             (neq, ":ai_behavior", ai_bhvr_hold),
##             (party_set_ai_behavior, "$qst_capture_conspirators_party_4", ai_bhvr_hold),
##             (party_set_flags, "$qst_capture_conspirators_party_4", pf_default_behavior, 0),
##             (party_attach_to_party, "$qst_capture_conspirators_party_4", "$qst_capture_conspirators_party_1"),
##           (try_end),
##         (try_end),
##         (try_begin),
##           (get_party_ai_behavior, ":ai_behavior", "$qst_capture_conspirators_party_4"),
##           (eq, ":ai_behavior", ai_bhvr_travel_to_point),
##           (party_get_ai_target_position, pos2, "$qst_capture_conspirators_party_4"),
##           (party_get_position, pos1, "$qst_capture_conspirators_party_4"),
##           (get_distance_between_positions, ":distance", pos2, pos1),
##           (lt, ":distance", 200),
##           (call_script, "script_get_closest_walled_center_of_faction", "$qst_capture_conspirators_party_4", ":faction_no"),#Can fail
##           (ge, reg0, 0),
##           (party_set_ai_object, "$qst_capture_conspirators_party_4", reg0),
##           (party_set_ai_behavior, "$qst_capture_conspirators_party_4", ai_bhvr_travel_to_party),
##           (party_set_flags, "$qst_capture_conspirators_party_4", pf_default_behavior, 0),
##         (try_end),
##       (try_end),
##       (try_begin),
##         (gt, "$qst_capture_conspirators_party_5", 0),
##         (party_is_active, "$qst_capture_conspirators_party_5"),
##         (val_add, ":num_active_parties", 1),
##         (try_begin),
##           (party_is_in_any_town, "$qst_capture_conspirators_party_5"),
##           (try_begin),
##             (neg|party_is_in_town, "$qst_capture_conspirators_party_5", "$qst_capture_conspirators_party_1"),
##             (remove_party, "$qst_capture_conspirators_party_5"),
##           (else_try),
##             (get_party_ai_behavior, ":ai_behavior", "$qst_capture_conspirators_party_5"),
##             (neq, ":ai_behavior", ai_bhvr_hold),
##             (party_set_ai_behavior, "$qst_capture_conspirators_party_5", ai_bhvr_hold),
##             (party_set_flags, "$qst_capture_conspirators_party_5", pf_default_behavior, 0),
##             (party_attach_to_party, "$qst_capture_conspirators_party_5", "$qst_capture_conspirators_party_1"),
##           (try_end),
##         (try_end),
##         (try_begin),
##           (get_party_ai_behavior, ":ai_behavior", "$qst_capture_conspirators_party_5"),
##           (eq, ":ai_behavior", ai_bhvr_travel_to_point),
##           (party_get_ai_target_position, pos2, "$qst_capture_conspirators_party_5"),
##           (party_get_position, pos1, "$qst_capture_conspirators_party_5"),
##           (get_distance_between_positions, ":distance", pos2, pos1),
##           (lt, ":distance", 200),
##           (call_script, "script_get_closest_walled_center_of_faction", "$qst_capture_conspirators_party_5", ":faction_no"),#Can fail
##           (ge, reg0, 0),
##           (party_set_ai_object, "$qst_capture_conspirators_party_5", reg0),
##           (party_set_ai_behavior, "$qst_capture_conspirators_party_5", ai_bhvr_travel_to_party),
##           (party_set_flags, "$qst_capture_conspirators_party_5", pf_default_behavior, 0),
##         (try_end),
##       (try_end),
##       (try_begin),
##         (gt, "$qst_capture_conspirators_party_6", 0),
##         (party_is_active, "$qst_capture_conspirators_party_6"),
##         (val_add, ":num_active_parties", 1),
##         (try_begin),
##           (party_is_in_any_town, "$qst_capture_conspirators_party_6"),
##           (try_begin),
##             (neg|party_is_in_town, "$qst_capture_conspirators_party_6", "$qst_capture_conspirators_party_1"),
##             (remove_party, "$qst_capture_conspirators_party_6"),
##           (else_try),
##             (get_party_ai_behavior, ":ai_behavior", "$qst_capture_conspirators_party_6"),
##             (neq, ":ai_behavior", ai_bhvr_hold),
##             (party_set_ai_behavior, "$qst_capture_conspirators_party_6", ai_bhvr_hold),
##             (party_set_flags, "$qst_capture_conspirators_party_6", pf_default_behavior, 0),
##             (party_attach_to_party, "$qst_capture_conspirators_party_6", "$qst_capture_conspirators_party_1"),
##           (try_end),
##         (try_end),
##         (try_begin),
##           (get_party_ai_behavior, ":ai_behavior", "$qst_capture_conspirators_party_6"),
##           (eq, ":ai_behavior", ai_bhvr_travel_to_point),
##           (party_get_ai_target_position, pos2, "$qst_capture_conspirators_party_6"),
##           (party_get_position, pos1, "$qst_capture_conspirators_party_6"),
##           (get_distance_between_positions, ":distance", pos2, pos1),
##           (lt, ":distance", 200),
##           (call_script, "script_get_closest_walled_center_of_faction", "$qst_capture_conspirators_party_6", ":faction_no"),#Can fail
##           (ge, reg0, 0),
##           (party_set_ai_object, "$qst_capture_conspirators_party_6", reg0),
##           (party_set_ai_behavior, "$qst_capture_conspirators_party_6", ai_bhvr_travel_to_party),
##           (party_set_flags, "$qst_capture_conspirators_party_6", pf_default_behavior, 0),
##         (try_end),
##       (try_end),
##       (try_begin),
##         (gt, "$qst_capture_conspirators_party_7", 0),
##         (party_is_active, "$qst_capture_conspirators_party_7"),
##         (val_add, ":num_active_parties", 1),
##         (try_begin),
##           (party_is_in_any_town, "$qst_capture_conspirators_party_7"),
##           (try_begin),
##             (neg|party_is_in_town, "$qst_capture_conspirators_party_7", "$qst_capture_conspirators_party_1"),
##             (remove_party, "$qst_capture_conspirators_party_7"),
##           (else_try),
##             (get_party_ai_behavior, ":ai_behavior", "$qst_capture_conspirators_party_7"),
##             (neq, ":ai_behavior", ai_bhvr_hold),
##             (party_set_ai_behavior, "$qst_capture_conspirators_party_7", ai_bhvr_hold),
##             (party_set_flags, "$qst_capture_conspirators_party_7", pf_default_behavior, 0),
##             (party_attach_to_party, "$qst_capture_conspirators_party_7", "$qst_capture_conspirators_party_1"),
##           (try_end),
##         (try_end),
##         (try_begin),
##           (get_party_ai_behavior, ":ai_behavior", "$qst_capture_conspirators_party_7"),
##           (eq, ":ai_behavior", ai_bhvr_travel_to_point),
##           (party_get_ai_target_position, pos2, "$qst_capture_conspirators_party_7"),
##           (party_get_position, pos1, "$qst_capture_conspirators_party_7"),
##           (get_distance_between_positions, ":distance", pos2, pos1),
##           (lt, ":distance", 200),
##           (call_script, "script_get_closest_walled_center_of_faction", "$qst_capture_conspirators_party_7", ":faction_no"),#Can fail
##           (ge, reg0, 0),
##           (party_set_ai_object, "$qst_capture_conspirators_party_7", reg0),
##           (party_set_ai_behavior, "$qst_capture_conspirators_party_7", ai_bhvr_travel_to_party),
##           (party_set_flags, "$qst_capture_conspirators_party_7", pf_default_behavior, 0),
##         (try_end),
##       (try_end),
##
##       (eq, ":num_active_parties", 0),
##       (party_count_prisoners_of_type, ":count_captured_conspirators", "p_main_party", "trp_conspirator"),
##       (party_count_prisoners_of_type, ":count_captured_conspirator_leaders", "p_main_party", "trp_conspirator_leader"),
##       (val_add, ":count_captured_conspirators", ":count_captured_conspirator_leaders"),
##       (try_begin),
##         (store_div, ":limit", "$qst_capture_conspirators_num_troops_to_capture", 2),
##         (gt, ":count_captured_conspirators", ":limit"),
##         (call_script, "script_succeed_quest", "qst_capture_conspirators"),
##       (else_try),
##         (call_script, "script_fail_quest", "qst_capture_conspirators"),
##       (try_end),
##    ],
##   []
##   ),
# Follow Spy quest
  (0.5, 0.0, 0.0,
   [
       (check_quest_active, "qst_follow_spy"),
       (eq, "$qst_follow_spy_no_active_parties", 0),
       (quest_get_slot, ":quest_giver_center", "qst_follow_spy", slot_quest_giver_center),
       (quest_get_slot, ":quest_object_center", "qst_follow_spy", slot_quest_object_center),
       (assign, ":abort_meeting", 0),
       (try_begin),
         (this_or_next|ge, "$qst_follow_spy_run_away", 2),
         (this_or_next|neg|party_is_active, "$qst_follow_spy_spy_party"),
         (neg|party_is_active, "$qst_follow_spy_spy_partners_party"),
       (else_try),
         (eq, "$qst_follow_spy_meeting_state", 0),
         (store_distance_to_party_from_party, ":cur_distance", "p_main_party", "$qst_follow_spy_spy_party"),
         (try_begin),
           (assign, ":min_distance", 3),
           (try_begin),
             (is_currently_night),
             (assign, ":min_distance", 1),
           (try_end),
           (le, ":cur_distance", ":min_distance"),
           (store_distance_to_party_from_party, ":player_distance_to_quest_giver_center", "p_main_party", ":quest_giver_center"),
           (gt, ":player_distance_to_quest_giver_center", 1),
           (val_add, "$qst_follow_spy_run_away", 1),
           (try_begin),
             (eq, "$qst_follow_spy_run_away", 2),
           (assign, ":abort_meeting", 1),
           (display_message, "str_qst_follow_spy_noticed_you"),
           (try_end),
         (else_try),
           (store_distance_to_party_from_party, ":cur_distance", "$qst_follow_spy_spy_partners_party", "$qst_follow_spy_spy_party"),
           (le, ":cur_distance", 1),
           (party_attach_to_party, "$qst_follow_spy_spy_party", "$qst_follow_spy_spy_partners_party"),
           (assign, "$qst_follow_spy_meeting_state", 1),
           (assign, "$qst_follow_spy_meeting_counter", 0),
         (try_end),
       (else_try),
         (eq, "$qst_follow_spy_meeting_state", 1),
         (store_distance_to_party_from_party, ":cur_distance", "p_main_party", "$qst_follow_spy_spy_partners_party"),
         (try_begin),
           (le, ":cur_distance", 1),
           (party_detach, "$qst_follow_spy_spy_party"),
           (val_add, "$qst_follow_spy_run_away", 1),
           (try_begin),
             (eq, "$qst_follow_spy_run_away", 2),
           (assign, ":abort_meeting", 1),
           (display_message, "str_qst_follow_spy_noticed_you"),
           (try_end),
         (else_try),
           (val_add, "$qst_follow_spy_meeting_counter", 1),
           (gt, "$qst_follow_spy_meeting_counter", 4),
           (party_detach, "$qst_follow_spy_spy_party"),
           (assign, ":abort_meeting", 1),
           (assign, "$qst_follow_spy_meeting_state", 2),
         (try_end),
       (try_end),
       (try_begin),
         (eq, ":abort_meeting", 1),
         (party_set_ai_object, "$qst_follow_spy_spy_party", ":quest_giver_center"),
         
         (party_set_ai_object, "$qst_follow_spy_spy_partners_party", ":quest_object_center"),
         
         (party_set_ai_behavior, "$qst_follow_spy_spy_party", ai_bhvr_travel_to_party),
         (party_set_ai_behavior, "$qst_follow_spy_spy_partners_party", ai_bhvr_travel_to_party),
         (party_set_flags, "$qst_follow_spy_spy_party", pf_default_behavior, 0),
         (party_set_flags, "$qst_follow_spy_spy_partners_party", pf_default_behavior, 0),
       (try_end),
       (assign, ":num_active", 0),
       (try_begin),
         (party_is_active, "$qst_follow_spy_spy_party"),
         (val_add, ":num_active", 1),
         (party_is_in_town, "$qst_follow_spy_spy_party", ":quest_giver_center"),
         (remove_party, "$qst_follow_spy_spy_party"),
         (assign, "$qst_follow_spy_spy_back_in_town", 1),
         (val_sub, ":num_active", 1),
       (try_end),
       (try_begin),
         (party_is_active, "$qst_follow_spy_spy_partners_party"),
         (val_add, ":num_active", 1),
         (party_is_in_town, "$qst_follow_spy_spy_partners_party", ":quest_object_center"),
         (remove_party, "$qst_follow_spy_spy_partners_party"),
         (assign, "$qst_follow_spy_partner_back_in_town", 1),
         (val_sub, ":num_active", 1),
       (try_end),
       (try_begin),
         (eq, "$qst_follow_spy_partner_back_in_town",1),
         (eq, "$qst_follow_spy_spy_back_in_town",1),
         (call_script, "script_fail_quest", "qst_follow_spy"),
       (try_end),
       (try_begin),
         (eq, ":num_active", 0),
         (assign, "$qst_follow_spy_no_active_parties", 1),
         (party_count_prisoners_of_type, ":num_spies", "p_main_party", "trp_spy"),
         (party_count_prisoners_of_type, ":num_spy_partners", "p_main_party", "trp_spy_partner"),
         (gt, ":num_spies", 0),
         (gt, ":num_spy_partners", 0),
         (call_script, "script_succeed_quest", "qst_follow_spy"),
       (try_end),
    ],
   []
   ),
### Raiders quest
##  (0.95, 0.0, 0.2,
##   [
##       (check_quest_active, "qst_hunt_down_raiders"),
##       (neg|check_quest_succeeded, "qst_hunt_down_raiders"),
##       (neg|check_quest_failed, "qst_hunt_down_raiders"),
##    ],
##   [
##       (quest_get_slot, ":quest_target_party", "qst_hunt_down_raiders", slot_quest_target_party),
##       (party_set_ai_behavior, ":quest_target_party", ai_bhvr_hold),
##       (party_set_flags, ":quest_target_party", pf_default_behavior, 0),
##    ]
##   ),
##
##  (0.7, 0, 0.2,
##   [
##       (check_quest_active, "qst_hunt_down_raiders"),
##       (neg|check_quest_succeeded, "qst_hunt_down_raiders"),
##       (neg|check_quest_failed, "qst_hunt_down_raiders"),
##    ],
##   [
##       (quest_get_slot, ":quest_target_party", "qst_hunt_down_raiders", slot_quest_target_party),
##       (party_set_ai_behavior,":quest_target_party",ai_bhvr_travel_to_party),
##       (party_set_flags, ":quest_target_party", pf_default_behavior, 0),
##    ]
##   ),
##  
##  (0.1, 0.0, 0.0,
##   [
##       (check_quest_active, "qst_hunt_down_raiders"),
##       (neg|check_quest_succeeded, "qst_hunt_down_raiders"),
##       (neg|check_quest_failed, "qst_hunt_down_raiders"),
##       (quest_get_slot, ":quest_target_party", "qst_hunt_down_raiders", slot_quest_target_party),
##       (neg|party_is_active, ":quest_target_party")
##    ],
##   [
##       (call_script, "script_succeed_quest", "qst_hunt_down_raiders"),
##    ]
##   ),
##  
##  (1.3, 0, 0.0,
##   [
##       (check_quest_active, "qst_hunt_down_raiders"),
##       (neg|check_quest_succeeded, "qst_hunt_down_raiders"),
##       (neg|check_quest_failed, "qst_hunt_down_raiders"),
##       (quest_get_slot, ":quest_target_party", "qst_hunt_down_raiders", slot_quest_target_party),
##       (quest_get_slot, ":quest_target_center", "qst_hunt_down_raiders", slot_quest_target_center),
##       (party_is_in_town,":quest_target_party",":quest_target_center")
##    ],
##   [
##       (call_script, "script_fail_quest", "qst_hunt_down_raiders"),
##       (display_message, "str_raiders_reached_base"),
##       (quest_get_slot, ":quest_target_party", "qst_hunt_down_raiders", slot_quest_target_party),
##       (remove_party, ":quest_target_party"),
##    ]
##   ),

##### TODO: QUESTS COMMENT OUT END

#########################################################################
# Random MERCHANT quest triggers
####################################  
 # Apply interest to merchants guild debt  1% per week
  (24.0 * 7, 0.0, 0.0,
   [],
   [
       (val_mul,"$debt_to_merchants_guild",101),
       (val_div,"$debt_to_merchants_guild",100)
    ]
   ),
# Escort merchant caravan:
  (0.1, 0.0, 0.1, [(check_quest_active, "qst_escort_merchant_caravan"),
                   (eq, "$escort_merchant_caravan_mode", 1)
                   ],
                  [(quest_get_slot, ":quest_target_party", "qst_escort_merchant_caravan", slot_quest_target_party),
                   (try_begin),
                     (party_is_active, ":quest_target_party"),
                     (party_set_ai_behavior, ":quest_target_party", ai_bhvr_hold),
                     (party_set_flags, ":quest_target_party", pf_default_behavior, 0),
                   (try_end),
                   ]),
  (0.1, 0.0, 0.1, [(check_quest_active, "qst_escort_merchant_caravan"),
                    (eq, "$escort_merchant_caravan_mode", 0),
                    ],
                   [(quest_get_slot, ":quest_target_party", "qst_escort_merchant_caravan", slot_quest_target_party),
                    (try_begin),
                      (party_is_active, ":quest_target_party"),
                      (party_set_ai_behavior, ":quest_target_party", ai_bhvr_escort_party),
                      (party_set_flags, ":quest_target_party", pf_default_behavior, 0),
                      (party_set_ai_object, ":quest_target_party", "p_main_party"),
                    (try_end),
                    ]),

  (0.1, 0, 0.0, [(check_quest_active, "qst_escort_merchant_caravan"),
                 (quest_get_slot, ":quest_target_party", "qst_escort_merchant_caravan", slot_quest_target_party),
                 (neg|party_is_active,":quest_target_party"),
                 ],
                [(call_script, "script_abort_quest", "qst_escort_merchant_caravan", 2),
                 ]),

# Troublesome bandits
  (0.3, 0.0, 1.1, [(check_quest_active, "qst_troublesome_bandits"),
                   (neg|check_quest_failed, "qst_troublesome_bandits"),
                   (store_num_parties_destroyed, ":cur_eliminated", "pt_troublesome_bandits"),
                   (lt, "$qst_troublesome_bandits_eliminated", ":cur_eliminated"),
                   (store_num_parties_destroyed_by_player, ":cur_eliminated_by_player", "pt_troublesome_bandits"),
                   (eq, ":cur_eliminated_by_player", "$qst_troublesome_bandits_eliminated_by_player"),
                   ],
                  [(display_message, "str_bandits_eliminated_by_another"),
                   (call_script, "script_abort_quest", "qst_troublesome_bandits", 0),
                   ]),

  (0.3, 0.0, 1.1, [(check_quest_active, "qst_troublesome_bandits"),
                   (neg|check_quest_succeeded, "qst_troublesome_bandits"),
                   (store_num_parties_destroyed, ":cur_eliminated", "pt_troublesome_bandits"),
                   (lt, "$qst_troublesome_bandits_eliminated", ":cur_eliminated"),
                   (store_num_parties_destroyed_by_player, ":cur_eliminated_by_player", "pt_troublesome_bandits"),
                   (neq, ":cur_eliminated_by_player", "$qst_troublesome_bandits_eliminated_by_player"),
                   ],
                  [(call_script, "script_succeed_quest", "qst_troublesome_bandits"),]),
                  
# Kidnapped girl:
   (1, 0, 0,
   [(check_quest_active, "qst_kidnapped_girl"),
    (quest_get_slot, ":quest_target_party", "qst_kidnapped_girl", slot_quest_target_party),
    (party_is_active, ":quest_target_party"),
    (party_is_in_any_town, ":quest_target_party"),
    (remove_party, ":quest_target_party"),
    ],
   []
   ),


#Rebellion changes begin
#move 

  (0, 0, 24 * 14,
   [
        (try_for_range, ":pretender", pretenders_begin, pretenders_end),
          (troop_set_slot, ":pretender", slot_troop_cur_center, 0),
          (neq, ":pretender", "$supported_pretender"),
          (troop_get_slot, ":target_faction", ":pretender", slot_troop_original_faction),
          (faction_slot_eq, ":target_faction", slot_faction_state, sfs_active),
          (faction_slot_eq, ":target_faction", slot_faction_has_rebellion_chance, 1),
          (neg|troop_slot_eq, ":pretender", slot_troop_occupation, slto_kingdom_hero),

          (try_for_range, ":unused", 0, 30),
            (troop_slot_eq, ":pretender", slot_troop_cur_center, 0),
            (store_random_in_range, ":town", towns_begin, towns_end),
            (store_faction_of_party, ":town_faction", ":town"),
            (store_relation, ":relation", ":town_faction", ":target_faction"),
            (le, ":relation", 0), #fail if nothing qualifies
           
            (troop_set_slot, ":pretender", slot_troop_cur_center, ":town"),
            (try_begin),
              (eq, "$cheat_mode", 1),
              (str_store_troop_name, 4, ":pretender"),
              (str_store_party_name, 5, ":town"),
              (display_message, "@{!}{s4} is in {s5}"),
            (try_end),
          (try_end),

#        (try_for_range, ":rebel_faction", rebel_factions_begin, rebel_factions_end),
#            (faction_get_slot, ":rebellion_status", ":rebel_faction", slot_faction_state),
#            (eq, ":rebellion_status", sfs_inactive_rebellion),
#            (faction_get_slot, ":pretender", ":rebel_faction", slot_faction_leader),
#            (faction_get_slot, ":target_faction", ":rebel_faction", slot_faction_rebellion_target),#

#            (store_random_in_range, ":town", towns_begin, towns_end),
#            (store_faction_of_party, ":town_faction", ":town"),
#            (store_relation, ":relation", ":town_faction", ":target_faction"),
#            (le, ":relation", 0), #fail if nothing qualifies

 #           (faction_set_slot, ":rebel_faction", slot_faction_inactive_leader_location, ":town"),
        (try_end), 
       ],
[]
),
#Rebellion changes end

#NPC system changes begin
#Move unemployed NPCs around taverns
   (24 * 7 , 0, 0, 
   [
    (call_script, "script_update_companion_candidates_in_taverns"),
    ],
   []
   ),

#Process morale and determine personality clashes
  (0, 0, 24,
   [],
[

#Count NPCs in party and get the "grievance divisor", which determines how fast grievances go away
#Set their relation to the player
        (assign, ":npcs_in_party", 0),
        (assign, ":grievance_divisor", 100),
        (try_for_range, ":npc1", companions_begin, companions_end),
            (main_party_has_troop, ":npc1"),
            (val_add, ":npcs_in_party", 1),
        (try_end),
        (val_sub, ":grievance_divisor", ":npcs_in_party"),
        (store_skill_level, ":persuasion_level", "skl_persuasion", "trp_player"),
        (try_begin),
          (eq,"$background_answer_3",cb3_troubadour),
          (val_mul, ":persuasion_level", 2),
        (try_end),  
        (val_add, ":grievance_divisor", ":persuasion_level"),
        (assign, reg7, ":grievance_divisor"),

#        (display_message, "@{!}Process NPC changes. GD: {reg7}"),



##Activate personality clash from 24 hours ago
        (try_begin), #scheduled personality clashes require at least 24hrs together
             (gt, "$personality_clash_after_24_hrs", 0),
             (eq, "$disable_npc_complaints", 0),
             (try_begin),
                  (troop_get_slot, ":other_npc", "$personality_clash_after_24_hrs", slot_troop_personalityclash_object),
                  (main_party_has_troop, "$personality_clash_after_24_hrs"),
                  (main_party_has_troop, ":other_npc"),
                  (assign, "$npc_with_personality_clash", "$personality_clash_after_24_hrs"),
             (try_end),
             (assign, "$personality_clash_after_24_hrs", 0),
        (try_end),
#

         
        (try_for_range, ":npc", companions_begin, companions_end),
###Reset meeting variables
            (troop_set_slot, ":npc", slot_troop_turned_down_twice, 0),
            (try_begin),
                (troop_slot_eq, ":npc", slot_troop_met, 1),
                (troop_set_slot, ":npc", slot_troop_met_previously, 1),
            (try_end),

###Check for coming out of retirement
            (troop_get_slot, ":occupation", ":npc", slot_troop_occupation),
            (try_begin),
                (eq, ":occupation", slto_retirement),
                (troop_get_slot, ":renown_min", ":npc", slot_troop_return_renown),

                (str_store_troop_name, s31, ":npc"),
                (troop_get_slot, ":player_renown", "trp_player", slot_troop_renown),
                (assign, reg4, ":player_renown"),
                (assign, reg5, ":renown_min"),
#                (display_message, "@{!}Test {s31}  for retirement return {reg4}, {reg5}."),

                (gt, ":player_renown", ":renown_min"),
                (troop_set_slot, ":npc", slot_troop_personalityclash_penalties, 0),
                (troop_set_slot, ":npc", slot_troop_morality_penalties, 0),
                (troop_set_slot, ":npc", slot_troop_occupation, 0),
            (try_end),


#Check for political issues
            (try_begin), #does npc's opponent pipe up?
                (troop_slot_ge, ":npc", slot_troop_days_on_mission, 5),
                (troop_slot_eq, ":npc", slot_troop_current_mission, npc_mission_kingsupport),

                (troop_get_slot, ":other_npc", ":npc", slot_troop_kingsupport_opponent),
                (troop_slot_eq, ":other_npc", slot_troop_kingsupport_objection_state, 0),
                
                (troop_set_slot, ":other_npc", slot_troop_kingsupport_objection_state, 1),
                
                (str_store_troop_name, s3, ":npc"),
                (str_store_troop_name, s4, ":other_npc"),

                (try_begin),
                    (eq, "$cheat_mode", 1),
                    (display_message, "str_s4_ready_to_voice_objection_to_s3s_mission_if_in_party"),
                (try_end),
            (try_end),

            #Check for quitting
            (try_begin),
                (main_party_has_troop, ":npc"),
                
                (call_script, "script_npc_morale", ":npc"),
                (assign, ":npc_morale", reg0),

                (try_begin),
                    (eq, "$disable_npc_complaints", 0),
                    (lt, ":npc_morale", 20),
                    (store_random_in_range, ":random", 0, 100),
                    (val_add, ":npc_morale", ":random"),
                    (lt, ":npc_morale", 20),
                    (assign, "$npc_is_quitting", ":npc"),
                (try_end),

                #Reduce grievance over time (or augment, if party is overcrowded
                (troop_get_slot, ":grievance", ":npc", slot_troop_personalityclash_penalties),
                (val_mul, ":grievance", 90),
                (val_div, ":grievance", ":grievance_divisor"),
                (troop_set_slot, ":npc", slot_troop_personalityclash_penalties, ":grievance"),

                (troop_get_slot, ":grievance", ":npc", slot_troop_morality_penalties),
                (val_mul, ":grievance", 90),
                (val_div, ":grievance", ":grievance_divisor"),
                (troop_set_slot, ":npc", slot_troop_morality_penalties, ":grievance"),


                #Change personality grievance levels
                (try_begin),
                    (this_or_next|troop_slot_ge, ":npc", slot_troop_personalityclash_state, 1),
                        (eq, "$disable_npc_complaints", 1),
                    (troop_get_slot, ":object", ":npc", slot_troop_personalityclash_object),
                    (main_party_has_troop, ":object"),
                    (call_script, "script_reduce_companion_morale_for_clash", ":npc", ":object", slot_troop_personalityclash_state),
                (try_end),
                (try_begin),
                    (this_or_next|troop_slot_ge, ":npc", slot_troop_personalityclash2_state, 1),
                        (eq, "$disable_npc_complaints", 1),
                    (troop_get_slot, ":object", ":npc", slot_troop_personalityclash2_object),
                    (main_party_has_troop, ":object"),
                    (call_script, "script_reduce_companion_morale_for_clash", ":npc", ":object", slot_troop_personalityclash2_state),
                (try_end),
                (try_begin),
                    (this_or_next|troop_slot_ge, ":npc", slot_troop_personalitymatch_state, 1),
                        (eq, "$disable_npc_complaints", 1),
                    (troop_get_slot, ":object", ":npc", slot_troop_personalitymatch_object),
                    (main_party_has_troop, ":object"),
                    (troop_get_slot, ":grievance", ":npc", slot_troop_personalityclash_penalties),
                    (val_mul, ":grievance", 9),
                    (val_div, ":grievance", 10),
                    (troop_set_slot, ":npc", slot_troop_personalityclash_penalties, ":grievance"),
                (try_end),


                
#Check for new personality clashes

                #Active personality clash 1 if at least 24 hours have passed
                (try_begin),
                    (eq, "$disable_npc_complaints", 0),
                    (eq, "$npc_with_personality_clash", 0),
                    (eq, "$npc_with_personality_clash_2", 0),
                    (eq, "$personality_clash_after_24_hrs", 0),
                    (troop_slot_eq, ":npc", slot_troop_personalityclash_state, 0),
                    (troop_get_slot, ":other_npc", ":npc", slot_troop_personalityclash_object),
                    (main_party_has_troop, ":other_npc"),
                    (assign, "$personality_clash_after_24_hrs", ":npc"),
                (try_end),

                #Personality clash 2 and personality match is triggered by battles
                (try_begin),
                    (eq, "$npc_with_political_grievance", 0),
                
                    (troop_slot_eq, ":npc", slot_troop_kingsupport_objection_state, 1),
                    (assign, "$npc_with_political_grievance", ":npc"),
                (try_end),

            #main party does not have troop, and the troop is a companion
            (else_try), 
                (neg|main_party_has_troop, ":npc"),
                (eq, ":occupation", slto_player_companion),

                
                (troop_get_slot, ":days_on_mission", ":npc", slot_troop_days_on_mission),
                (try_begin),
                    (gt, ":days_on_mission", 0),
                    (val_sub, ":days_on_mission", 1),
                    (troop_set_slot, ":npc", slot_troop_days_on_mission, ":days_on_mission"),
                ##diplomacy begin
        (else_try),
          (troop_slot_eq, ":npc", slot_troop_current_mission, dplmc_npc_mission_spy_request), #spy mission
          (troop_slot_ge, ":npc", dplmc_slot_troop_mission_diplomacy, 1), #caught

          (troop_set_slot, "trp_hired_blade", slot_troop_mission_object, ":npc"),
          (assign, "$npc_to_rejoin_party", "trp_hired_blade"),
        ##diplomacy end
                (else_try), 
                    (troop_slot_ge, ":npc", slot_troop_current_mission, 1),
                    
                    #If the hero can join
                    (this_or_next|neg|troop_slot_eq, ":npc", slot_troop_current_mission, npc_mission_rejoin_when_possible),
                        (hero_can_join, ":npc"),
                        
                    (assign, "$npc_to_rejoin_party", ":npc"),
                (try_end),
            (try_end),
        (try_end),
    ]),




#NPC system changes end


##diplomacy start
  # Appoint chamberlain
   (24 , 0, 24 * 12, 
   [],
   [
    (assign, ":has_fief", 0),
    (try_for_range, ":center_no", centers_begin, centers_end),
      (party_get_slot,  ":lord_troop_id", ":center_no", slot_town_lord),
      (eq, ":lord_troop_id", "trp_player"),
      (assign, ":has_fief", 1),
    (try_end),
    (eq, ":has_fief", 1),
    
    (try_begin), #debug
      (eq, "$cheat_mode", 1),
      (assign, reg0, "$g_player_chamberlain"),
      (display_message, "@{!}DEBUG : chamberlain: {reg0}"),
    (try_end),

    (assign, ":notification", 0),
    (try_begin),
      (eq, "$g_player_chamberlain", 0),
      (assign, ":notification", 1),
    (else_try),
      (neq, "$g_player_chamberlain", -1),
      (neq, "$g_player_chamberlain", "trp_dplmc_chamberlain"),
      (assign, ":notification", 1),
    (try_end),
    
    (try_begin),
      (eq, ":notification", 1),
      (call_script, "script_add_notification_menu", "mnu_dplmc_notification_appoint_chamberlain", 0, 0),
    (try_end),]
   ),
   
  # Appoint constable
   (24 , 0, 24 * 13, 
   [],
   [
    (assign, ":has_fief", 0),
    (try_for_range, ":center_no", walled_centers_begin, walled_centers_end),
      (party_get_slot,  ":lord_troop_id", ":center_no", slot_town_lord),
      (eq, ":lord_troop_id", "trp_player"),
      (assign, ":has_fief", 1),
    (try_end),
    (eq, ":has_fief", 1),
    
    (try_begin), #debug
      (eq, "$cheat_mode", 1),
      (assign, reg0, "$g_player_constable"),
      (display_message, "@{!}DEBUG : constable: {reg0}"),
    (try_end),

    (assign, ":notification", 0),
    (try_begin),
      (eq, "$g_player_constable", 0),
      (assign, ":notification", 1),
    (else_try),
      (neq, "$g_player_constable", -1),
      (neq, "$g_player_constable", "trp_dplmc_constable"),
      (assign, ":notification", 1),
    (try_end),
    
    (try_begin),
      (eq, ":notification", 1),
      (call_script, "script_add_notification_menu", "mnu_dplmc_notification_appoint_constable", 0, 0),
    (try_end),
    ]
   ),
   
  # Appoint chancellor
   (24 , 0, 24 * 14, 
   [],
   [
   (assign, ":has_fief", 0),
    (try_for_range, ":center_no", walled_centers_begin, walled_centers_end),
      (party_get_slot,  ":lord_troop_id", ":center_no", slot_town_lord),
      (eq, ":lord_troop_id", "trp_player"),
      (assign, ":has_fief", 1),
    (try_end),
    (eq, ":has_fief", 1),
    
    (try_begin), #debug
      (eq, "$cheat_mode", 1),
      (assign, reg0, "$g_player_chancellor"),
      (display_message, "@{!}DEBUG : chancellor: {reg0}"),
    (try_end),

    (assign, ":notification", 0),
    (try_begin),
      (eq, "$g_player_chancellor", 0),
      (assign, ":notification", 1),
    (else_try),
      (neq, "$g_player_chancellor", -1),
      (neq, "$g_player_chancellor", "trp_dplmc_chancellor"),
      (assign, ":notification", 1),
    (try_end),
    
    (try_begin),
      (eq, ":notification", 1),
      (call_script, "script_add_notification_menu", "mnu_dplmc_notification_appoint_chancellor", 0, 0),
    (try_end),
    ]),
  
##diplomacy end


#======special item end====== 
 
  (0.0, 0, 24.0 * 30, [],
  [    
        (try_for_range, ":town_no", towns_begin, towns_end),
           (party_get_slot, ":chest_troop", ":town_no", slot_town_seneschal),
           (store_troop_gold, ":gold", ":chest_troop"),
           (gt, ":gold", 0),
           (call_script, "script_get_bank_rates", ":town_no"),
           (assign, ":rate", reg0),
           (val_mul, ":gold", ":rate"),
           (val_div, ":gold", 10000),
           (troop_add_gold, ":chest_troop", ":gold"),
        (try_end),
        
        (try_for_range, ":town_no", towns_begin, towns_end),
           (party_get_slot, ":player_debt", ":town_no", slot_town_player_debt),
           (gt, ":player_debt", 0),
           (call_script, "script_get_bank_rates", ":town_no"),
           (assign, ":rate", reg1),
           (val_add, ":rate", 10000),
           (val_mul, ":player_debt", ":rate"),
           (val_div, ":player_debt", 10000),
           (party_set_slot, ":town_no", slot_town_player_debt, ":player_debt"),
        (try_end),
        
        (display_message, "@Bank Report", 0xFFAAFFAA),
        
  ]),
 
  (0, 0, 24,
   [],
[
        (try_for_range, ":town_no", towns_begin, towns_end),
           (party_get_slot, ":player_debt", ":town_no", slot_town_player_debt),
           (gt, ":player_debt", 0),
           (party_get_slot, ":player_debt_days", ":town_no", slot_town_player_debt_days),
           (val_add, ":player_debt_days", 1),
           (party_set_slot, ":town_no", slot_town_player_debt_days, ":player_debt_days"),
           
           (try_begin),
             (ge,":player_debt_days", 38),
             (str_store_party_name_link, s14, ":town_no"),
             (display_message, "@Bank Report: You have not returned the monies due in time, so the bankers in {s14} have decided to collect by force", 0xFFAAFFAA),
           (else_try),
             (gt,":player_debt_days", 31),
             (str_store_party_name_link, s14, ":town_no"),
             (display_message, "@Bank Report: Your loan in {s14} has expired ", 0xFFAAFFAA),
           (else_try),
             (eq,":player_debt_days", 31),
             (party_get_slot, ":player_debt", ":town_no", slot_town_player_debt),
             (gt, ":player_debt", 0),
             (call_script, "script_get_loan_rate", ":town_no"),
             (assign, ":rate", reg0),
             (val_add, ":rate", 10000),
             (val_mul, ":player_debt", ":rate"),
             (val_div, ":player_debt", 10000),
             (party_set_slot, ":town_no", slot_town_player_debt, ":player_debt"),
             (str_store_party_name_link, s14, ":town_no"),
             (display_message, "@Bank Report: Your loan in {s14} has expired ", 0xFFAAFFAA),
           (try_end),
           
           (try_begin),
             (gt,":player_debt_days", 38),
             (val_sub,":player_debt_days", 38),
             (val_mod,":player_debt_days", 7),
             (eq,":player_debt_days", 0),
             (troop_get_slot, ":renown_sub", "trp_player", slot_troop_renown),
             (val_mul,":renown_sub", -1),
             (val_div,":renown_sub", 20),
             (call_script, "script_change_player_honor", -5),
             (call_script, "script_change_troop_renown", "trp_player", ":renown_sub"),
             (display_message, "@Your current action is disgraceful.", 0xFF0000),
           (try_end),
        (try_end),
  ]),
  
        #(try_begin),
          #(party_slot_ge, "$current_town", slot_town_player_debt_days, 38),
          #(jump_to_menu, "mnu_ms_credit_fight"),
        #(try_end),
  
#+freelancer start

#  CHECKS IF "$enlisted_party" IS DEFEATED

    (0.0, 0, 0, [
        (eq, "$freelancer_state", 1),
        (gt, "$enlisted_party", 0),
        (neg|party_is_active, "$enlisted_party"),
    ],
    [
        (assign, "$freelancer_state", 0),
        (call_script, "script_freelancer_detach_party"),

        #removes faction relation given at enlist
        (store_troop_faction, ":commander_faction", "$enlisted_lord"),
        (try_for_range, ":cur_faction", kingdoms_begin, kingdoms_end),
            (neq, ":commander_faction", ":cur_faction"),
            (faction_slot_eq, ":cur_faction", slot_faction_state, sfs_active),
            (call_script, "script_set_player_relation_with_faction", ":cur_faction", 0),
        (try_end),

        (assign, "$g_encountered_party", "$g_enemy_party"),
        #(assign, "$g_next_menu", "mnu_captivity_start_wilderness"),
        #(jump_to_menu, "mnu_total_defeat"),
        (jump_to_menu, "mnu_captivity_start_wilderness"),
    ]),


 #  CHECKS IF "$enlisted_party" HAS JOINED BATTLE

    (0.0, 0, 0, [
        (eq, "$freelancer_state", 1),
        (party_get_battle_opponent, ":commander_opponent", "$enlisted_party"),
        (gt, ":commander_opponent", 0),
        #(troop_set_health,"trp_player",100),
        (store_troop_health, ":player_health", "trp_player"),
        #checks that the player's health is high enough to join battle
        (ge, ":player_health", 50),
        (store_faction_of_party,":fac1", ":commander_opponent"),
        (store_faction_of_party,":fac2", "$enlisted_party"),
        (store_relation, ":rel", ":fac1", ":fac2"),
        (lt, ":rel", 0),
    ],
    [
        #(try_begin),
            #(neg|troop_is_guarantee_horse, "$player_cur_troop"), 
            #(troop_get_inventory_slot, ":horse", "trp_player", ek_horse),
            #(gt, ":horse", 0),
            #(troop_get_inventory_slot_modifier, ":horse_imod", "trp_player", ek_horse),
            #(troop_add_item, "trp_player", ":horse", ":horse_imod"),
            #(troop_set_inventory_slot, "trp_player", ek_horse, -1),
        #(try_end),
        (jump_to_menu, "mnu_world_map_soldier"),
    ]),

#  CHECKS IF PLAYER WON THE REVOLT

    (1.0, 0, 0, [
        (eq, "$freelancer_state", 0),
        (gt, "$enlisted_party", 0),
        (neg|party_is_active, "$enlisted_party"),

        (store_faction_of_party, ":faction", "p_main_party"),
        (store_troop_faction, ":commander_faction", "$enlisted_lord"),
        (store_relation, ":relation", ":faction", ":commander_faction"),
        (lt, ":relation", 0),

        (party_get_attached_party_with_rank, ":attached_party", "p_main_party", 0),
        (eq, "p_temp_party_2", ":attached_party"),
    ],
    [
        (assign, "$enlisted_party", -1),
        (party_detach, "p_temp_party_2"),
        (store_skill_level, ":cur_leadership", "skl_leadership", "trp_player"),
        (store_skill_level, ":cur_persuasion", "skl_persuasion", "trp_player"),
        (store_add, ":chance", ":cur_persuasion", ":cur_leadership"),
        (val_add, ":chance", 10),
        (store_random_in_range, ":prisoner_state", 0, ":chance"),

        (try_begin),
            (is_between, ":prisoner_state", 0, 5),
            (call_script, "script_party_calculate_strength", "p_main_party", 0),
            (assign, ":main_strength", reg0),
            (call_script, "script_party_calculate_strength", "p_temp_party_2", 0),
            (assign, ":temp_strength", reg0),
            (ge, ":temp_strength", ":main_strength"),

            (party_get_num_prisoner_stacks, ":num_stacks", "p_temp_party_2"),
            (try_for_range, ":cur_stack", 0, ":num_stacks"),
                (party_prisoner_stack_get_troop_id, ":cur_troops", "p_temp_party_2", ":cur_stack"),
                (party_prisoner_stack_get_size, ":cur_size", "p_temp_party_2", ":cur_stack"),
                (party_remove_prisoners, "p_temp_party_2", ":cur_troops", ":cur_size"),
            (try_end),

            (tutorial_box, "@The released prisoners were not be trusted and they are preparing to attack you!", "@Warning!"),
            (start_encounter, "p_temp_party_2"),
            (change_screen_map),
        (else_try),
            (is_between, ":prisoner_state", 5, 10),
            (tutorial_box, "@The released prisoners scattered as soon as the battle finished. You will not be seeing them again.", "@Notice!"),
            (party_clear, "p_temp_party_2"),
        (else_try),
            (tutorial_box, "@The released prisoners have remained loyal and will join your party", "@Notice!"),
            (party_get_num_companion_stacks, ":num_stacks", "p_temp_party_2"),
            (try_for_range, ":cur_stack", 0, ":num_stacks"),
                (party_stack_get_troop_id, ":cur_troops", "p_temp_party_2", ":cur_stack"),
                (party_stack_get_size, ":cur_size", "p_temp_party_2", ":cur_stack"),
                (party_add_members, "p_main_party", ":cur_troops", ":cur_size"),
            (try_end),
            (party_clear, "p_temp_party_2"),
        (try_end),
    ]),

# IF LEFT MOUSE CLICK GO TO SOLDIER'S MENU

    (0.0, 0, 0, [
        (eq, "$freelancer_state", 1),
        (key_clicked, key_left_mouse_button),

        (set_fixed_point_multiplier, 1000),
        (mouse_get_position, pos0),
        (position_get_y, ":y", pos0),
        (gt, ":y", 50), #allows the camp, reports, quests, etc. buttons to be clicked
    ],
    [
        (jump_to_menu, "mnu_world_map_soldier"),
        (rest_for_hours_interactive, 9999, 4, 0),
    ]),

   (24.0, 0, 0, [
        (eq, "$freelancer_state", 2),
    ],
    [
        (troop_get_slot, ":days_left", "trp_player", slot_troop_days_on_mission),
        (try_begin),
          (gt, ":days_left", 5),
          (val_sub, ":days_left", 1),
          (troop_set_slot, "trp_player", slot_troop_days_on_mission, ":days_left"),
        (else_try),          
          (is_between, ":days_left", 1, 5),
          (assign, reg0, ":days_left"),
          (display_message, "@You have {reg0} days left till you are declared as a deserter!"),
          (val_sub, ":days_left", 1),
          (troop_set_slot, "trp_player", slot_troop_days_on_mission, ":days_left"),
        (else_try), #declare deserter
          (eq, ":days_left", 0),
          (call_script, "script_event_player_deserts"),
          (display_message, "@You have now been declared as a deserter!"),
        (try_end),  
    ]),

#+freelancer end
 
(0.0, 0, ti_once, [], []),

     (1, 0, 0, [(party_slot_eq,"p_main_party", slot_party_is_daytime, 1),
                 (store_time_of_day,":time"),(gt,":time", 18)],
                [(display_message, "@The sun sets",0xFFDFE65B), 
                 (party_set_slot,"p_main_party", slot_party_is_daytime, 0),
                 (play_sound,"snd_end_day"),  
                 (call_script, "script_spawn_random_bank", 1),
                 (try_begin),
                   (this_or_next|player_has_item, "itm_zamorak"),
                   (troop_has_item_equipped,"trp_player","itm_zamorak"),
                   (store_random_in_range, ":ran", 0, 5),
                   (try_begin),
                     (eq,":ran",0),
                     (troop_join,"trp_demon_5", 0),
                   (else_try),  
                     (eq,":ran",1),
                     (troop_join,"trp_demon_6", 0),
                   (else_try),  
                     (troop_join,"trp_huge_inferno", 0),
                   (try_end),  
                 (try_end),
                 ]),                 
#change to day routine
     (1, 0, 0, [(party_slot_eq,"p_main_party", slot_party_is_daytime, 0),
                 (store_time_of_day,":time"),(is_between,":time", 5,19),
                ],
                [(display_message, "@The sun rises",0xFFDFE65B),
                 (party_set_slot,"p_main_party", slot_party_is_daytime, 1),
                 (call_script, "script_spawn_random_lair", 1),
                 (call_script, "script_refresh_center_merchant_gold"),
                 (play_sound,"snd_new_day"),  
                 (try_begin),
                   (this_or_next|player_has_item, "itm_angelic_alliance"),
                   (troop_has_item_equipped,"trp_player","itm_angelic_alliance"),
                   (store_random_in_range, ":ran", 0, 3),
                   (try_begin),
                     (eq,":ran",0),
                     (troop_join,"trp_archangle", 0),
                   (else_try),  
                     (troop_join,"trp_angle", 0),
                   (try_end),  
                 (try_end),
                 (try_begin),
                   (this_or_next|player_has_item, "itm_calibur"),
                   (troop_has_item_equipped,"trp_player","itm_calibur"),
                   (store_random_in_range, ":ran", 0, 4),
                   (try_begin),
                     (eq,":ran",3),
                     (troop_join,"trp_england_knight_4", 0),
                   (else_try),  
                     (eq,":ran",2),
                     (troop_join,"trp_england_knight_3", 0),
                   (else_try),  
                     (troop_join,"trp_england_knight_2", 0),
                   (try_end),  
                 (try_end),
                 ]),      
                 
#**************************************************
(18,0,18,
  [
      (map_free),
      (party_is_active,"p_main_party"),
      (neg|eq,"$g_player_is_captive",1),
      (store_random_in_range,":random",0,100),
      (ge,":random",50),
  ],
  [
    (try_begin),#event1
      (store_random_in_range,":rand",0,19),
      (try_begin),
        (eq, ":rand", 0),
        (try_begin),#
          (store_skill_level,":local_11","skl_leadership","trp_player"),
          (ge,":local_11",3),
          (store_random_in_range,":local_71",3,6),
          (val_add,":local_11",":local_71"),
          (store_random_in_range,":local_12",0,15),
          (ge,":local_11",":local_12"),
          (store_random_in_range,":local_72",100,300),
          (assign,reg0,":local_72"),
          (dialog_box,"@soldier_give_money_1 {reg0}", "@Lazy soldiers"),
          (play_sound,"snd_lair_keep"),
          (troop_add_gold,"trp_player",reg0),
        (try_end),
      (else_try),
        (eq, ":rand", 1),
        (try_begin),#
          (party_get_num_companion_stacks,":local_13","p_main_party"),
          (assign,":local_201",0),
          (try_for_range,":local_14",1,":local_13"),
            (party_stack_get_troop_id,":local_15","p_main_party",":local_14"),
            (try_begin),
              (troop_is_hero,":local_15"),
            (else_try),
              (val_add,":local_201",1),
            (try_end),
          (try_end),
          (gt,":local_201",0),
          (store_random_in_range,":local_202",0,":local_201"),
          (assign,":local_203",0),
          (try_for_range,":local_14",1,":local_13"),
            (party_stack_get_troop_id,":local_15","p_main_party",":local_14"),
            (try_begin),
              (troop_is_hero,":local_15"),
            (else_try),
              (try_begin),
            (eq,":local_202",":local_203"),
            (str_store_troop_name,1,":local_15"),
            (party_remove_members,"p_main_party",":local_15",1),
            (dialog_box,"@soldier_give_money_2", "@Lazy soldiers"),
            (assign,":local_203",999999),
            (play_sound,"snd_lair_keep"),
              (else_try),
            (val_add,":local_203",1),
              (try_end),
            (try_end),
          (try_end),
        (try_end),
      (else_try),
        (this_or_next|eq, ":rand", 12),
        (eq, ":rand", 2),
        (try_begin),#add_morale
          (party_get_num_companions,":local_1","p_main_party"),
          (ge,":local_1",2),
          (store_random_in_range,":ran2",0,7),
          (try_begin),
            (eq,":ran2",0),
            (dialog_box,"@monastery_add_morale", "@Improve morale"),
          (else_try),
            (eq,":ran2",1),
            (dialog_box,"@monastery_add_morale1", "@Improve morale"),
          (else_try),
            (eq,":ran2",2),
            (dialog_box,"@monastery_add_morale2", "@Improve morale"),
          (else_try),
            (eq,":ran2",3),
            (dialog_box,"@monastery_add_morale3", "@Improve morale"),
          (else_try),
            (eq,":ran2",4),
            (dialog_box,"@monastery_add_morale4", "@Improve morale"),
          (else_try),
            (eq,":ran2",5),
            (dialog_box,"@monastery_add_morale5", "@Improve morale"),
          (else_try),
            (eq,":ran2",6),
            (dialog_box,"@monastery_add_morale6", "@Improve morale"),
          (try_end),
          (play_sound,"snd_good_moral"),
          (call_script,"script_change_player_party_morale",50),
        (try_end),
      (else_try),
        (eq, ":rand", 3),
        (try_begin),#posion_water
          (store_random_in_range,":random",0,100),
          (ge,":random",50),
          (party_get_num_companions,":local_1","p_main_party"),
          (ge,":local_1",30),
          (dialog_box,"@posion_water", "@Unknown spring"),
          (play_sound,"snd_quest_failed"),
          (call_script, "script_party_wound_all_members", "p_main_party"),
        (try_end),
      (else_try),
        (eq, ":rand", 4),
        (try_begin),#Fountain of Youth_add_morale
          (store_random_in_range,":random",0,100),
          (ge,":random",50),
          (party_get_num_companions,":local_1","p_main_party"),
          (ge,":local_1",30),
          (dialog_box,"@Fountain of Youth_add_morale", "@Unknown spring"),
          (heal_party, "p_main_party"),
          (play_sound,"snd_regeneration"),
          (call_script,"script_change_player_party_morale",100),
        (try_end),
      (else_try),
        (this_or_next|eq, ":rand", 13),
        (eq, ":rand", 5),
        (try_begin),#low_morale
          (party_get_num_companions,":local_1","p_main_party"),
          (ge,":local_1",2),
          (store_random_in_range,":ran2",0,6),
          (try_begin),
            (eq,":ran2",0),
            (dialog_box,"@low_morale", "@Morale drop"),
          (else_try),
            (eq,":ran2",1),
            (dialog_box,"@low_morale1", "@Morale drop"),
          (else_try),
            (eq,":ran2",2),
            (dialog_box,"@low_morale2", "@Morale drop"),
          (else_try),
            (eq,":ran2",3),
            (dialog_box,"@low_morale3", "@Morale drop"),
          (else_try),
            (eq,":ran2",4),
            (dialog_box,"@low_morale4", "@Morale drop"),
          (else_try),
            (eq,":ran2",5),
            (dialog_box,"@low_morale5", "@Morale drop"),
          (try_end),
          (play_sound,"snd_quest_failed"),
          (call_script,"script_change_player_party_morale",-30),
        (try_end),
      (else_try),
        (this_or_next|eq, ":rand", 14),
        (eq, ":rand", 6),
        (try_begin),#add_exp
          (neg|is_currently_night),
          (store_random_in_range,":ran2",0,6),
          (try_begin),
            (eq,":ran2",0),
            (dialog_box,"@Learning Stone", "@Gain experience"),
          (else_try),
            (eq,":ran2",1),
            (dialog_box,"@Learning Stone1", "@Gain experience"),
          (else_try),
            (eq,":ran2",2),
            (dialog_box,"@Learning Stone2", "@Gain experience"),
          (else_try),
            (eq,":ran2",3),
            (dialog_box,"@Learning Stone3", "@Gain experience"),
          (else_try),
            (eq,":ran2",4),
            (dialog_box,"@Learning Stone4", "@Gain experience"),
          (else_try),
            (eq,":ran2",5),
            (dialog_box,"@Learning Stone5", "@Gain experience"),
          (else_try),
            (eq,":ran2",6),
            (dialog_box,"@Learning Stone6", "@Gain experience"),
          (try_end),
      
          (heal_party, "p_main_party"),
          (store_random_in_range,":local_1",1,7),
          (val_mul,":local_1",500),
          (party_add_xp, "p_main_party", ":local_1"),
          (play_sound,"snd_add_exp"),
        (try_end),
      (else_try),
        (eq, ":rand", 7),
        (try_begin),#horse
          (troop_ensure_inventory_space, "trp_player", 2),
          (store_troop_gold,":local_2","trp_player"),
          (ge,":local_2",1000),
          (party_get_num_companions,":local_1","p_main_party"),
          (ge,":local_1",3),
          (store_random_in_range,":random",0,100),
          (ge,":random",80),
          (store_random_horse,":local_4"),
          (str_store_item_name,s4,":local_4"),
          (dialog_box,"@Stables buy horse {s4}"),
          (troop_add_item,"trp_player",":local_4"),
          (troop_remove_gold,"trp_player",1000),
          (play_sound,"snd_lair_nomad"),
        (try_end),
      (else_try),
        (this_or_next|eq, ":rand", 15),
        (eq, ":rand", 8),
        (try_begin),#Give_pork
          (troop_ensure_inventory_space, "trp_player", 2),
          (party_get_num_companions,":local_1","p_main_party"),
          (ge,":local_1",10),
          (dialog_box,"@Give_pork","@Unexpected harvest"),
          (store_random_in_range,":random",0,100),
          (try_begin),
            (ge,":random",94),
            (troop_add_item,"trp_player","itm_boar_mount_charge"),
          (else_try),
            (troop_add_item,"trp_player","itm_pork"),
          (try_end),  
          (play_sound,"snd_distant_dog_bark"),
        (try_end),
      (else_try),
        (this_or_next|eq, ":rand", 16),
        (eq, ":rand", 9),
        (try_begin),#give_grapes
          (troop_ensure_inventory_space, "trp_player", 2),
          (party_get_num_companions,":local_1","p_main_party"),
          (ge,":local_1",1),
          (dialog_box,"@give_grapes","@Unexpected harvest"),
          (troop_add_item,"trp_player","itm_raw_grapes"),
          (play_sound,"snd_distant_dog_bark"),
        (try_end),
      (else_try),
        (this_or_next|eq, ":rand", 17),
        (eq, ":rand", 10),
        (try_begin),#give_chicken
          (troop_ensure_inventory_space, "trp_player", 2),
          (party_get_num_companions,":local_1","p_main_party"),
          (ge,":local_1",3),
          (dialog_box,"@give_chicken","@Unexpected harvest"),
          (troop_add_item,"trp_player","itm_chicken"),
          (play_sound,"snd_distant_chicken"),
        (try_end),
      (else_try),
        (this_or_next|eq, ":rand", 18),
        (eq, ":rand", 11),
        (try_begin),#give_chicken
          (troop_ensure_inventory_space, "trp_player", 2),
          (gt,"$player_honor",0),
          (store_random_in_range,":random",0,100),
          (ge,":random",92),
          (dialog_box,"@Farmer_give_apple","@Unexpected harvest"),
          (troop_add_item,"trp_player","itm_apples"),
          (play_sound,"snd_distant_dog_bark"),
        (try_end),
      (try_end),
    (try_end),
  
  ]),

(24,0,12,
  [
      (map_free),
      (party_is_active,"p_main_party"),
      (neg|eq,"$g_player_is_captive",1),
      (troop_ensure_inventory_space, "trp_player", 2),
      (store_random_in_range,":random",0,100),
      (ge,":random",60),
  ],
  [
    (try_begin),#event2
      (store_random_in_range,":rand",0,19),
      (try_begin),
        (this_or_next|eq, ":rand", 11),
        (eq, ":rand", 0),
        (try_begin),#wolf
          (party_get_num_companions,":local_1","p_main_party"),
          (ge,":local_1",3),
          (store_skill_level,":local_2","skl_tracking","trp_player"),
          (ge,":local_2",3),
          (store_random_in_range,":local_4","itm_robe","itm_janissary_vest"),
          (dialog_box,"@Wolf_give_cloth","@Unexpected harvest"),
          (troop_add_item,"trp_player",":local_4"),
          (store_random_in_range,":local_5",0,2),
          (eq,":local_5",1),
          (store_random_in_range,":local_6","itm_mail_coif","itm_wooden_stick"),
          (troop_add_item,"trp_player",":local_6"),
          (play_sound,"snd_end_day"),
        (try_end),
      (else_try),
        (this_or_next|eq, ":rand", 12),
        (eq, ":rand", 1),
        (try_begin),#tomb

          (party_get_num_companions,":local_1","p_main_party"),
          (le,":local_1",3),
             (store_random_in_range, ":rand_1", 0,5),
             (try_begin),
               (eq,":rand_1", 0),
               (troop_add_merchandise, "trp_player", itp_type_one_handed_wpn, 1),          
             (else_try),
               (eq,":rand_1", 1),
               (troop_add_merchandise, "trp_player", itp_type_two_handed_wpn, 1),          
             (else_try),
               (eq,":rand_1", 2),
               (troop_add_merchandise, "trp_player", itp_type_polearm, 1),          
             (else_try),
               (eq,":rand_1", 3),
               (troop_add_merchandise, "trp_player", itp_type_shield, 1),          
             (else_try),
               (troop_add_merchandise, "trp_player", itp_type_one_handed_wpn, 1),          
             (try_end),
          (dialog_box,"@tomb_add_weapon","@Unexpected harvest"),
          (play_sound,"snd_lair_undead"),
        (try_end),
      (else_try),
        (eq, ":rand", 2),
        (try_begin),#add_shield

          (party_get_num_companions,":local_1","p_main_party"),
          (le,":local_1",30),
          (store_random_in_range,":ran2",0,5),
          (try_begin),
            (eq,":ran2",0),
            (dialog_box,"@add_shield","@Get the shield"),
            (set_merchandise_modifier_quality, 250),
          (else_try),
            (eq,":ran2",1),
            (dialog_box,"@add_shield1","@Get the shield"),
            (set_merchandise_modifier_quality, 100),
          (else_try),
            (eq,":ran2",2),
            (dialog_box,"@add_shield2","@Get the shield"),
            (set_merchandise_modifier_quality, 300),
          (else_try),
            (eq,":ran2",3),
            (dialog_box,"@add_shield3","@Get the shield"),
            (set_merchandise_modifier_quality, 200),
          (else_try),
            (eq,":ran2",4),
            (dialog_box,"@add_shield4","@Get the shield"),
            (set_merchandise_modifier_quality, 150),
          (try_end),
          (troop_add_merchandise, "trp_player", itp_type_shield, 1),          
          (play_sound,"snd_chest"),
        (try_end),
      (else_try),
        (eq, ":rand", 3),
        (try_begin),#add_body_armor

          (party_get_num_companions,":local_1","p_main_party"),
          (le,":local_1",30),
          
          (store_random_in_range,":ran2",0,5),
          (try_begin),
            (eq,":ran2",0),
            (dialog_box,"@add_body_armor","@Get the armor"),
            (set_merchandise_modifier_quality, 100),
          (else_try),
            (eq,":ran2",1),
            (dialog_box,"@add_body_armor1","@Get the armor"),
            (set_merchandise_modifier_quality, 150),
          (else_try),
            (eq,":ran2",2),
            (dialog_box,"@add_body_armor2","@Get the armor"),
            (set_merchandise_modifier_quality, 200),
          (else_try),
            (eq,":ran2",3),
            (dialog_box,"@add_body_armor3","@Get the armor"),
            (set_merchandise_modifier_quality, 250),
          (else_try),
            (eq,":ran2",4),
            (dialog_box,"@add_body_armor4","@Get the armor"),
            (set_merchandise_modifier_quality, 300),
          (try_end),
          (troop_add_merchandise, "trp_player", itp_type_body_armor, 1),         
          (play_sound,"snd_chest"),
        (try_end),
      (else_try),
        (eq, ":rand", 4),
        (try_begin),#add_bow

          (party_get_num_companions,":local_1","p_main_party"),
          (le,":local_1",30),
          
          (store_random_in_range,":ran2",0,5),
          (try_begin),
            (eq,":ran2",0),
            (dialog_box,"@add_bow","@Get the bow"),
            (set_merchandise_modifier_quality, 100),
          (else_try),
            (eq,":ran2",1),
            (dialog_box,"@add_bow1","@Get the bow"),
            (set_merchandise_modifier_quality, 150),
          (else_try),
            (eq,":ran2",2),
            (dialog_box,"@add_bow2","@Get the bow"),
            (set_merchandise_modifier_quality, 200),
          (else_try),
            (eq,":ran2",3),
            (dialog_box,"@add_bow3","@Get the bow"),
            (set_merchandise_modifier_quality, 250),
          (else_try),
            (eq,":ran2",4),
            (dialog_box,"@add_bow4","@Get the bow"),
            (set_merchandise_modifier_quality, 300),
          (try_end),
          (troop_add_merchandise, "trp_player", itp_type_bow, 1),          
          (play_sound,"snd_chest"),
        (try_end),
      (else_try),
        (eq, ":rand", 5),
        (try_begin),#staff

          (party_get_num_companions,":local_1","p_main_party"),
          (le,":local_1",30),
          
          (store_random_in_range,":ran2",0,5),
          (try_begin),
            (eq,":ran2",0),
            (dialog_box,"@add_skull_staff","@Get the staff"),
            (troop_add_item,"trp_player","itm_skull_staff"),
          (else_try),
            (eq,":ran2",1),
            (dialog_box,"@add_sorcerer_staff","@Get the staff"),
            (troop_add_item,"trp_player","itm_sorcerer_staff_1"),
          (else_try),
            (eq,":ran2",2),
            (dialog_box,"@add_mummy_staff","@Get the staff"),
            (troop_add_item,"trp_player","itm_lich_staff_1"),
          (else_try),
            (eq,":ran2",3),
            (dialog_box,"@add_bishop_staff","@Get the staff"),
            (troop_add_item,"trp_player","itm_bishop_staff"),
          (else_try),
            (eq,":ran2",4),
            (dialog_box,"@add_magic_staff","@Get the staff"),
            (troop_add_item,"trp_player","itm_mage_staff_1"),
          (try_end),
          (play_sound,"snd_chest"),
        (try_end),
      (else_try),
        (eq, ":rand", 6),
        (try_begin),#book
          (neg|map_free),
          (party_get_num_companions,":local_1","p_main_party"),
          (ge,":local_1",10),
          
          (store_random_in_range,":ran2",0,8),
          (try_begin),
            (eq,":ran2",0),
            (dialog_box,"@add_book_tactics","@Get the book"),
            (troop_add_item,"trp_player","itm_book_tactics"),
          (else_try),
            (eq,":ran2",1),
            (dialog_box,"@add_book_persuasion","@Get the book"),
            (troop_add_item,"trp_player","itm_book_persuasion"),
          (else_try),
            (eq,":ran2",2),
            (dialog_box,"@add_book_leadership","@Get the book"),
            (troop_add_item,"trp_player","itm_book_leadership"),
          (else_try),
            (eq,":ran2",3),
            (dialog_box,"@add_book_intelligence","@Get the book"),
            (troop_add_item,"trp_player","itm_book_intelligence"),
          (else_try),
            (eq,":ran2",4),
            (dialog_box,"@add_book_trade","@Get the book"),
            (troop_add_item,"trp_player","itm_book_trade"),
          (else_try),
            (eq,":ran2",5),
            (dialog_box,"@add_book_weapon_mastery","@Get the book"),
            (troop_add_item,"trp_player","itm_book_weapon_mastery"),
          (else_try),
            (eq,":ran2",6),
            (dialog_box,"@add_book_engineering","@Get the book"),
            (troop_add_item,"trp_player","itm_book_engineering"),
          (else_try),
            (eq,":ran2",7),
            (dialog_box,"@add_book_prisoner_management","@Get the book"),
            (troop_add_item,"trp_player","itm_book_prisoner_management"),
          (try_end),
          (play_sound,"snd_chest"),
        (try_end),
      (else_try),
        (eq, ":rand", 7),
        (try_begin),#horse

          (store_troop_gold,":local_2","trp_player"),
          (ge,":local_2",1000),
          (party_get_num_companions,":local_1","p_main_party"),
          (ge,":local_1",3),
          (store_random_in_range,":random",0,100),
          (ge,":random",80),
          (store_random_horse,":local_4"),
          (str_store_item_name,s4,":local_4"),
          (dialog_box,"@Stables buy horse {s4}"),
          (troop_add_item,"trp_player",":local_4"),
          (troop_remove_gold,"trp_player",1000),
          (play_sound,"snd_lair_nomad"),
        (try_end),
      (else_try),
        (eq, ":rand", 8),
        (try_begin),#Treasure Chest

          (store_skill_level,":local_2","skl_looting","trp_player"),
          (ge,":local_2",6),
          (store_random_in_range,":ran2",0,7),
          (try_begin),
            (eq,":ran2",0),
            (dialog_box,"@Treasure Chest","@Get the treasure"),
          (else_try),
            (eq,":ran2",1),
            (dialog_box,"@Treasure Chest1","@Get the treasure"),
          (else_try),
            (eq,":ran2",2),
            (dialog_box,"@Treasure Chest2","@Get the treasure"),
          (else_try),
            (eq,":ran2",3),
            (dialog_box,"@Treasure Chest3","@Get the treasure"),
          (else_try),
            (eq,":ran2",4),
            (dialog_box,"@Treasure Chest4","@Get the treasure"),
          (else_try),
            (eq,":ran2",5),
            (dialog_box,"@Treasure Chest5","@Get the treasure"),
          (else_try),
            (eq,":ran2",6),
            (dialog_box,"@Treasure Chest6","@Get the treasure"),
          (try_end),
          (play_sound,"snd_trophy_get"),
          (troop_add_item,"trp_player","itm_trophy_c"),
        (try_end),
      (else_try),
        (this_or_next|eq, ":rand", 10),
        (eq, ":rand", 9),
        (try_begin),#wargon_give_goods

          (party_get_num_companions,":local_1","p_main_party"),
          (ge,":local_1",5),
          (store_skill_level,":local_2","skl_looting","trp_player"),
          (ge,":local_2",1),
          (store_random_in_range,":local_4","itm_spice","itm_smoked_fish"),
          (dialog_box,"@wargon_give_goods","@Unexpected harvest"),
          (play_sound,"snd_chest"),
          (troop_add_item,"trp_player",":local_4"),
          (store_random_in_range,":local_5",0,2),
          (eq,":local_5",1),
          (store_random_in_range,":local_6","itm_spice","itm_smoked_fish"),
          (troop_add_item,"trp_player",":local_6"),
        (try_end),
      (else_try),
        (this_or_next|eq, ":rand", 13),
        (eq, ":rand", 14),
        (try_begin),#gice_scroll

          (store_skill_level,":local_2","skl_magic_power","trp_player"),
          (ge,":local_2",2),
          
          (store_random_in_range,":scroll","itm_magic_summon_undead","itm_magic_meteor_shower_dummy"),
          (str_store_item_name,s4,":scroll"),
          (store_random_in_range,":ran2",0,5),
          (try_begin),
            (eq,":ran2",0),
            (dialog_box,"@gice_scroll{s4}","@Unexpected harvest"),
          (else_try),
            (eq,":ran2",1),
            (dialog_box,"@gice_scroll{s4}1","@Unexpected harvest"),
          (else_try),
            (eq,":ran2",2),
            (dialog_box,"@gice_scroll{s4}2","@Unexpected harvest"),
          (else_try),
            (eq,":ran2",3),
            (dialog_box,"@gice_scroll{s4}3","@Unexpected harvest"),
          (else_try),
            (eq,":ran2",4),
            (dialog_box,"@gice_scroll{s4}4","@Unexpected harvest"),
          (try_end),
          (troop_add_item,"trp_player",":scroll"),
          (play_sound,"snd_quest_taken"),
        (try_end),
      (else_try),
        (this_or_next|eq, ":rand", 15),
        (this_or_next|eq, ":rand", 16),
        (this_or_next|eq, ":rand", 17),
        (eq, ":rand", 18),
        (try_begin),#gold_bar
          (store_random_in_range,":ran2",0,7),
          (try_begin),
            (eq,":ran2",0),
            (dialog_box,"@God_give_gold"),
          (else_try),
            (eq,":ran2",1),
            (dialog_box,"@God_give_gold1"),
          (else_try),
            (eq,":ran2",2),
            (dialog_box,"@God_give_gold2"),
          (else_try),
            (eq,":ran2",3),
            (dialog_box,"@God_give_gold3"),
          (else_try),
            (eq,":ran2",4),
            (dialog_box,"@God_give_gold4"),
          (else_try),
            (eq,":ran2",5),
            (dialog_box,"@God_give_gold5"),
          (else_try),
            (eq,":ran2",6),
            (dialog_box,"@God_give_gold6"),
          (try_end),
          (play_sound,"snd_chest"),
          (troop_add_item,"trp_player","itm_trophy_a"),
        (try_end),
      (try_end),
    (try_end),
  ]),

(12,0,24,
  [
      (map_free),
      (party_is_active,"p_main_party"),
      (neg|eq,"$g_player_is_captive",1),
      (store_random_in_range,":random",0,100),
      (ge,":random",50),
  ],
  [
    (try_begin),#event3
      (map_free),
      (troop_get_slot,":renown","trp_player",slot_troop_renown),
      (store_random_in_range,":rand",0,12),
      (try_begin),
        (eq, ":rand", 0),
        (try_begin),
          (store_random_in_range,":local_1",300,500),
          (assign,reg0,":local_1"),
          (val_add,reg0,100),
          (store_random_in_range,":ran2",0,7),
          (try_begin),
            (eq,":ran2",0),
            (dialog_box,"@Campfire_give_money {reg0}","@Unexpected harvest"),
          (else_try),
            (eq,":ran2",1),
            (dialog_box,"@Campfire_give_money {reg0}1","@Unexpected harvest"),
          (else_try),
            (eq,":ran2",2),
            (dialog_box,"@Campfire_give_money {reg0}2","@Unexpected harvest"),
          (else_try),
            (eq,":ran2",3),
            (dialog_box,"@Campfire_give_money {reg0}3","@Unexpected harvest"),
          (else_try),
            (eq,":ran2",4),
            (dialog_box,"@Campfire_give_money {reg0}4","@Unexpected harvest"),
          (else_try),
            (eq,":ran2",5),
            (dialog_box,"@Campfire_give_money {reg0}5","@Unexpected harvest"),
          (else_try),
            (eq,":ran2",6),
            (dialog_box,"@Campfire_give_money {reg0}6","@Unexpected harvest"),
          (try_end),
          (play_sound,"snd_chest"),
          (troop_add_gold,"trp_player",reg0),
        (try_end),
      (else_try),
        (eq, ":rand", 1),
        (try_begin),#village_give_money
          (ge,":renown",500),
          (store_random_in_range,":random",0,100),
          (ge,":random",70),
          (store_random_in_range,":local_1",0,200),
          (assign,reg0,":renown"),
          (val_div,reg0,10),
          (val_add,reg0,":local_1"),
          (val_add,reg0,100),
          (store_random_in_range,":ran2",0,7),
          (try_begin),
            (eq,":ran2",0),
            (dialog_box,"@village_give_money {reg0}"),
          (else_try),
            (eq,":ran2",1),
            (dialog_box,"@village_give_money {reg0}1"),
          (else_try),
            (eq,":ran2",2),
            (dialog_box,"@village_give_money {reg0}2"),
          (else_try),
            (eq,":ran2",3),
            (dialog_box,"@village_give_money {reg0}3"),
          (else_try),
            (eq,":ran2",4),
            (dialog_box,"@village_give_money {reg0}4"),
          (else_try),
            (eq,":ran2",5),
            (dialog_box,"@village_give_money {reg0}5"),
          (else_try),
            (eq,":ran2",6),
            (dialog_box,"@village_give_money {reg0}6"),
          (try_end),
          (play_sound,"snd_chest"),
          (troop_add_gold,"trp_player",reg0),
        (try_end),
      (else_try),
        (eq, ":rand", 2),
        (try_begin),#man_give_money
          (ge,":renown",1000),
          (store_random_in_range,":random",0,100),
          (ge,":random",50),
          (store_random_in_range,":local_1",0,200),
          (store_random_in_range,":local_2",0,6),
          (try_begin),
            (eq,":local_2",0),
            (str_store_party_name,1,"p_town_1"),
          (else_try),
            (eq,":local_2",1),
            (str_store_party_name,1,"p_town_3"),
          (else_try),
            (eq,":local_2",2),
            (str_store_party_name,1,"p_town_11"),
          (else_try),
            (eq,":local_2",3),
            (str_store_party_name,1,"p_town_17"),
          (else_try),
            (eq,":local_2",4),
            (str_store_party_name,1,"p_town_23"),
          (else_try),
            (str_store_party_name,1,"p_town_19"),
          (try_end),
          (assign,reg0,":renown"),
          (val_div,reg0,2),
          (val_add,reg0,":local_1"),
          (val_add,reg0,200),
          (dialog_box,"@rich man_give_money {reg0}"),
          (play_sound,"snd_chest"),
          (troop_add_gold,"trp_player",reg0),
        (try_end),
      (else_try),
        (eq, ":rand", 3),
        (try_begin),#man_give_money
          (try_begin),
            (store_random_in_range,":local_51",0,60),
            (ge,30,":local_51"),
          (store_random_in_range,":ran2",0,7),
          (try_begin),
            (eq,":ran2",0),
            (dialog_box,"@fast_man_steal_money but failed","@Thief"),
          (else_try),
            (eq,":ran2",1),
            (dialog_box,"@fast_man_steal_money but failed1","@Be chivalrous"),
          (else_try),
            (eq,":ran2",2),
            (dialog_box,"@fast_man_steal_money but failed2","@Be chivalrous"),
          (else_try),
            (eq,":ran2",3),
            (dialog_box,"@fast_man_steal_money but failed3","@Be chivalrous"),
          (else_try),
            (eq,":ran2",4),
            (dialog_box,"@fast_man_steal_money but failed4","@Be chivalrous"),
          (else_try),
            (eq,":ran2",5),
            (dialog_box,"@fast_man_steal_money but failed5","@Be chivalrous"),
          (else_try),
            (eq,":ran2",6),
            (dialog_box,"@fast_man_steal_money but failed6","@Be chivalrous"),
          (try_end),
            
          (play_sound,"snd_quest_taken"),
            (call_script, "script_change_troop_renown", "trp_player", 5),
          (else_try),
            (store_random_in_range,":local_1",1,100),
            (val_mul,":local_1",100),
            (store_troop_gold,":local_2","trp_player"),
            (try_begin),
              (ge,":local_2",":local_1"),
              (assign,reg0,":local_1"),
              (dialog_box,"@fast_man_steal_money {reg0}","@Thief"),
              (play_sound,"snd_quest_failed"),
              (troop_remove_gold,"trp_player",reg0),
            (else_try),
              (ge,":local_2",50),
              (assign,reg0,":local_2"),
              (dialog_box,"@fast_man_steal_money {reg0}","@Thief"),
              (play_sound,"snd_quest_failed"),
              (troop_remove_gold,"trp_player",reg0),
            (try_end),
          (try_end),
        (try_end),
      (else_try),
        (eq, ":rand", 4),
        (try_begin),#Fountain of Youth_add_morale
          (store_random_in_range,":random",0,100),
          (ge,":random",70),
          (store_random_in_range,":loss",3,10),
          (gt,":renown",":loss"),
          (val_mul,":loss",-1),
          (dialog_box,"@a_man_who_hate_you"),
          (play_sound,"snd_quest_failed"),
          (call_script, "script_change_troop_renown", "trp_player", ":loss"),
        (try_end),
      (else_try),
        (eq, ":rand", 5),
        (try_begin),#low_morale
          (ge,":renown",800),
          (store_random_in_range,":random",0,100),
          (store_attribute_level,":local_11","trp_player",3),
          (ge,":random",80),
          (store_random_in_range,reg0,50,200),
          (val_mul,":local_11",5),
          (val_add,reg0,":local_11"),
          (dialog_box,"@a_man_who_love_you"),
          (play_sound,"snd_quest_taken"),
          (troop_add_gold,"trp_player",reg0),
        (try_end),
      (else_try),
        (eq, ":rand", 6),
        (try_begin),#add_exp
          (gt,"$player_honor",30),
          (gt,":renown",200),
          (store_random_in_range,":random",0,100),
          (ge,":random",50),
          (store_random_in_range,":local_11","fac_kingdom_1","fac_kingdoms_end"),
          (faction_get_slot, ":troop_id", ":local_11", slot_faction_tier_1_castle_troop),
          (store_relation,":local_13","fac_player_faction",":local_11"),
          (ge,":local_13",0),
          (str_store_troop_name,1,":troop_id"),
          (party_add_members,"p_main_party",":troop_id",1),
          (dialog_box,"@A_young_noble join you","@Volunteer join"),
          (play_sound,"snd_good_moral"),
          (store_random_in_range,reg0,100,200),
          (troop_add_gold,"trp_player",reg0),
        (try_end),
      (else_try),
        (eq, ":rand", 7),
        (try_begin),#horse
          (gt,":renown",100),
          (store_random_in_range,":random",0,100),
          (ge,":random",50),
          (store_random_in_range,":local_11","fac_kingdom_1","fac_kingdoms_end"),
          (faction_get_slot, ":troop_id", ":local_11", slot_faction_tier_1_town_troop),
          (store_relation,":local_13","fac_player_faction",":local_11"),
          (ge,":local_13",0),
          (str_store_troop_name,1,":troop_id"),
          (store_random_in_range,reg5,3,15),
          (party_add_members,"p_main_party",":troop_id",reg5),
          (play_sound,"snd_good_moral"),
          (dialog_box,"@A_town man_noble join you","@Volunteer join"),
        (try_end),
      (else_try),
        (eq, ":rand", 8),
        (try_begin),#Give_pork
          (party_get_num_companions,":local_1","p_main_party"),
          (troop_ensure_inventory_space, "trp_player", 2),
          (ge,":local_1",10),
          (dialog_box,"@Give_pork","@Unexpected harvest"),
          (store_random_in_range,":random",0,100),
          (try_begin),
            (ge,":random",94),
            (troop_add_item,"trp_player","itm_boar_mount_charge"),
          (else_try),
            (troop_add_item,"trp_player","itm_pork"),
          (try_end),  
          (play_sound,"snd_distant_dog_bark"),
        (try_end),
      (else_try),
        (eq, ":rand", 9),
        (try_begin),#give_grapes
          (store_skill_level,":skill_level","skl_surgery","trp_player"),
          (ge,":skill_level",3),
          (store_random_in_range,":random",0,100),
          (ge,":random",70),
          (store_random_in_range,":diff",0,15),
          (store_random_in_range,":r",3,5),
          (val_add,":skill_level",":r"),
          (ge,":skill_level",":diff"),
          
          (store_random_in_range,":random",0,4),
          (try_begin),
            (eq,":random",0),
            (store_random_in_range,":local_4","trp_marinid_camel_1","trp_goblin"),
          (else_try),
            (eq,":random",1),
            (store_random_in_range,":random2",1,5),
            (try_begin),
              (eq,":random2",1),
              (store_random_in_range,":local_4","trp_goblin","trp_se_tribesman"),
            (else_try),
              (eq,":random2",2),
              (store_random_in_range,":local_4","trp_vampire_1","trp_wight"),
            (else_try),
              (eq,":random2",3),
              (store_random_in_range,":local_4","trp_werewolf_1","trp_golem_1"),
            (else_try),
              (eq,":random2",4),
              (store_random_in_range,":local_4","trp_undead_magic_1","trp_demon_4_2"),
            (try_end),
          (else_try),
            (eq,":random",2),
            (store_random_in_range,":local_4","trp_france_town_recruit","trp_looter"),
          (else_try),
            (eq,":random",3),
            (store_random_in_range,":local_4","trp_rus_cossack","trp_caravan_master"),
          (try_end),
          (str_store_troop_name,1,":local_4"),
          (party_add_members,"p_main_party",":local_4",1),
          (play_sound,"snd_good_moral"),
          (dialog_box,"@A_dying_knight_1","@The dying soldier"),
        (try_end),
      (else_try),
        (eq, ":rand", 10),
        (try_begin),#give_chicken
          (store_skill_level,":power","skl_necromancy","trp_player"),
          (this_or_next|main_party_has_troop, "trp_undead_magic_2"),
          (this_or_next|main_party_has_troop, "trp_lich_1"),
          (this_or_next|main_party_has_troop, "trp_lich_2"),
          (this_or_next|main_party_has_troop, "trp_lich_3"),
          (ge,":power",1),
          (store_random_in_range,":random2",0,15),
          (try_begin),
            (main_party_has_troop, "trp_lich_3"),
            (store_random_in_range,":local_4","trp_draugr_1","trp_dullahan"),
          (else_try),
            (this_or_next|ge, ":power",8),
            (is_between,":random2",0,1),
            (store_random_in_range,":local_4","trp_vampire_assassin","trp_lich_2"),
          (else_try),
            (this_or_next|ge, ":power",6),
            (is_between,":random2",1,3),
            (store_random_in_range,":local_4","trp_vampire_1","trp_ghost"),
          (else_try),
            (this_or_next|ge, ":power",3),
            (is_between,":random2",3,6),
            (store_random_in_range,":local_4","trp_ghost","trp_wraith"),
          (else_try),
            (is_between,":random2",6,9),
            (store_random_in_range,":local_4","trp_se_tribesman","trp_draugr_1"),
          (else_try),
            (is_between,":random2",9,12),
            (store_random_in_range,":local_4","trp_zombie_1","trp_skeleton"),
          (else_try),
            (store_random_in_range,":local_4","trp_golem_1","trp_sissofbattle"),
          (try_end),
            (party_add_members,"p_main_party",":local_4",1),
            (dialog_box,"@A_dying_knight_3","@The dying soldier"),
            (play_sound,"snd_lair_undead"),
            (call_script, "script_change_troop_renown", "trp_player", -5),
        (try_end),
      (else_try),
        (eq, ":rand", 11),
        (try_begin),#give_chicken
          (store_troop_gold,":local_2","trp_player"),
          (ge,":local_2",150),
          (dialog_box,"@A_dying_knight_2"),
          (store_random_in_range,":local_3",80,120),
          (troop_remove_gold,"trp_player",":local_3"),
          (store_random_in_range,":local_4",3,6),
            
          (store_random_in_range,":ran2",0,4),
          (try_begin),
            (eq,":ran2",0),
            (dialog_box,"@A_dying_knight_2","@The dying soldier"),
          (else_try),
            (eq,":ran2",1),
            (dialog_box,"@A_dying_knight_21","@Be chivalrous"),
          (else_try),
            (eq,":ran2",2),
            (dialog_box,"@A_dying_knight_22","@Be chivalrous"),
          (else_try),
            (eq,":ran2",3),
            (dialog_box,"@A_dying_knight_23","@Be chivalrous"),
          (try_end),
          (play_sound,"snd_lair_monastery"),
          (call_script, "script_change_troop_renown", "trp_player", ":local_4"),
        (try_end),
      (try_end),
    (try_end),
  ]),
  
(16*3,0,0,
  [],
  [
    (try_begin),#event4
      (party_is_active,"p_main_party"),
      (neg|eq,"$g_player_is_captive",1),
      (store_random_in_range,":random",0,100),
      (ge,":random",50),
      (store_random_in_range,":rand",0,12),
      (try_begin),
        (eq, ":rand", 0),
        (try_begin),
          (neg|map_free),
          (store_random_in_range,":random",0,100),
          (ge,":random",40),
          (store_attribute_level,":local_11","trp_player",2),
          (ge,":local_11",18),
          (store_random_in_range,":local_12",0,100),
          (store_mul,reg0,":local_12",10),
          (dialog_box,"@solve_problem_give_money {reg0}"),
          (troop_add_gold,"trp_player",reg0),
        (try_end),
      (else_try),
        (eq, ":rand", 1),
        (try_begin),
          (neg|map_free),
          (store_attribute_level,":local_11","trp_player",3),
          (ge,":local_11",12),
          (store_random_in_range,":local_12",0,100),
          (store_mul,reg0,":local_12",2),
          (dialog_box,"@recite_poetry_give_money"),
          (troop_add_gold,"trp_player",reg0),
        (try_end),
      (else_try),
        (eq, ":rand", 2),
        (try_begin),
          (neg|map_free),
          (store_random_in_range,":random",0,100),
          (ge,":random",40),
          (store_attribute_level,":local_11","trp_player",0),
          (ge,":local_11",15),
          (store_random_in_range,":local_12",0,100),
          (store_mul,reg0,":local_12",":local_11"),
          (dialog_box,"@kill_lion_give_money"),
          (troop_add_gold,"trp_player",reg0),
        (try_end),
      (else_try),
        (eq, ":rand", 3),
        (try_begin),
          (neg|map_free),
          (store_random_in_range,":random",0,100),
          (ge,":random",40),
          (store_attribute_level,":local_11","trp_player",1),
          (ge,":local_11",18),
          (store_random_in_range,":local_12",0,100),
          (store_mul,reg0,":local_12",":local_11"),
          (dialog_box,"@catch_fairy_give_money"),
          (troop_add_gold,"trp_player",reg0),
        (try_end),
      (else_try),
        (eq, ":rand", 4),
        (try_begin),
          (troop_ensure_inventory_space, "trp_player", 2),
          (store_random_in_range,":random",0,100),
          (ge,":random",40),
          (store_attribute_level,":local_11","trp_player",1),
          (ge,":local_11",25),
          (dialog_box,"@catch_fairy_give_money"),
          (troop_add_item,"trp_player","itm_trophy_b"),
          (play_sound,"snd_add_exp"),
        (try_end),
      (else_try),
        (eq, ":rand", 5),
        (try_begin),
          (neg|map_free),
          (store_attribute_level,":local_11","trp_player",ca_strength),
          (le,":local_11",21),
          (dialog_box,"@Arena_add_str"),
          (troop_raise_attribute,"trp_player",ca_strength,1),
          (play_sound,"snd_add_exp"),
        (try_end),
      (else_try),
        (eq, ":rand", 6),
        (try_begin),
          (neg|map_free),
          (store_attribute_level,":local_11","trp_player",ca_agility),
          (le,":local_11",21),
          (dialog_box,"@Mercenary Camp_add_agi"),
          (troop_raise_attribute,"trp_player",ca_agility,1),
          (play_sound,"snd_add_exp"),
        (try_end),
      (else_try),
        (eq, ":rand", 7),
        (try_begin),
          (neg|map_free),
          (store_random_in_range,":random",0,100),
          (ge,":random",40),
          (store_attribute_level,":local_11","trp_player",ca_intelligence),
          (le,":local_11",64),
          (dialog_box,"@Library add_int"),
          (troop_add_gold,"trp_player",reg0),
          (troop_raise_attribute,"trp_player",ca_intelligence,1),
          (play_sound,"snd_add_exp"),
        (try_end),
      (else_try),
        (eq, ":rand", 8),
        (try_begin),
          (neg|map_free),
          (store_attribute_level,":local_11","trp_player",ca_charisma),
          (le,":local_11",21),
          (dialog_box,"@Witch's Hut add_cha"),
          (troop_raise_attribute,"trp_player",ca_charisma,1),
          (play_sound,"snd_add_exp"),
        (try_end),
      (else_try),
        (eq, ":rand", 9),
        (try_begin),
          (map_free),
          (store_random_in_range,":random",0,100),
          (ge,":random",60),
          (party_get_num_companions,":local_1","p_main_party"),
          (ge,":local_1",30),
          (store_random_in_range,":ran2",0,5),
          (try_begin),
            (eq,":ran2",0),
            (dialog_box,"@Monolith One Way Entrance","@The portal"),
          (else_try),
            (eq,":ran2",1),
            (dialog_box,"@Monolith One Way Entrance1","@The portal"),
          (else_try),
            (eq,":ran2",2),
            (dialog_box,"@Monolith One Way Entrance2","@The portal"),
          (else_try),
            (eq,":ran2",3),
            (dialog_box,"@Monolith One Way Entrance3","@The portal"),
          (else_try),
            (eq,":ran2",4),
            (dialog_box,"@Monolith One Way Entrance4","@The portal"),
          (try_end),
          (play_sound,"snd_gate"),
          (store_random_in_range, ":local_2", towns_begin, towns_end),
          
          (party_relocate_near_party, "p_main_party", ":local_2", 3),
        (try_end),
      (else_try),
        (eq, ":rand", 10),
        (try_begin),
          #(neg|map_free),
          (is_currently_night),
          (party_get_num_companions,":local_1","p_main_party"),
          (ge,":local_1",30),
          (dialog_box,"@dream_teacher"),
          (play_sound,"snd_add_exp"),
          (party_get_num_companion_stacks, ":num_stacks", "p_main_party"),
          (try_for_range, ":i_stack", 0, ":num_stacks"),
            (party_stack_get_troop_id, ":stack_troop", "p_main_party", ":i_stack"),
            (neg|troop_is_hero, ":stack_troop"),
            (party_stack_get_size, ":stack_size", "p_main_party", ":i_stack"),
            (call_script, "script_game_get_upgrade_xp", ":stack_troop"),
            (store_mul, ":xp_to_add", ":stack_size", reg0),
            (party_add_xp_to_stack, "p_main_party", ":i_stack", ":xp_to_add"),
          (else_try),  
            (party_stack_get_troop_id, ":stack_troop", "p_main_party", ":i_stack"),
            (troop_is_hero, ":stack_troop"),
            (party_add_xp_to_stack, "p_main_party", ":i_stack", 5000),
          (try_end),
        (try_end),
      (else_try),
        (eq, ":rand", 11),
        (try_begin),
          (store_random_in_range,":random",0,100),
          (ge,":random",70),
          (store_random_in_range,":troop_id",soldiers_begin,soldiers_end),
          (neg|troop_is_hero,":troop_id"),
          (store_character_level, ":level", ":troop_id"),
          (store_div, reg5,180, ":level"),
          (str_store_troop_name,1,":troop_id"),
          (party_add_members,"p_main_party",":troop_id",reg5),
          (play_sound,"snd_good_moral"),
          (store_random_in_range,":ran2",0,2),
          (try_begin),
            (eq,":ran2",0),
            (dialog_box,"@A_town man_noble join you","@Volunteer join"),
          (else_try),
            (eq,":ran2",1),
            (dialog_box,"@A_town man_noble join you1","@Volunteer join"),
          (try_end),
          
        (try_end),
      (try_end),
    (try_end),
  ]),
  
(0, 0, 1,
[
    (eq, "$g_is_quick_battle", -3),
],
[

    (party_get_free_companions_capacity, ":var_3", "p_main_party"),
    (party_get_skill_level, ":power", "p_main_party", "skl_necromancy"),
    (try_begin),
      (this_or_next|map_free),
        (le, ":var_3", 1),
        (rest_for_hours, 0, 5, 0),
        (display_message, "@Party full!"),
        (assign, "$g_is_quick_battle", 0),
    #(else_try),
    #    (eq, ":is_walled_center", 1),
    #    (neg|is_currently_night),
    #    (rest_for_hours, 0, 5, 0),
    #    (assign, "$g_is_quick_battle", 0),
    (else_try),
        #(neg|party_slot_eq, "$current_town", slot_center_lair_build_type, tomb_of_curses),
        (neg|party_slot_eq, "$current_town", slot_party_type, spt_village),
        (store_random_in_range, ":var_0", 1, 25),
        (eq, ":var_0", 1),
        (store_faction_of_party,":party_faction", "$current_town"),
        (neg|eq, ":party_faction", "$players_kingdom"),
        (neg|party_slot_eq, "$current_town", slot_town_lord, "trp_player"),
        #(jump_to_menu, "mnu_sneak_into_town_caught"),
        (assign, "$g_is_quick_battle", 0),
        (rest_for_hours, 0, 5, 0),
        (call_script, "script_cf_enter_center_location_bandit_check_3"),
    (else_try),
        (store_random_in_range, ":var_1", 1, 256),
        (try_begin),
            (neg|party_slot_eq, "$current_town", slot_party_type, spt_village),
            (gt, ":power", 9),
            (eq, ":var_1", 1),
            (troop_join, "trp_wraith", 0),
            (val_add,"$g_summon_undead_time", 1),
        (else_try),
            (neg|party_slot_eq, "$current_town", slot_party_type, spt_village),
            (gt, ":power", 7),
            (eq, ":var_1", 2),
            (troop_join, "trp_lich_1", 0),
            (val_add,"$g_summon_undead_time", 1),
        (else_try),
            (party_slot_eq, "$current_town", slot_center_lair_build_type, tomb_of_curses),
            (gt, ":power", 7),
            (eq, ":var_1", 3),
            (troop_join, "trp_mummy_3", 0),
            (val_add,"$g_summon_undead_time", 1),
        (else_try),
            (neg|party_slot_eq, "$current_town", slot_party_type, spt_village),
            (gt, ":power", 4),
            (is_between, ":var_1", 6, 10),
            (troop_join, "trp_vampire_1", 0),
            (val_add,"$g_summon_undead_time", 1),
        (else_try),
            (neg|party_slot_eq, "$current_town", slot_party_type, spt_village),
            (gt, ":power", 4),
            (is_between, ":var_1", 10, 16),
            (troop_join, "trp_dullahan", 0),
            (val_add,"$g_summon_undead_time", 1),
        (else_try),
            (party_slot_eq, "$current_town", slot_center_lair_build_type, longhouse),
            (is_between, ":var_1", 32, 64),
            (troop_join, "trp_draugr_1", 0),
        (else_try),
            (party_slot_eq, "$current_town", slot_center_lair_build_type, tomb_of_curses),
            (is_between, ":var_1", 32, 64),
            (troop_join, "trp_mummy_1", 0),
        (else_try),
            (gt, ":power", 3),
            (is_between, ":var_1", 32, 64),
            (troop_join, "trp_ghost", 0),
            (val_add,"$g_summon_undead_time", 1),
        (else_try),
            (gt, ":power", 2),
            (is_between, ":var_1", 16, 32),
            (troop_join, "trp_wight", 0),
        (else_try),
            (is_between, ":var_1", 32, 64),
            (troop_join, "trp_zombie_1", 0),
        (else_try),
            (is_between, ":var_1", 64, 96),
            (troop_join, "trp_se_tribesman", 0),
        (else_try),
            
            (store_random_in_range, ":rand", 1, 20),
            (store_mul, ":cost_add", ":power", ":rand"),
            (call_script, "script_change_player_soul_point", ":cost_add"),
            
            (display_message, "@You scavenged nothing!"),
        (try_end),
    (try_end),
]),

(0, 0, 1,
[
    (eq, "$g_is_quick_battle", -4),
],
[
    
    (store_random_in_range, ":var_0", 1, 25),
    
    (store_random_in_range, ":var_1", 0, 257),
    (store_free_inventory_capacity, ":var_3", "trp_player"),
    (party_get_skill_level, ":power", "p_main_party", "skl_looting"),
    (try_begin),
      (this_or_next|map_free),
        (neg|ge, ":var_3", 1),
        (rest_for_hours, 0, 5, 0),
        (display_message, "@Inventory full!"),
        (assign, "$g_is_quick_battle", 0),
    #(else_try),
    #    (eq, ":is_walled_center", 1),
    #    (neg|is_currently_night),
    #    (rest_for_hours, 0, 5, 0),
    #    (assign, "$g_is_quick_battle", 0),
    (else_try),
        #(neg|party_slot_eq, "$current_town", slot_center_lair_build_type, tomb_of_curses),
        (neg|party_slot_eq, "$current_town", slot_party_type, spt_village),
        (store_random_in_range, ":var_0", 1, 25),
        (eq, ":var_0", 1),
        (store_faction_of_party,":party_faction", "$current_town"),
        (neg|eq, ":party_faction", "$players_kingdom"),
        (neg|party_slot_eq, "$current_town", slot_town_lord, "trp_player"),
        #(jump_to_menu, "mnu_sneak_into_town_caught"),
        (call_script, "script_cf_enter_center_location_bandit_check_3"),
        (assign, "$g_is_quick_battle", 0),
        (rest_for_hours, 0, 5, 0),
    (else_try),
        (neg|party_slot_eq, "$current_town", slot_party_type, spt_village),
        (gt, ":power", 5),
        (is_between, ":var_1", 1, 2),#1
        (troop_add_item, "trp_player", "itm_trophy_c"),
        (val_add,"$g_sneaak_time", 5),
    (else_try),
        (neg|party_slot_eq, "$current_town", slot_party_type, spt_village),
        (gt, ":power", 4),
        (is_between, ":var_1", 2, 4),#2
        (troop_add_item, "trp_player", "itm_trophy_b"),
        (val_add,"$g_sneaak_time", 3),
    (else_try),
        (neg|party_slot_eq, "$current_town", slot_party_type, spt_village),
        (gt, ":power", 4),
        (is_between, ":var_1", 4, 7),#3
        (troop_add_item, "trp_player", "itm_diamonds"),
        (val_add,"$g_sneaak_time", 5),
    (else_try),
        (neg|party_slot_eq, "$current_town", slot_party_type, spt_village),
        (is_between, ":var_1", 7, 12),#5
        (call_script, "script_change_player_necro_item","itm_trophy_a",1),
        (val_add,"$g_sneaak_time", 2),
    (else_try),
        (gt, ":power", 3),
        (is_between, ":var_1", 12, 16),#4
        (store_random_armor,":local_4"),
        (troop_add_item, "trp_player", ":local_4"),
        (val_add,"$g_sneaak_time", 1),
    (else_try),
        (is_between, ":var_1", 16, 32),#16
        (call_script, "script_change_player_necro_item", "itm_crystal",1),
    (else_try),
        (gt, ":power", 2),
        (is_between, ":var_1", 32, 48),#16
        (call_script, "script_change_player_necro_item", "itm_silver",1),
        (val_add,"$g_sneaak_time", 1),
    (else_try),
        (gt, ":power", 2),
        (is_between, ":var_1", 48, 64),#16
        (store_random_in_range,":local_6","itm_winged_mace","itm_wooden_shield"),
        (troop_add_item,"trp_player",":local_6"),
        (val_add,"$g_sneaak_time", 1),
    (else_try),
        (is_between, ":var_1", 64, 80),#16
        (call_script, "script_change_player_necro_item", "itm_sulfur",1),
    (else_try),
        (is_between, ":var_1", 80, 96),#16
        (call_script, "script_change_player_necro_item", "itm_mercury",1),
    (else_try),
        (is_between, ":var_1", 96, 128),#64
        (store_random_in_range,":random",0,100),
        (troop_add_gold,"trp_player",":random"),
    (else_try),
        (is_between, ":var_1", 128, 193),#64
        (call_script, "script_change_player_necro_item", "itm_clay",1),
    (else_try),
        (call_script, "script_change_player_necro_item", "itm_skeleton",1),
    (try_end),
]),




  #work in mine
(0, 0, 4,
[
    (eq, "$g_is_quick_battle", -5),
],
[
    (store_random_in_range, ":var_1", 0, 160),
    (store_free_inventory_capacity, ":var_3", "trp_player"),
    (try_begin),
      (this_or_next|map_free),
        (neg|ge, ":var_3", 1),
        (rest_for_hours, 0, 5, 0),
        (display_message, "@Inventory full!"),
        (assign, "$g_is_quick_battle", 0),
    (else_try),
        (is_between, ":var_1", 0, 2),#2
        (troop_add_item, "trp_player", "itm_trophy_c"),
    (else_try),
        (is_between, ":var_1", 2, 6),#4
        (troop_add_item, "trp_player", "itm_trophy_b"),
    (else_try),
        (is_between, ":var_1", 6, 10),#4
        (troop_add_item, "trp_player", "itm_diamonds"),
    (else_try),
        (is_between, ":var_1", 10, 18),#8
        (call_script, "script_change_player_necro_item", "itm_trophy_a",1),
    (else_try),
        (is_between, ":var_1", 18, 34),#16
        (call_script, "script_change_player_necro_item", "itm_silver",1),
    (else_try),
        (is_between, ":var_1", 34, 50),#16
        (call_script, "script_change_player_necro_item", "itm_crystal",1),
    (else_try),
        (is_between, ":var_1", 50, 82),#32
        (troop_add_item, "trp_player", "itm_iron"),
    (else_try),
        (is_between, ":var_1", 82, 114),#32
        (troop_add_item, "trp_player", "itm_salt"),
    (else_try),
        (is_between, ":var_1", 114, 130),#16
        (call_script, "script_change_player_necro_item", "itm_sulfur",1),
    (else_try),
        (call_script, "script_change_player_necro_item", "itm_clay",1),
    (try_end),
]),
  
  #work in farm 1
(0, 0, 4,
[
    (eq, "$g_is_quick_battle", -6),
],
[
    (store_free_inventory_capacity, ":var_3", "trp_player"),
    (try_begin),
        (party_slot_eq, "$current_town", slot_village_state, svs_being_raided),
        (display_message,"@ The village is being raided. You stop your work."),
        (rest_for_hours, 0, 5, 0),
    (else_try),
        (party_slot_ge, "$current_town", slot_village_infested_by_bandits, 1),
        (display_message,"@ The village is being infested by bandits. You stop your work."),        
        (rest_for_hours, 0, 5, 0),
    (else_try),
      (this_or_next|map_free),
        (neg|ge, ":var_3", 1),
        (rest_for_hours, 0, 5, 0),
        (display_message, "@Inventory full!"),
        (assign, "$g_is_quick_battle", 0),
    (else_try),
      (store_random_in_range,reg1,30,50),
      (add_xp_to_troop, reg1, "trp_player"),
    
      (store_random_in_range,":increase_renown",1,24),        
      (try_begin),
        (eq,":increase_renown",1),
        (call_script, "script_change_player_relation_with_center", "$current_town", 1),
        (display_message,"@ You improve your renown with this village"),
      (try_end),
    
      (store_random_in_range, ":var_1", 0, 128),
      (try_begin),
        (is_between, ":var_1", 0, 2),#2
        (troop_add_item, "trp_player", "itm_spice"),
      (else_try),
        (is_between, ":var_1", 2, 8),#6
        (troop_add_item, "trp_player", "itm_furs"),
      (else_try),
        (is_between, ":var_1", 8, 14),#6
        (troop_add_item, "trp_player", "itm_raw_leather"),
      (else_try),
        (is_between, ":var_1", 14, 20),#6
        (troop_add_item, "trp_player", "itm_wool"),
      (else_try),
        (is_between, ":var_1", 20, 36),#16
        (troop_add_item, "trp_player", "itm_cheese"),
      (else_try),
        (is_between, ":var_1", 36, 52),#16
        (troop_add_item, "trp_player", "itm_sausages"),
      (else_try),
        (is_between, ":var_1", 52, 84),#32
        (troop_add_item, "trp_player", "itm_dried_meat"),
      (else_try),
        (is_between, ":var_1", 84, 96),#32
        (troop_add_item, "trp_player", "itm_sausages"),
      (else_try),
        (is_between, ":var_1", 96, 128),#16
        (troop_add_item, "trp_player", "itm_cattle_meat"),
      (try_end),
    (try_end),
]),
  
  #work in farm 2
(0, 0, 4,
[
    (eq, "$g_is_quick_battle", -7),
],
[
    (store_free_inventory_capacity, ":var_3", "trp_player"),
    (try_begin),
        (party_slot_eq, "$current_town", slot_village_state, svs_being_raided),
        (display_message,"@ The village is being raided. You stop your work."),
        (rest_for_hours, 0, 5, 0),
    (else_try),
        (party_slot_ge, "$current_town", slot_village_infested_by_bandits, 1),
        (display_message,"@ The village is being infested by bandits. You stop your work."),        
        (rest_for_hours, 0, 5, 0),
    (else_try),
      (this_or_next|map_free),
        (neg|ge, ":var_3", 1),
        (rest_for_hours, 0, 5, 0),
        (display_message, "@Inventory full!"),
        (assign, "$g_is_quick_battle", 0),
    (else_try),
      (store_random_in_range,reg1,30,50),
      (add_xp_to_troop, reg1, "trp_player"),
      (store_random_in_range,":increase_renown",1,24),        
      (try_begin),
        (eq,":increase_renown",1),
        (call_script, "script_change_player_relation_with_center", "$current_town", 1),
        (display_message,"@ You improve your renown with this village"),
      (try_end),
      (store_random_in_range, ":var_1", 0, 128),

      (try_begin),
        (is_between, ":var_1", 0, 2),#2
        (troop_add_item, "trp_player", "itm_spice"),
      (else_try),
        (is_between, ":var_1", 2, 6),#4
        (troop_add_item, "trp_player", "itm_velvet"),
      (else_try),
        (is_between, ":var_1", 6, 12),#6
        (troop_add_item, "trp_player", "itm_linen"),
      (else_try),
        (is_between, ":var_1", 12, 20),#8
        (troop_add_item, "trp_player", "itm_raw_silk"),
      (else_try),
        (is_between, ":var_1", 20, 36),#16
        (troop_add_item, "trp_player", "itm_ale"),
      (else_try),
        (is_between, ":var_1", 36, 52),#16
        (troop_add_item, "trp_player", "itm_wine"),
      (else_try),
        (is_between, ":var_1", 52, 84),#32
        (troop_add_item, "trp_player", "itm_honey"),
      (else_try),
        (is_between, ":var_1", 84, 96),#32
        (troop_add_item, "trp_player", "itm_apples"),
      (else_try),
        (is_between, ":var_1", 96, 128),#16
        (troop_add_item, "trp_player", "itm_raw_grapes"),
      (try_end),
    (try_end),
]),
  
(0, 0, 2,
[
    (eq, "$g_is_quick_battle", -8),
],
[
    #(neg|map_free),
    (store_random_in_range, ":var_0", 1, 9),
    
    (store_attribute_level, ":cha", "trp_player", ca_charisma),
    (store_skill_level,":skill_level","skl_persuasion","trp_player"),
    (val_mul, ":skill_level", 4),
    (val_add, ":cha", ":skill_level"),
    (try_begin),
        (ge, ":cha", 40),
        (store_random_in_range, ":var_2", 1, 2),
    (else_try),
        (ge, ":cha", 35),
        (store_random_in_range, ":var_2", 1, 5),
    (else_try),
        (ge, ":cha", 30),
        (store_random_in_range, ":var_2", 1, 9),
    (else_try),
        (ge, ":cha", 25),
        (store_random_in_range, ":var_2", 1, 13),
    (else_try),
        (ge, ":cha", 20),
        (store_random_in_range, ":var_2", 2, 17),
    (else_try),
        (ge, ":cha", 15),
        (store_random_in_range, ":var_2", 4, 17),
    (else_try),
        (ge, ":cha", 10),
        (store_random_in_range, ":var_2", 6, 17),
    (else_try),
        (store_random_in_range, ":var_2", 8, 17),
    (try_end),
    (store_random_in_range, ":add_troop", ":skill_level", 50),
    
    (try_begin),
        (gt, ":add_troop", 40),
        (party_get_slot, ":leader_faction", "$current_town", slot_center_original_faction),
        (faction_get_slot, ":village_troop", ":leader_faction", slot_faction_tier_1_troop),
        (faction_get_slot, ":castle_troop", ":leader_faction", slot_faction_tier_1_castle_troop),
        (faction_get_slot, ":town_troop", ":leader_faction", slot_faction_tier_1_town_troop),
        
        (try_begin),
            (is_between, ":var_2", 1, 2),
            (call_script, "script_change_player_right_to_rule", 1),
            (troop_join, ":castle_troop", 0),
            (troop_join, ":town_troop", 0),
        (else_try),
            (is_between, ":var_2", 2, 4),
            (call_script, "script_change_player_honor", 1),
            (troop_join, ":castle_troop", 0),
        (else_try),
            (is_between, ":var_2", 4, 8),
            (call_script,"script_change_troop_renown", "trp_player", 5),
            (troop_join, ":town_troop", 0),
        (else_try),
            (is_between, ":var_2", 8, 17),
            (call_script,"script_change_troop_renown", "trp_player", 3),
            (troop_join, ":village_troop", 0),
        (try_end),
    (try_end),
    (try_begin),
        (is_between, ":var_0", 1, 6),
        (try_begin),
            (is_between, ":var_2", 1, 2),
            (store_random_in_range, ":add_gold", 1, 5),
            (val_mul, ":add_gold", 250),
            (troop_add_gold, "trp_player", ":add_gold"),
            (call_script,"script_change_troop_renown", "trp_player", 2),
        (else_try),
            (is_between, ":var_2", 2, 4),
            (store_random_in_range, ":add_gold", 1, 5),
            (val_mul, ":add_gold", 100),
            (troop_add_gold, "trp_player", ":add_gold"),
            (call_script,"script_change_troop_renown", "trp_player", 1),
        (else_try),
            (is_between, ":var_2", 4, 8),
            (store_random_in_range, ":add_gold", 1, 5),
            (val_mul, ":add_gold", 50),
            (troop_add_gold, "trp_player", ":add_gold"),
        (else_try),
            (is_between, ":var_2", 8, 17),
            (store_random_in_range, ":add_gold", 1, 5),
            (val_mul, ":add_gold", 25),
            (troop_add_gold, "trp_player", ":add_gold"),
        (try_end),
    (else_try),
        (display_message, "@Spirits are low..."),
    (try_end),
]),

(0, 0, 1,
[
    (eq, "$g_is_quick_battle", -9),
],
[
    (store_random_in_range, ":gold", 1, 6),
    (val_mul, ":gold", 200),
    (store_troop_gold,":cur_gold","trp_player"),
    (party_get_free_companions_capacity, ":var_0", "p_main_party"),
    (try_begin),
        #(this_or_next|map_free),
        (neg|ge, ":var_0", 1),
        (rest_for_hours, 0, 5, 0),
        (display_message, "@Party full!"),
    (else_try),
        (neg|ge, ":cur_gold", ":gold"),
        (call_script,"script_change_troop_renown", "trp_player", -5),
        (display_message, "@You not enought gold!"),
        (rest_for_hours, 0, 5, 0),
    (else_try),
        (troop_remove_gold,"trp_player",":gold"),
        (store_random_in_range, ":add_troop", 0, 4),
        (store_random_in_range, ":add_relation", 0, 24),
        (store_random_in_range, ":add_honor", 0, 12),
        (store_random_in_range, ":add_morale", 0, 5),
        (store_random_in_range, ":add_lance_1", 0, 60),
        (store_random_in_range, ":add_lance_2", 0, 60),
        
        
        (try_begin),
           (eq, ":add_lance_1", 1),
           (party_get_slot, ":merc_lance_type", "$current_town", slot_center_merc_lance_type_1),
           (gt, ":merc_lance_type", 0),
           (assign, "$add_1000", 1),
           (party_add_template, "p_main_party", ":merc_lance_type"),
           (assign, "$add_1000", 0),
           (party_set_slot, "$current_town", slot_center_merc_lance_type_1, -1),
           (display_message, "@lance join!"),
        (try_end),
        (try_begin),
           (store_current_hours,":cur_hours"),
           (val_sub, ":cur_hours", 23),
           (this_or_next|eq, ":cur_hours", "$buy_drinks_last_time"),
           (eq, ":add_lance_2", 1),
           (party_get_slot, ":merc_lance_type", "$current_town", slot_center_merc_lance_type_2),
           (gt, ":merc_lance_type", 0),
           (assign, "$add_1000", 1),
           (party_add_template, "p_main_party", ":merc_lance_type"),
           (assign, "$add_1000", 0),
           (party_set_slot, "$current_town", slot_center_merc_lance_type_1, -1),
           (display_message, "@lance join!"),
        (try_end),
        (try_begin),
           (this_or_next|eq, ":gold",1000),
           (eq, ":add_morale", 1),
           (call_script,"script_change_player_party_morale",20),
        (try_end),
        (try_begin),
           (store_current_hours,":cur_hours"),
           (val_sub, ":cur_hours", 12),
           (this_or_next|eq, ":cur_hours", "$buy_drinks_last_time"),
           (eq, ":add_relation", 1),
           (call_script, "script_change_player_relation_with_center", "$current_town", 1),
           (val_add,"$g_drink_time", 1),
        (try_end),
        (try_begin),
            (eq, ":add_honor", 1),
            (call_script,"script_change_troop_renown", "trp_player", 1),
        (try_end),
        
        (party_get_slot, ":leader_faction", "$current_town", slot_center_original_faction),
        (faction_get_slot, ":village_troop", ":leader_faction", slot_faction_tier_1_troop),
        (faction_get_slot, ":town_troop", ":leader_faction", slot_faction_tier_1_town_troop),
        (try_begin),
            (eq, ":add_troop", 0),
            (party_get_num_companion_stacks, ":num_stacks", "$current_town"),
            (val_add, ":num_stacks", 1),
            (store_random_in_range, ":stack_no", 0, ":num_stacks"),
            (party_stack_get_troop_id, ":stack_troop", "$current_town", ":stack_no"),
            (neg|troop_is_hero, ":stack_troop"),
            (store_character_level, ":troop_level", ":stack_troop"),
            (store_skill_level,":skill_level","skl_persuasion","trp_player"),
            (val_div, ":troop_level", 6),
            (store_random_in_range, ":add_troop", 0, ":skill_level"),
            (val_add, ":add_troop", 2),
            (this_or_next|eq, ":gold",1000),
            (ge, ":add_troop", ":troop_level"),
            
            (party_stack_get_size, ":stack_size", "$current_town", ":stack_no"),
            (ge, ":stack_size", 1),
            (troop_join, ":stack_troop", 0),
        (else_try),
            (eq, ":add_troop", 1),
            (store_sub, ":offset", "$current_town", towns_begin),
            (store_add, ":cur_object_no", "p_town_merc_1", ":offset"),
            (party_get_num_companion_stacks, ":num_stacks", ":cur_object_no"),
            (val_add, ":num_stacks", 1),
            (store_random_in_range, ":stack_no", 0, ":num_stacks"),
            (party_stack_get_troop_id, ":stack_troop", ":cur_object_no", ":stack_no"),
            (neg|troop_is_hero, ":stack_troop"),
            (party_stack_get_size, ":stack_size", ":cur_object_no", ":stack_no"),
            (ge, ":stack_size", 1),
            (party_remove_members, ":cur_object_no", ":stack_troop", 1),
            (troop_join, ":stack_troop", 0),
        (else_try),
            (eq, ":add_troop", 2),
            (troop_join, ":town_troop", 0),
        (else_try),
            (troop_join, ":village_troop", 0),
            
        (try_end),
    (try_end),
    
]),

(1, 0, 0,
[
    (eq, "$g_is_quick_battle", -10),
],
[
      (try_begin),
        (party_slot_eq, "$current_town", slot_center_lair_build_type, knights_chapter),
        (assign, ":cost_gold", 1000),
        (assign, ":given_xp", 500),
      (else_try),
        (assign, ":cost_gold", 500),
        (assign, ":given_xp", 250),
      (try_end),
      
      (store_troop_gold,":cur_gold","trp_player"),
    
      (party_get_slot, ":last_time", "$current_town", slot_center_lair_build_cooldown),
      (store_add, ":dest_time", ":last_time", 10),
      (store_current_hours, ":hours"),
    
    (try_begin),
      (this_or_next|ge, ":hours", ":dest_time"),
      (map_free),
      (rest_for_hours, 0, 5, 0),
      (display_message, "@not need train!"),
      (assign, "$g_is_quick_battle", 0),
    (else_try),
      (neg|ge, ":cur_gold", ":cost_gold"),
      #(call_script,"script_change_troop_renown", "trp_player", -5),
      (display_message, "@You not enought gold!"),
      (rest_for_hours, 0, 5, 0),
      (assign, "$g_is_quick_battle", 0),
    (else_try),
      (troop_remove_gold,"trp_player",":cost_gold"),
        
      (party_get_num_companion_stacks, ":num_stacks", "p_main_party"),
      (try_for_range, ":stack_no", 0, ":num_stacks"),
        (party_stack_get_troop_id, ":stack_troop", "p_main_party", ":stack_no"),
        (party_stack_get_size, ":stack_size", "p_main_party", ":stack_no"),
        (assign, ":gained_xp", ":given_xp"),
        (try_for_range, ":stack_no_2", 0, ":num_stacks"),
          (party_stack_get_troop_id, ":this_hero", "p_main_party", ":stack_no_2"),
          (troop_is_hero, ":this_hero"),
          (neq, ":this_hero", ":stack_troop"),
          (store_skill_level, ":trainer_level", "skl_trainer", ":this_hero"),
          (call_script, "script_get_given_xp_by_trainer_level", ":trainer_level"),
          (assign, ":given_xp", reg0),
          (val_add, ":gained_xp", ":given_xp"),
        (try_end),
        (try_begin),
          (troop_is_hero, ":stack_troop"),
          (add_xp_to_troop, ":gained_xp", ":stack_troop"),
        (else_try),
          (val_mul, ":gained_xp", ":stack_size"),
          (party_add_xp_to_stack, "p_main_party", ":stack_no", ":gained_xp"),
        (try_end),
      (try_end),
    (try_end),
]),

#**************************************************
]
# modmerger_start version=201 type=2
try:
    component_name = "triggers"
    var_set = { "triggers" : triggers }
    from modmerger import modmerge
    modmerge(var_set)
except:
    raise
# modmerger_end
