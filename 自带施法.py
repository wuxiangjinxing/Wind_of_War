  ("cf_get_random_spell_for_hire_player",
   [
    (try_for_range, ":unused", 0, 7),
      (assign, ":result", -1),
      (assign, ":count_lords", 0),
      (try_for_range, ":lord_no", heroes_begin, heroes_end),
        (store_troop_faction, ":lord_faction_no", ":lord_no"),
        (eq, ":lord_faction_no", "fac_commoners"),
        #(troop_slot_eq, ":lord_no", slot_troop_occupation, slto_wait_for_hire),
        (val_add, ":count_lords", 1),
      (try_end),
      (store_random_in_range, ":random_lord", 0, ":count_lords"),
      (assign, ":count_lords", 0),
      (try_for_range, ":lord_no", heroes_begin, heroes_end),
        (eq, ":result", -1),
        (store_troop_faction, ":lord_faction_no", ":lord_no"),
        (eq, ":lord_faction_no", "fac_commoners"),
        #(troop_slot_eq, ":lord_no", slot_troop_occupation, slto_wait_for_hire),
        (val_add, ":count_lords", 1),
        (lt, ":random_lord", ":count_lords"),
        (assign, ":result", ":lord_no"),
      (try_end),
      (neq, ":result", -1),
      (assign, reg0, ":result"),
      (call_script, "script_change_troop_faction", ":result", "fac_innocents"),
    (try_end),
  ]),
  
  
  
skill_call_lightning        = 10
skill_entangle              = 11
skill_heal                  = 12
skill_mass_heal             = 13
skill_grasp                 = 14
skill_spell_dispel          = 15
  
skill_dragons_fear          = 21
skill_mummy_curse           = 24
skill_stoneskin             = 27
skill_regeneration          = 28
skill_slow                  = 29
skill_weakness              = 30
skill_haste                 = 31
skill_charm                 = 32
skill_Tzeentch_Arcane       = 39
skill_Nurgle_blessing       = 40
skill_forst_ring               = -23
skill_flame_burst              = -24







voice    =  1
spell    =  2
quick_spell    =  3
  
def set_magic_type():
  result_list = []
  for row_no in xrange(len(magic_type)):
    result_list.append((item_set_slot, magic_type[row_no][0], slot_item_magic_cost,   magic_type[row_no][1]))
    result_list.append((item_set_slot, magic_type[row_no][0], slot_item_magic_type,   magic_type[row_no][2]))
    result_list.append((item_set_slot, magic_type[row_no][0], slot_item_magic_cooldown,   magic_type[row_no][3]))
    result_list.append((item_set_slot, magic_type[row_no][0], slot_item_magic_difficulty,   magic_type[row_no][4]))
    result_list.append((item_set_slot, magic_type[row_no][0], slot_item_is_magic_spell,   magic_type[row_no][5]))
  return result_list[:]

magic_type = [
  ("itm_voice_clear_skies", 0, voice, 10, 0, 1),
  ("itm_voice_cyclone", 0, voice, 30, 0, 1),
  ("itm_voice_unrelenting_force", 0, voice, 20, 0, 1),
  ("itm_voice_become_ethereal", 0, voice, 16, 0, 1),
  ("itm_voice_slow_time", 0, voice, 25, 0, 1),
  ("itm_voice_animal_allegiance", 0, voice, 45, 0, 1),
  ("itm_voice_storm_call", 0, voice, 60, 0, 1),
  ("itm_voice_call_dragon", 0, voice, 60, 0, 1),
  ("itm_voice_call_of_valor", 0, voice, 60, 0, 1),
  ("itm_voice_disarm", 0, voice, 25, 0, 1),
  ("itm_voice_dismaying_shout", 0, voice, 40, 0, 1),
  ("itm_voice_bend_will", 0, voice, 60, 0, 1),
  ("itm_voice_fire_breath", 0, voice, 20, 0, 1),
  ("itm_voice_whirlwind_sprint", 0, voice, 10, 0, 1),
  ("itm_voice_frost_breath", 0, voice, 30, 0, 1),
  ("itm_voice_ice_form", 0, voice, 20, 0, 1),
  ("itm_voice_marked_for_death", 0, voice, 15, 0, 1),
  ("itm_voice_soul_tear", 0, voice, 25, 0, 1),
  ("itm_voice_drain_vitality", 0, voice, 20, 0, 1),

  
  
  
  
]
    
  
  
  
  
  
  
  
  
magic_trigger_1  =(
    1, 0, 0, [], 
    [
  (get_player_agent_no,":player"),

  (assign, ":skill_rate", 25),

  (try_begin),
    (eq, "$g_game_difficulty",1),
    (assign, ":skill_rate", 25),
    (assign, ":extra_cooldown", 4),
  (else_try),  
    (eq, "$g_game_difficulty",2),
    (assign, ":skill_rate", 50),
    (assign, ":extra_cooldown", 3),
  (else_try),  
    (eq, "$g_game_difficulty",3),
    (assign, ":skill_rate", 75),
    (assign, ":extra_cooldown", 2),
  (else_try),  
    (eq, "$g_game_difficulty",4),
    (assign, ":skill_rate", 100),
    (assign, ":extra_cooldown", 1),
  (try_end),

  
  (try_for_agents, ":agent_no"),
    (agent_is_human, ":agent_no"),
    (agent_is_active, ":agent_no"),
    (agent_is_alive, ":agent_no"),
    (agent_get_troop_id, ":troop_no", ":agent_no"),
        
    (try_begin),
      (agent_get_slot, ":cooldown", ":agent_no", slot_agent_shield_bash_timer),
      (agent_get_slot, ":stamina", ":agent_no", slot_agent_mana),
      (try_begin),
        (eq,":cooldown",0),
        (neq,":agent_no",":player"),

        (store_random_in_range, ":r", 0, 100),
        (this_or_next|troop_is_hero, ":troop_no"),
        (gt, ":skill_rate", ":r"),
        (assign, ":choose_magic",-1),
        (try_begin),
          (troop_is_hero, ":troop_no"),
          (try_for_range, ":slot_spell", slot_troop_spell_1, slot_troop_spell_end),
            (eq, ":choose_magic", -1),
            (store_sub, ":offset", ":slot_spell", slot_troop_spell_1),
            
            (store_add, ":slot_spell_cd", slot_agent_spell_1_cooldown, ":offset"),

            (agent_get_slot, ":cooldown_2", ":agent_no", ":slot_spell_cd"),
            
            (agent_get_slot, ":magic_id", ":agent_no", ":slot_spell"),
            (item_get_slot, ":magic_cost", ":magic_id", slot_item_magic_cost),
            
            (item_get_slot, ":min_cd", ":magic_id", slot_item_magic_cooldown),
            (eq, ":cooldown_2", 0),
            (gt, ":stamina", ":magic_cost"),
            (assign, ":choose_magic",":magic_id"),
            #(agent_set_slot, ":agent_no", ":slot_spell_cd", ":min_cd"),
          (try_end),
        (else_try),  
          (neg|troop_is_hero, ":troop_no"),
          (assign, ":count_spell", 0),
          (troop_get_inventory_capacity, ":inv_cap", ":troop_no"),
          (try_for_range, ":i_slot", 0, ":inv_cap"),
            (troop_get_inventory_slot, ":item", ":troop_no", ":i_slot"),
            (gt, ":item", -1),
            (item_get_slot, ":magic_type", ":item", slot_item_magic_type),
            (gt, ":magic_type", 0), 
            (neg|eq, ":magic_type", quick_spell), 
            (val_add, ":count_spell", 1),
          (try_end),
          (store_random_in_range, ":random_spell", 0, ":count_spell"),
          (assign, ":count_spell", 0),
          (try_for_range, ":i_slot", 0, ":inv_cap"),
            (eq, ":choose_magic", -1),
            (troop_get_inventory_slot, ":item", ":troop_no", ":i_slot"),
            (gt, ":item", -1),
            (item_get_slot, ":magic_type", ":item", slot_item_magic_type),
            (gt, ":magic_type", 0), 
            (neg|eq, ":magic_type", quick_spell), 
            (val_add, ":count_spell", 1),
            (lt, ":random_spell", ":count_spell"),
            (assign, ":choose_magic", ":item"),
          (try_end),
        (try_end),
        
        (try_begin),
          (eq,":choose_magic",-1),
          (val_add, ":extra_cooldown", 2),
          (agent_set_slot, ":agent_no", slot_agent_shield_bash_timer, ":extra_cooldown"),
        (else_try),  
          (item_get_slot, ":magic_type", ":choose_magic", slot_item_magic_type),
          (item_get_slot, ":magic_cost", ":choose_magic", slot_item_magic_cost),
          (item_get_slot, ":magic_cooldown", ":choose_magic", slot_item_magic_cooldown),
          #(item_get_slot, ":difficulty", ":magic_id", slot_item_magic_difficulty),
          
          (assign, ":slot_spell_cd",slot_agent_spell_1_cooldown),
          (try_begin),
            (troop_is_hero, ":troop_no"),
            (assign, ":cur_magic_slot",-1),
            (try_for_range, ":slot_spell", slot_troop_spell_1, slot_troop_spell_end),
              (eq, ":cur_magic_slot", -1),
              (agent_get_slot, ":magic_id", ":agent_no", ":slot_spell"),
              (eq, ":magic_id", ":choose_magic"),
              (assign, ":cur_magic_slot", ":slot_spell"),
            (try_end),
            (store_sub, ":offset", ":cur_magic_slot", slot_troop_spell_1),
            (store_add, ":slot_spell_cd", slot_agent_spell_1_cooldown, ":offset"),
          (try_end),
          (agent_get_slot, ":cooldown_2", ":agent_no", ":slot_spell_cd"),
          
          
          (try_begin),
            (eq,":magic_type",spell),
            (eq,":cooldown_2",0),
            
            (agent_get_wielded_item, ":weapon", ":agent_no", 0),
            (gt,":weapon",0),
            (item_has_property, ":weapon", itp_is_magic_staff),
            (play_sound,"snd_spell_cast"),
            
            
            (ge, ":stamina", ":magic_cost"),
            (call_script, "script_cf_magic_cast_trigger_2", ":agent_no", ":choose_magic", -1),
            (val_sub, ":stamina", ":cost_stamina"),
            (agent_set_slot, ":agent_no", slot_agent_mana, ":stamina"),
            (agent_set_slot, ":agent_no", ":slot_spell_cd", ":magic_cooldown"),
            (agent_set_slot, ":agent_no", slot_agent_shield_bash_timer, 5),
          (else_try),
            (eq,":magic_type",voice),
            (eq,":cooldown_2",0),
            (call_script, "script_cf_agent_dragon_voice", ":agent_no", ":choose_magic"),
            (agent_set_slot, ":agent_no", ":slot_spell_cd", ":magic_cooldown"),
            (agent_set_slot, ":agent_no", slot_agent_shield_bash_timer, 5),
          (try_end),
        (try_end),
      (try_end),
    (try_end),
  (try_end),        
])                  

magic_quick_spell_trigger_1 = (
    0.1, 0, 0,
   [],
   [
    (set_fixed_point_multiplier, 1),
    (try_for_agents,":agent_no"),
      (agent_is_human,":agent_no"),
      (agent_is_alive,":agent_no"),
      (agent_get_wielded_item, ":agent_cur_weapon", ":agent_no", 0),
      (gt,":agent_cur_weapon", 0),
      (item_has_property, ":agent_cur_weapon", itp_is_magic_staff),
      (item_get_type, ":cur_weapon_type", ":agent_cur_weapon"),
      (agent_get_attack_action, ":attack_action", ":agent_no"),
      (try_begin),
        (eq, ":attack_action", 1),
        #ticker trigger
        (agent_get_slot,":ticker_time",":agent_no",slot_agent_shoot_time_ticker),
        (try_begin),
          (le,":ticker_time",0),      
          
          #ticker trigger
          (item_get_speed_rating, ":ticker_time", ":agent_cur_weapon"),
          (val_max,":ticker_time",1),
          (store_div,":ticker_time",200,":ticker_time"),
          (agent_set_slot,":agent_no",slot_agent_shoot_time_ticker,":ticker_time"),    
            
          (agent_get_slot, ":stamina", ":agent_no", slot_agent_mana),
            
            
        (assign, ":choose_magic",-1),
        (try_begin),
          (troop_is_hero, ":troop_no"),
          (try_for_range, ":slot_spell", slot_troop_spell_1, slot_troop_spell_end),
            (eq, ":choose_magic", -1),
            
            (agent_get_slot, ":magic_id", ":agent_no", ":slot_spell"),
            
            (item_get_slot, ":magic_type", ":magic_id", slot_item_magic_type),
            (eq,":magic_type",quick_spell),
            (item_get_slot, ":magic_cost", ":magic_id", slot_item_magic_cost),
            (gt, ":stamina", ":magic_cost"),
            (assign, ":choose_magic",":magic_id"),
            #(agent_set_slot, ":agent_no", ":slot_spell_cd", ":min_cd"),
          (try_end),
        (else_try),  
          (neg|troop_is_hero, ":troop_no"),
          (assign, ":count_spell", 0),
          (troop_get_inventory_capacity, ":inv_cap", ":troop_no"),
          (try_for_range, ":i_slot", 0, ":inv_cap"),
            (troop_get_inventory_slot, ":item", ":troop_no", ":i_slot"),
            (gt, ":item", -1),
            (item_get_slot, ":magic_type", ":item", slot_item_magic_type),
            (eq, ":magic_type",quick_spell), 
            (val_add, ":count_spell", 1),
          (try_end),
          (store_random_in_range, ":random_spell", 0, ":count_spell"),
          (assign, ":count_spell", 0),
          (try_for_range, ":i_slot", 0, ":inv_cap"),
            (eq, ":choose_magic", -1),
            (troop_get_inventory_slot, ":item", ":troop_no", ":i_slot"),
            (gt, ":item", -1),
            (item_get_slot, ":magic_type", ":item", slot_item_magic_type),
            (eq, ":magic_type",quick_spell), 
            (val_add, ":count_spell", 1),
            (lt, ":random_spell", ":count_spell"),
            (assign, ":choose_magic", ":item"),
          (try_end),
        (try_end),
        (gt, ":choose_magic",-1),
          
          #reduce ammo
          (assign,":killed",1),
          (try_begin),
            (neq,":choose_magic","itm_cartridges_burst"),
            (assign,":killed",3),
          (else_try),
            (eq,":choose_magic","itm_cartridges_burst"),
            (assign,":killed",4),
          (else_try),
            (eq,":choose_magic","itm_cartridges_burst"),
            (eq,":agent_cur_weapon","itm_drawf_musket_8barrel1"),
            (assign,":killed",2),
          (else_try),
            (eq,":choose_magic","itm_cartridges_burst"),
            (eq,":agent_cur_weapon","itm_zlmg"),
            (assign,":killed",2),
          (else_try),
            (eq,":choose_magic","itm_cartridges_burst"),
            (eq,":agent_cur_weapon","itm_sissofbattle_A295"),
            (assign,":killed",4),
          (try_end),

          (assign,":flame_ammo",0),
          (try_begin), 
            (eq,":cur_ammo_id","itm_cartridges_flame"),
            (assign,":flame_ammo",1),
          (try_end),
          
          
          #get original position of weapon
          (agent_get_look_position,pos23,":agent_no"),
          
          (agent_get_bone_position, pos24, ":agent_no", 9, 1),
          (position_move_z, pos24, 30, 1),
          (position_copy_rotation,pos24,pos23),

          ##get weapon position after calculating accuracy
          (set_fixed_point_multiplier, 1),
          (item_get_missile_speed, ":bullet_speed", ":agent_cur_weapon"),
          (try_begin),
            (le,":bullet_speed",0),
            (assign,":bullet_speed",150),
          (try_end),
          
          (try_begin),
             (eq,":cur_weapon_type",itp_type_pistol),
             (play_sound_at_position, "snd_release_musket", pos24),
             (agent_set_animation, ":agent_no", "anim_release_pistol", 1),
          (else_try), 
          (try_end),

          (try_for_range, ":unused", 0, ":killed"),
            (copy_position,pos25,pos24),
            (val_add,":bullet_speed",-3),
            (add_missile, ":agent_no", pos25, ":bullet_speed", ":agent_cur_weapon", 0, ":choose_magic",0),
            (try_begin),
              (eq,":flame_ammo",1),
              (call_script, "script_flame_cast_trigger", ":agent_no", ":choose_magic"),
            (try_end),
          (try_end),
        (else_try),
          (val_sub,":ticker_time",1),
          (agent_set_slot,":agent_no",slot_agent_shoot_time_ticker,":ticker_time"),
        (try_end),     
      (else_try),
        (agent_get_defend_action, ":defend_action_state", ":agent_no"),
        (this_or_next|gt,":defend_action_state",0),
        (gt,":attack_action",1),
        (item_get_speed_rating, ":ticker_time", ":agent_cur_weapon"),
        (val_max,":ticker_time",1),
        (store_div,":ticker_time",800,":ticker_time"),
        (agent_set_slot,":agent_no",slot_agent_shoot_time_ticker,":ticker_time"),      
      (try_end),
    (try_end),
   ]
)

magic_trigger_player  =(
    0, 0, 0, [
    ], 
    [
    (get_player_agent_no,":player"),
    (agent_is_alive,":player"),
    (agent_get_troop_id, ":player_no", ":player"),
    
    
    (agent_get_slot, ":cooldown", ":player", slot_agent_shield_bash_timer),
    
    (store_current_scene,":current_scene"),
    (neg|is_between, ":current_scene", "scn_town_1_tavern", "scn_town_1_walls"),
    
    (try_begin),
      (agent_get_slot, ":stamina", ":player", slot_agent_mana),
      (eq,":cooldown",0),
      (agent_get_slot, ":choose_magic", ":player", slot_agent_cur_magic),
      (neg|eq,":choose_magic",0),
      (item_get_slot, ":magic_type", ":choose_magic", slot_item_magic_type),
      (item_get_slot, ":magic_cost", ":choose_magic", slot_item_magic_cost),
      (item_get_slot, ":magic_cooldown", ":choose_magic", slot_item_magic_cooldown),
      
      (assign, ":cur_magic_slot",-1),
      (try_for_range, ":slot_spell", slot_troop_spell_1, slot_troop_spell_end),
        (eq, ":cur_magic_slot", -1),
        (agent_get_slot, ":magic_id", ":player", ":slot_spell"),
        (eq, ":magic_id", ":choose_magic"),
        (assign, ":cur_magic_slot", ":slot_spell"),
      (try_end),
      (store_sub, ":offset", ":cur_magic_slot", slot_troop_spell_1),
      (store_add, ":slot_spell_cd", slot_agent_spell_1_cooldown, ":offset"),
      (agent_get_slot, ":cooldown_2", ":player", ":slot_spell_cd"),
      
      (try_begin),
        (key_clicked, "$key_special_7"),
        (try_begin),
          (eq, ":cur_magic_slot", slot_troop_spell_1),
          (assign, ":cur_magic_slot", slot_troop_spell_end),
        (try_end),
        (store_add, ":new_magic_slot", ":cur_magic_slot", -1),
        (agent_get_slot, ":magic_id", ":player", ":new_magic_slot"),
        (agent_set_slot, ":player", slot_agent_cur_magic, ":magic_id"),
      (else_try),
        (key_clicked, "$key_special_8"),
        (store_add, ":new_magic_slot", ":cur_magic_slot", 1),
        (try_begin),
          (eq, ":new_magic_slot", slot_troop_spell_end),
          (assign, ":new_magic_slot", slot_troop_spell_1),
        (try_end),
        (agent_get_slot, ":magic_id", ":player", ":new_magic_slot"),
        (agent_set_slot, ":player", slot_agent_cur_magic, ":magic_id"),
      (try_end),

      (try_begin),
        (gt,":cooldown",0),
        #(this_or_next|key_is_down, "$key_special_6"),
        (key_clicked, "$key_special_6"),
        (assign, reg50, ":cooldown"),
        (display_message, "@magic cooldown ({reg50} seconds)."),
      (else_try),
        (key_is_down, "$key_special_6"),
        (eq,":magic_type",quick_spell),
        (ge, ":stamina", ":magic_cost"),
        (call_script, "script_cf_magic_cast_trigger_2", ":player", ":choose_magic", -1),
        (val_sub, ":stamina", ":cost_stamina"),
        (agent_set_slot, ":player", slot_agent_mana, ":stamina"),
        (agent_set_slot, ":player", slot_agent_shield_bash_timer, 1),
      (else_try),
        (key_clicked, "$key_special_6"),
        (eq,":magic_type",voice),
        (eq,":cooldown_2",0),
        (call_script, "script_cf_agent_dragon_voice", ":player", ":choose_magic"),

        (gt, ":slot_spell_cd", 0),
        (agent_set_slot, ":player", ":slot_spell_cd", ":magic_cooldown"),
        (agent_set_slot, ":player", slot_agent_shield_bash_timer, 5),
      (else_try),
        (key_clicked, "$key_special_6"),
        (eq,":magic_type",spell),
        (eq,":cooldown_2",0),
          
        (agent_get_wielded_item, ":weapon", ":player", 0),
        (gt,":weapon",0),
        (item_has_property, ":weapon", itp_is_magic_staff),
        (play_sound,"snd_spell_cast"),
        #(store_skill_level, ":power", skl_magic_power, ":player_no"),
        #(val_mul,":magic_cost",":power"),
        #(val_div,":magic_cost",2),
        
        (ge, ":stamina", ":magic_cost"),
        (call_script, "script_cf_magic_cast_trigger_2", ":player", ":choose_magic", -1),
        (val_sub, ":stamina", ":cost_stamina"),
        (agent_set_slot, ":player", slot_agent_mana, ":stamina"),

        (gt, ":slot_spell_cd", 0),
        (agent_set_slot, ":player", ":slot_spell_cd", ":magic_cooldown"),
        (agent_set_slot, ":player", slot_agent_shield_bash_timer, 5),
      (else_try),
        (assign, reg1, ":stamina"),
        (display_message, "@not enough mana^mana: {reg1}/100"),    
      (try_end),
    (try_end),
])
  








slot_item_magic_cost                   = 66
slot_item_magic_type                   = 68
slot_item_magic_cooldown               = 70
slot_item_magic_difficulty             = 73
slot_item_magic_need_cooldown          = 74
slot_item_is_magic_spell       = 75






  ("cf_agent_spell_target",
    [
      (store_script_param, ":agent_no", 1),
      (assign, ":target_agent", -1),
      (get_player_agent_no,":player"),
      (try_begin),
        (agent_is_alive, ":agent_no"),
        (agent_is_human, ":agent_no"),
        (agent_get_look_position, pos1, ":agent_no"),
        
        (assign, ":distance", 5000),
        (assign, ":end", 1),

        (set_fixed_point_multiplier, 100),
        
        (try_begin), 
          (agent_ai_get_look_target, ":look_target_agent", ":agent_no"),
          (try_begin),
            (eq, ":player",":agent_no"),
            (agent_get_slot, ":look_target_agent", ":player", slot_agent_player_target),
          (try_end),
          
          (neq, ":cur_agent", ":agent_no"),
          (agent_is_alive, ":cur_agent"),
          (agent_is_human, ":cur_agent"),
          
          
          (this_or_next|agent_is_ally,":look_target_agent"),
          (agent_is_ally,":agent_no"),
          (this_or_next|neg|agent_is_ally,":agent_no"),
          (neg|agent_is_ally,":look_target_agent"),
          
          (agent_get_position, pos2, ":look_target_agent"),
          (get_distance_between_positions, ":cur_distance", pos1, pos2),
          (le, ":cur_distance", ":distance"),
          (position_move_z, pos2, 175, 0),
          (position_has_line_of_sight_to_position, pos1, pos2), #visibility
          (assign, ":end", -1),
        (try_end),

        (try_for_agents,":cur_agent"),
          (eq, ":end", 1),
          (neq, ":cur_agent", ":agent_no"),
          (agent_is_alive, ":cur_agent"),
          (agent_is_human, ":cur_agent"),
          
          (this_or_next|agent_is_ally,":cur_agent"),
          (agent_is_ally,":agent_no"),
          (this_or_next|neg|agent_is_ally,":agent_no"),
          (neg|agent_is_ally,":cur_agent"),
          
          (agent_get_position, pos2, ":cur_agent"),
          
          (neg|agent_slot_eq, ":cur_agent", slot_agent_has_been_special_ability, call_lightning), 
          (get_distance_between_positions, ":cur_distance", pos1, pos2),
          (position_has_line_of_sight_to_position, pos1, pos2), #visibility
          (le, ":cur_distance", ":distance"),

          (assign, ":target_agent", ":cur_agent"),
        (try_end),
      (try_end),
      (assign, reg0, ":target_agent"),
      (agent_set_slot, ":target_agent", slot_agent_has_been_special_ability, call_lightning),
      (agent_get_position, pos51, ":target_agent"),
      (position_move_z, pos51, 80, 0),
      (agent_set_look_target_position, ":agent_no", pos51),
  ]),


  # magic_cast_trigger
  # input: shooter
  #        max_damage
  #        max_range
  #        pos51 = position of grenade hit
  ("cf_magic_cast_trigger_2", 
  [
    (store_script_param, ":shooter", 1),
    (store_script_param, ":cast_spell", 2),
    (store_script_param, ":need_target_agent", 3),

    (agent_get_troop_id, ":shooter_troop", ":shooter"),
    (store_skill_level, ":power", "skl_magic_power", ":shooter_troop"),
      
    (agent_get_horse,":horse",":shooter"),
    (agent_get_look_position,pos3,":shooter"),
      
    (agent_get_position,pos4,":shooter"),
    (position_copy_rotation,pos4,pos3),
    (try_begin), 
      (gt, ":horse", -1),
      (position_move_z,pos4,270),
    (else_try),
      (neg|gt, ":horse", -1),
      (position_move_z,pos4,170),
    (try_end),
    (position_move_y,pos4,110),

    (try_begin), 
      (eq,":need_target_agent",-1),
      (assign,":target_agent",-1),
      (try_begin),
        (get_player_agent_no,":player"),
        (eq,":shooter",":player"),
        (eq, "$skill_mask_start", 1),
        (key_is_down, key_left_shift),
        (assign,":target_agent",-2),
      (else_try),
        (call_script, "script_cf_agent_spell_target", ":shooter"),#pos51
        (assign, ":target_agent", reg0),
      (try_end),
      (try_begin),
        (eq,":target_agent",-2),
        (copy_position, pos5, pos43),
      (else_try),
        (ge,":target_agent",0),
        (agent_get_position, pos5, ":target_agent"),
      (try_end),
    (try_end),
    
    (position_move_z, pos5, 40, 0),
      
    (try_begin),
      (eq,":cast_spell","itm_magic_arcane_orb"),
      (try_begin),
        (assign,":max_range",200),
        (assign,":damage",200),
        (store_random_in_range, ":randon_damage", 80, 121),
        (store_mul,":range_add",":power", 30),
        (store_mul,":damage_add",":power", ":randon_damage"),
        (val_add,":max_range",":range_add"),
        (store_add,":max_damage",":damage",":damage_add"),
      (try_end),
      (copy_position,pos6,pos5),
      (position_move_z,pos6,300),
      (particle_system_burst, "psys_arcane_explosion", pos6, 5),
      (try_for_agents,":possable_agent"),
        (gt,":damage",0),
        (gt,":power",0),
        (agent_is_alive,":possable_agent"),
        (this_or_next|agent_is_ally,":shooter"),
        (agent_is_ally,":possable_agent"),
        (this_or_next|neg|agent_is_ally,":possable_agent"),
        (neg|agent_is_ally,":shooter"),

        (agent_get_position,pos3,":possable_agent"),
        (get_distance_between_positions,":dist",pos5,pos3),
        (le,":dist",":max_range"),
        (assign,":agent",":possable_agent"),
        
        (val_add,":power",-1),
        (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":max_damage", thunder, ":power", ":power"),
        (try_begin),
          (agent_has_item_equipped,":shooter","itm_magic_book_2"),
          (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":max_damage", thunder, ":power", ":power"),
        (try_end),
        
        
        (assign,":max_damage",":damage_add"),
      (try_end),
    (else_try),  
      (eq,":cast_spell","itm_magic_black_hold"),
      (try_begin),
        (assign,":range",100),
        (store_mul,":range_add",":power", 15),
        (store_div,":damage",":power", 4),
        (val_add,":range",":range_add"),
        (val_add,":damage",2),
      (try_end),
    
      (copy_position,pos4,pos5),
      (try_for_range,":posz",0,":damage"),
        (try_begin),
          (store_add,":max_damage",":posz",1),
          (ge,":max_damage",":damage"),
          (val_add,":max_damage",1),
          (val_mul,":max_damage",500),
          (position_move_z,pos4,":max_damage"),
          (add_missile, ":shooter", pos4, 0, ":weapon", 0, "itm_magic_arcane_orb", 0),
        (try_end),
        (val_mul,":posz",500),
        (position_move_z,pos4,":posz"),
        (add_missile, ":shooter", pos4, 0, ":weapon", 0, "itm_magic_black_hold_2", 0),
      (try_end),
    (else_try),  
      (eq,":cast_spell","itm_magic_black_hold_2"),
      (try_begin),
        (assign,":max_range",200),
        (assign,":damage",50),
        (store_random_in_range, ":randon_damage", 40, 61),
        (store_mul,":range_add",":power", 100),
        (store_mul,":damage_add",":power", ":randon_damage"),
        (val_add,":max_range",":range_add"),
        (store_add,":max_damage",":damage",":damage_add"),
      (try_end),
      (copy_position,pos6,pos5),
      (position_move_z,pos6,300),
      (particle_system_burst, "psys_black_hold", pos6, 5),
      
      (try_for_agents,":possable_agent"),
        (gt,":damage",0),
        (gt,":power",0),
        (agent_is_alive,":possable_agent"),
        (this_or_next|agent_is_ally,":shooter"),
        (agent_is_ally,":possable_agent"),
        (this_or_next|neg|agent_is_ally,":possable_agent"),
        (neg|agent_is_ally,":shooter"),

        (agent_get_position,pos3,":possable_agent"),
        (get_distance_between_positions,":dist",pos5,pos3),
        (le,":dist",":max_range"),
        (assign,":agent",":possable_agent"),
        
        (agent_get_horse, ":target_horse", ":agent"),
        (try_begin),
          (gt, ":target_horse", 0),
          (agent_set_position, ":target_horse", pos5),
          (agent_set_animation, ":target_horse", "anim_horse_rear"),
        (else_try),
          (agent_set_position, ":agent", pos5),
        (try_end),
        
        (val_add,":power",-1),
        (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":max_damage", thunder, ":power", ":power"),
        (assign,":max_damage",":damage_add"),
      (try_end),
    (else_try),  
      (eq,":cast_spell","itm_magic_frost_cloud"),
      
      (try_begin),
        (assign,":range",100),
        (store_mul,":range_add",":power", 15),
        (store_div,":damage",":power", 3),
        (val_add,":range",":range_add"),
        (val_add,":damage",2),
      (try_end),

      (copy_position,pos4,pos5),
      (try_for_range,":posz",0,":damage"),
        (store_random_in_range, ":posx", -2,3),
        (store_random_in_range, ":posy", -2,3),
        (val_mul,":posx",20),
        (val_mul,":posy",20),
        (try_begin),
          (agent_has_item_equipped,":shooter","itm_plague_staff_1"),
          (val_mul,":posx",5),
          (val_mul,":posy",5),
        (try_end),
        (val_mul,":posz",500),
        (position_move_x,pos4,":posx"),
        (position_move_y,pos4,":posy"),
        (position_move_z,pos4,":posz"),
        (add_missile, ":shooter", pos4, 0, ":weapon", 0, "itm_magic_frost_cloud_dummy", 0),
      (try_end),
    (else_try),  
      (eq,":cast_spell","itm_magic_frost_cloud_dummy"),

      (try_begin),
        (assign,":max_range",200),
        (assign,":damage",50),
        (store_mul,":range_add",":power", 40),
        (store_mul,":damage_add",":power", 30),
        (val_add,":max_range",":range_add"),
        (store_add,":max_damage",":damage",":damage_add"),
        (store_mul,":spec_power",":power", 3),
      (try_end),
      
      (try_begin),
        (agent_has_item_equipped,":shooter","itm_magic_book_3"),
        (val_mul,":max_damage",2),
        (val_add,":max_range",":range_add"),
      (try_end),
      (particle_system_burst, "psys_Ice_Storm", pos5, 10),

      
      (try_for_agents,":possable_agent"),
        (gt,":max_damage",0),
        (agent_is_alive,":possable_agent"),
        (this_or_next|agent_is_ally,":shooter"),
        (agent_is_ally,":possable_agent"),
        (this_or_next|neg|agent_is_ally,":possable_agent"),
        (neg|agent_is_ally,":shooter"),

        (agent_get_position,pos3,":possable_agent"),
        (get_distance_between_positions,":dist",pos5,pos3),
        (le,":dist",":max_range"),
        (assign,":agent",":possable_agent"),
        (store_div,":half_damage",":max_damage",2),
        (store_random_in_range, ":damage", ":half_damage",":max_damage"),
        #(agent_deliver_damage_to_agent,":shooter",":agent", ":damage"),
        (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":damage", freeze, ":spec_power", ":power"),
      (try_end),
    (else_try),  
      (eq,":cast_spell","itm_magic_deep_freeze"),
      (try_begin),
        (assign,":max_range",200),
        (assign,":damage",100),
        (store_mul,":range_add",":power", 40),
        (store_mul,":damage_add",":power", 100),
        (val_add,":max_range",":range_add"),
        (store_add,":max_damage",":damage",":damage_add"),
      (try_end),
      (try_begin),
        (agent_has_item_equipped,":shooter","itm_magic_book_3"),
        (val_mul,":max_damage",2),
        (val_add,":max_range",":range_add"),
      (try_end),
            
      (try_begin),
        (eq, "$g_weapon_fire_particle", 0),
        (gt,":damage",0),
        (particle_system_burst, "psys_Ice_Storm", pos5, 10),
      (else_try),  
        (gt,":damage",0),
        (particle_system_burst, "psys_Ice_Storm", pos5, 5),
      (try_end),
      (try_for_agents,":possable_agent"),
        (gt,":damage",0),
        (gt,":power",0),
        (agent_is_alive,":possable_agent"),
        (this_or_next|agent_is_ally,":shooter"),
        (agent_is_ally,":possable_agent"),
        (this_or_next|neg|agent_is_ally,":possable_agent"),
        (neg|agent_is_ally,":shooter"),

        (agent_get_position,pos3,":possable_agent"),
        (get_distance_between_positions,":dist",pos5,pos3),
        (le,":dist",":max_range"),
        (assign,":agent",":possable_agent"),
        
        (val_add,":power",-1),
        (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":max_damage", freeze, ":power", ":power"),
        (assign,":max_damage",":damage_add"),
        
        (try_begin),
          (agent_has_item_equipped,":shooter","itm_magic_book_3"),
          (store_agent_hit_points, ":inflicted_agent_hp", ":agent", 0),
          (store_mul,":dead_power",":power", 5),
          (ge, ":dead_power", ":inflicted_agent_hp"),
          (agent_set_hit_points,":agent",0,0),
          (agent_deliver_damage_to_agent, ":shooter", ":agent", 100),
        (try_end),
        
      (try_end),
    (else_try),  
      (eq,":cast_spell","itm_magic_frozen_orb"),
      (try_begin),
        (assign,":max_range",200),
        (assign,":damage",100),
        (store_random_in_range, ":randon_damage", 50, 151),
        (store_mul,":range_add",":power", 40),
        (store_mul,":damage_add",":power", ":randon_damage"),
        (val_add,":max_range",":range_add"),
        (store_add,":max_damage",":damage",":damage_add"),
        (store_mul,":add_missile",":power", 3),
        (val_add,":add_missile",5),
      (try_end),
      
      (try_begin),
        (agent_has_item_equipped,":shooter","itm_magic_book_2"),
        (val_mul,":add_missile",2),
      (try_end),
      
      (position_get_distance_to_ground_level, ":distance", pos5),
      (try_begin),
        (lt, ":distance", 0),
        (position_set_z_to_ground_level, pos5),
        (position_move_z, pos5, 200),
      (try_end),                
      (try_begin),
        (eq, "$g_weapon_fire_particle", 0),
        (gt,":damage",0),
        (particle_system_burst, "psys_Ice_Storm", pos5, 50),
      (else_try),  
        (gt,":damage",0),
        (particle_system_burst, "psys_Ice_Storm", pos5, 5),
      (try_end),
      (try_for_agents,":possable_agent"),
        (gt,":damage",0),
        (gt,":power",0),
        (agent_is_alive,":possable_agent"),
        (this_or_next|agent_is_ally,":shooter"),
        (agent_is_ally,":possable_agent"),
        (this_or_next|neg|agent_is_ally,":possable_agent"),
        (neg|agent_is_ally,":shooter"),

        (agent_get_position,pos3,":possable_agent"),
        (get_distance_between_positions,":dist",pos5,pos3),
        (le,":dist",":max_range"),
        (assign,":agent",":possable_agent"),
        
        (val_add,":power",-1),
        (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":max_damage", freeze, ":power", ":power"),
        (try_begin),
          (agent_has_item_equipped,":shooter","itm_magic_book_2"),
          (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":max_damage", freeze, ":power", ":power"),
        (try_end),
        (assign,":max_damage",":damage_add"),
      (try_end),
      
      (position_move_z, pos5, 200),
      (play_sound_at_position, "snd_cannon_shot", pos5),          
      (try_for_range, ":unused", 0, ":add_missile"),
        (copy_position, pos2, pos5),
        (store_random_in_range, ":x_offset", 1, 61),#Random Rotation of X
        (position_rotate_x, pos2, ":x_offset"),    
        (store_random_in_range, ":y_offset", 1, 361),#Random Rotation of Y
        (position_rotate_y, pos2, ":y_offset"),    
        (store_random_in_range, ":z_offset", 1, 361),#Random Rotation of Z
        (position_rotate_z, pos2, ":z_offset"),   
        (set_fixed_point_multiplier,10),
        (add_missile, ":shooter", pos2, 100, ":weapon", 0, "itm_magic_ice_ray_dummy", 0),
      (try_end),    
    (else_try),  
      (eq,":cast_spell","itm_magic_blizzard"),
      
      (try_begin),
        (store_mul,":damage",":power", 4),
        (val_add,":damage",5),
        (assign,":range",100),
        (store_mul,":range_add",":power", 15),
        (val_add,":range",":range_add"),
      (try_end),
      
      (try_for_range,":unused",0,":damage"),
        (assign, ":cost_stamina", 2),
        (try_begin),
          (agent_get_slot, ":stamina", ":shooter", slot_agent_mana),
          (ge, ":stamina", ":cost_stamina"),
          (val_sub, ":stamina", ":cost_stamina"),
          (agent_set_slot, ":shooter", slot_agent_mana, ":stamina"),
        (try_end),
        (copy_position,pos4,pos5),
        (store_random_in_range, ":posx", -15,16),
        (store_random_in_range, ":posy", -15,16),
        (store_random_in_range, ":posz", 30,70),
        (val_mul,":posx",50),
        (val_mul,":posy",50),
        (val_mul,":posz",100),
        (position_move_x,pos4,":posx"),
        (position_move_y,pos4,":posy"),
        (position_move_z,pos4,":posz"),
        #(position_move_z,pos5,":posz"),
        (add_missile, ":shooter", pos4, 0, ":weapon", 0, "itm_magic_ice_ray_dummy", 0),
        (try_begin),
          (eq, "$g_weapon_fire_particle", 0),
          (gt,":damage",0),
          (particle_system_burst, "psys_Ice_Storm", pos4, 5),
        (else_try),  
          (gt,":damage",0),
          (particle_system_burst, "psys_Ice_Storm", pos4, 1),
        (try_end),
        (try_for_agents,":possable_agent"),
          (gt,":damage",0),
          (gt,":power",0),
          (agent_is_alive,":possable_agent"),
          (this_or_next|agent_is_ally,":shooter"),
          (agent_is_ally,":possable_agent"),
          (this_or_next|neg|agent_is_ally,":possable_agent"),
          (neg|agent_is_ally,":shooter"),

          (agent_get_position,pos3,":possable_agent"),
          (get_distance_between_positions,":dist",pos4,pos3),
          (le,":dist",250),
          (assign,":agent",":possable_agent"),
          (val_add,":power",-1),
          (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", 200, freeze, ":power", 5),
        (try_end),
      (try_end),
    (else_try),  
      (eq,":cast_spell","itm_magic_ice_ray_dummy"),
      (try_begin),
        (assign,":max_range",150),
        (assign,":damage",50),
        (store_mul,":damage_add",":power", 50),
        (store_add,":max_damage",":damage",":damage_add"),
        (store_mul,":range_add",":power", 10),
        (val_add,":max_range",":range_add"),
      (try_end),
      (try_begin),
        (eq, "$g_weapon_fire_particle", 0),
        (gt,":damage",0),
        (particle_system_burst, "psys_Freezing_Trail", pos5, 15),
      (else_try),  
        (gt,":damage",0),
        (particle_system_burst, "psys_Freezing_Trail", pos5, 3),
      (try_end),
      (try_for_agents,":possable_agent"),
        (gt,":max_damage",0),
        (gt,":power",0),
        (agent_is_alive,":possable_agent"),
        (this_or_next|agent_is_ally,":shooter"),
        (agent_is_ally,":possable_agent"),
        (this_or_next|neg|agent_is_ally,":possable_agent"),
        (neg|agent_is_ally,":shooter"),

        (agent_get_position,pos3,":possable_agent"),
        (get_distance_between_positions,":dist",pos5,pos3),
        (le,":dist",":max_range"),
        (assign,":agent",":possable_agent"),
        
        (val_add,":power",-1),
        
        (try_begin),
          (agent_has_item_equipped,":shooter","itm_magic_book_3"),
          (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":max_damage", freeze, ":power", 5),
        (else_try),  
          (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":max_damage", ice, ":power", 5),
        (try_end),
      (try_end),
    (else_try),  
      (eq,":cast_spell","itm_magic_ice_ray"),
      (try_begin),
        (eq, ":weapon", "itm_warlock_staff_1"),
        (val_add,":power",1),
      (else_try),
        (eq, ":weapon", "itm_thunder_staff_1"),
        (val_add,":power",2),
      (try_end),
      
      (try_begin),
        (assign,":max_range",100),
        (assign,":damage",50),
        (store_mul,":range_add",":power", 20),
        (store_mul,":damage_add",":power", 100),
        (val_add,":max_range",":range_add"),
        (store_add,":max_damage",":damage",":damage_add"),
      (try_end),
      
      (copy_position,pos6,pos5),
      (position_move_z,pos6,200),
      (particle_system_burst, "psys_frost_nails", pos6, 5),
      (try_for_agents,":possable_agent"),
        (gt,":damage",0),
        (gt,":power",0),
        (agent_is_alive,":possable_agent"),
        (this_or_next|agent_is_ally,":shooter"),
        (agent_is_ally,":possable_agent"),
        (this_or_next|neg|agent_is_ally,":possable_agent"),
        (neg|agent_is_ally,":shooter"),

        (agent_get_position,pos3,":possable_agent"),
        (get_distance_between_positions,":dist",pos5,pos3),
        (le,":dist",":max_range"),
        (assign,":agent",":possable_agent"),
        
        (val_add,":power",-1),
        (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":max_damage", ice, ":power", ":power"),
        
        (try_begin),
          (agent_has_item_equipped,":shooter","itm_magic_book_3"),
          (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":max_damage", freeze, ":power", 5),
        (else_try),  
          (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":max_damage", ice, ":power", 5),
          (assign,":max_damage",50),
        (try_end),
      (try_end),
    (else_try),  
      (eq,":cast_spell","itm_magic_deadly_cold"),
      (try_begin),
        (assign,":max_range",200),
        (assign,":damage",100),
        (store_mul,":range_add",":power", 50),
        (store_mul,":damage_add",":power", 150),
        (val_add,":max_range",":range_add"),
        (store_add,":max_damage",":damage",":damage_add"),
        (store_mul,":dest_damage",":power", 100),
      (try_end),
      
      (try_begin),
        (agent_has_item_equipped,":shooter","itm_magic_book_3"),
        (val_add,":max_range",":range_add"),
      (try_end),

      (copy_position,pos6,pos5),
      (particle_system_burst, "psys_Freezing_Trail", pos6, 5),
      (try_for_agents,":possable_agent"),
        (gt,":damage",0),
        (gt,":power",0),
        (agent_is_alive,":possable_agent"),
        (this_or_next|agent_is_ally,":shooter"),
        (agent_is_ally,":possable_agent"),
        (this_or_next|neg|agent_is_ally,":possable_agent"),
        (neg|agent_is_ally,":shooter"),

        (agent_get_position,pos3,":possable_agent"),
        (get_distance_between_positions,":dist",pos5,pos3),
        (le,":dist",":max_range"),
        (assign,":agent",":possable_agent"),
        
        (val_add,":power",-1),
        (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":max_damage", ice, ":power", ":power"),
        
        (agent_get_troop_id, ":inflicted_troop", ":agent"),
        (store_skill_level, ":defence", skl_magic_defence, ":inflicted_troop"),
        (try_begin),
          (agent_has_item_equipped,":shooter","itm_magic_book_3"),
          (val_add,":defence",-3),
        (try_end),
        (le,":defence",8),
        (troop_get_slot, ":inflicted_troop_max_hp", ":inflicted_troop", slot_troop_max_hp),
            
        (store_random_in_range, ":random_no", 0, ":inflicted_troop_max_hp"),
        (store_agent_hit_points, ":inflicted_agent_hp", ":agent", 1),
            
        (this_or_next|ge,":random_no", ":inflicted_agent_hp"),
        (ge, ":dest_damage", ":inflicted_troop_max_hp"),
        (agent_set_hit_points,":agent",0,0),
        (agent_deliver_damage_to_agent, ":shooter", ":agent", 100),
      (try_end),
    (else_try),  
      (eq,":cast_spell","itm_magic_dispel_magic"),
      
      (try_begin),
        (assign,":max_range",100),
        (store_mul,":range_add",":power", 50),
        (val_add,":max_range",":range_add"),
      (try_end),
      
      (copy_position,pos6,pos5),
      (position_move_z,pos6,200),
      (particle_system_burst, "psys_frost_nails", pos6, 5),
      (try_for_agents,":possable_agent"),
        (agent_is_alive,":possable_agent"),
        (this_or_next|agent_is_ally,":shooter"),
        (agent_is_ally,":possable_agent"),
        (this_or_next|neg|agent_is_ally,":possable_agent"),
        (neg|agent_is_ally,":shooter"),

        (agent_get_position,pos3,":possable_agent"),
        (get_distance_between_positions,":dist",pos5,pos3),
        (le,":dist",":max_range"),
        (assign,":agent",":possable_agent"),
        
        (agent_get_slot, ":special", ":agent", slot_agent_special_ability_affect_type),
        (assign, ":continue", 0),
        (try_begin),
          (this_or_next|agent_is_ally,":shooter"),
          (agent_is_ally,":agent"),
          (this_or_next|neg|agent_is_ally,":agent"),
          (neg|agent_is_ally,":shooter"),      
          (this_or_next|eq,":special", divine_strength),
          (this_or_next|eq,":special", haste),
          (this_or_next|eq,":special", regeneration),
          (this_or_next|eq,":special", haste_reload),
          (this_or_next|eq,":special", berserk),
          (this_or_next|eq,":special", battlecry),
          (this_or_next|eq,":special", inspire),
          (agent_slot_ge, ":agent", slot_agent_spawned, 1), 
          (assign, ":continue", 1),
        (else_try),
          (this_or_next|agent_is_ally,":shooter"),
          (neg|agent_is_ally,":agent"),
          (this_or_next|agent_is_ally,":agent"),
          (neg|agent_is_ally,":shooter"),
          (this_or_next|eq,":special", weakness),
          (this_or_next|eq,":special", slow),
          (this_or_next|eq,":special", mummy_curse),
          (this_or_next|eq,":special", entangle),
          (this_or_next|eq,":special", warcry),
          (this_or_next|eq,":special", grasp),
          (this_or_next|eq,":special", fright_aura),
          (agent_slot_ge, ":agent", slot_agent_special_damage_time, 1), 
          (assign, ":continue", 2),
        (try_end),
        (ge, ":continue", 1),
        
        (agent_get_slot, ":special", ":agent", slot_agent_special_ability_affect_type),
        (try_begin),
          (eq, ":continue", 1),
          (agent_set_slot, ":agent", slot_agent_special_ability_affect_type, 0),
          (agent_set_slot, ":agent", slot_agent_special_ability_affect_time, 0),
        (else_try),
          (eq, ":continue", 2),
          (neg|agent_slot_eq, ":agent", slot_agent_is_running_away, 0),
          (agent_stop_running_away, ":agent"),
          (agent_clear_scripted_mode,":agent"),
          (agent_set_slot, ":agent",  slot_agent_is_running_away, 0),
          (agent_set_slot, ":agent", slot_agent_special_ability_affect_type, 0),
          (agent_set_slot, ":agent", slot_agent_special_ability_affect_time, 0),
          (agent_set_slot, ":agent", slot_agent_special_damage_type, 0),
          (agent_set_slot, ":agent", slot_agent_special_damage_power, 0),
          (agent_set_slot, ":agent", slot_agent_special_damage_time, 0),
        (try_end),   
        (agent_play_sound, ":agent", "snd_spell_dispel"),
        (try_begin),
          (this_or_next|agent_is_ally,":shooter"),
          (agent_is_ally,":agent"),
          (this_or_next|neg|agent_is_ally,":agent"),
          (neg|agent_is_ally,":shooter"),      
          (agent_slot_ge, ":agent", slot_agent_spawned, 1), 
          (agent_fade_out, ":agent"),
        (try_end),      
      (try_end),
    (else_try),  
      (eq,":cast_spell","itm_magic_spark"),
      (try_begin),
        (assign,":max_range",100),
        (assign,":damage",50),
        (store_mul,":range_add",":power", 20),
        (store_mul,":damage_add",":power", 60),
        (val_add,":max_range",":range_add"),
        (store_add,":max_damage",":damage",":damage_add"),
      (try_end),
      
        (try_begin),
          (agent_has_item_equipped,":shooter","itm_magic_book_2"),
          (val_add,":max_range",":range_add"),
          (val_add,":max_range",":damage_add"),
        (try_end),
      
      (copy_position,pos6,pos5),
      (position_move_z,pos6,150),
        (particle_system_burst, "psys_spark_explosion_small", pos6, 5),
      (try_for_agents,":possable_agent"),
        (gt,":damage",0),
        (gt,":power",0),
        (agent_is_alive,":possable_agent"),
        (this_or_next|agent_is_ally,":shooter"),
        (agent_is_ally,":possable_agent"),
        (this_or_next|neg|agent_is_ally,":possable_agent"),
        (neg|agent_is_ally,":shooter"),

        (agent_get_position,pos3,":possable_agent"),
        (get_distance_between_positions,":dist",pos5,pos3),
        (le,":dist",":max_range"),
        (assign,":agent",":possable_agent"),
        
        (try_begin),
          (agent_has_item_equipped,":shooter","itm_magic_book_2"),
          (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":max_damage", thunder, ":power", ":power"),
        (else_try),
          (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":max_damage", thunder, ":power", ":power"),
          (assign,":max_damage",100),
        (try_end),
      (try_end),
    (else_try),  
      (eq,":cast_spell","itm_magic_teleport"),
      (try_begin),
        (assign,":max_range",100),
        #(assign,":damage",60),
        (assign,":damage",30),
        (store_random_in_range, ":randon_damage", 25, 36),
        (store_mul,":range_add",":power", 20),
        (store_mul,":damage_add",":power", ":randon_damage"),
        (val_add,":max_range",":range_add"),
        (val_add,":damage",":damage_add"),
      (try_end),
      
      (try_begin),
        (eq, ":weapon", "itm_bishop_staff"),
        (store_mul,":damage_add",":power", 10),
        (val_add,":damage",":damage_add"),
      (else_try),
        (eq, ":weapon", "itm_bishop_staff_2"),
        (store_mul,":damage_add",":power", 20),
        (val_add,":damage",":damage_add"),
      (try_end),
      
      (try_for_agents,":possable_agent"),
        (gt,":damage",0),
        (gt,":power",0),
        (agent_is_alive,":possable_agent"),
        (this_or_next|agent_is_ally,":shooter"),
        (agent_is_ally,":possable_agent"),
        (this_or_next|neg|agent_is_ally,":possable_agent"),
        (neg|agent_is_ally,":shooter"),

        (agent_get_position,pos3,":possable_agent"),
        (copy_position, pos4, pos3),
        
        (get_distance_between_positions,":dist",pos5,pos3),
        (le,":dist",":max_range"),
        
        (assign,":agent",":possable_agent"),
      (try_begin),
        (agent_is_human, ":agent"),
        (agent_is_active, ":agent"),
        (agent_is_alive, ":agent"),
        (agent_set_animation, ":agent", "anim_power_jump", 0),
      (try_end),
        (val_add,":power",-1),
        
        (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":damage", power_jump, ":power", ":power"),
        (agent_set_slot, ":agent", slot_agent_special_damage_type, power_jump),
        (agent_set_slot, ":agent", slot_agent_special_damage_power, ":power"),
        (agent_set_slot, ":agent", slot_agent_special_damage_time, ":power"),
      (try_end),
    (else_try),  
      (eq,":cast_spell","itm_magic_sun_ray"),
      (try_begin),
        (eq, ":weapon", "itm_bishop_staff"),
        (val_add,":power",3),
      (else_try),
        (eq, ":weapon", "itm_war_clerics_warhammer_cast"),
        (val_add,":power",3),
      (else_try),
        (eq, ":weapon", "itm_war_clerics_warhammer_cast_2"),
        (val_add,":power",4),
      (else_try),
        (eq, ":weapon", "itm_bishop_staff_2"),
        (val_add,":power",5),
      (try_end),
      
      (try_begin),
        (assign,":max_range",100),
        (assign,":damage",50),
        (store_mul,":range_add",":power", 50),
        (store_mul,":damage_add",":power", 70),
        (val_add,":max_range",":range_add"),
        (store_add,":damage",":damage_add"),
      (try_end),
      
      (try_begin),
        (eq, "$g_weapon_fire_particle", 0),
        (gt,":damage",0),
        (particle_system_burst, "psys_Burning_Trail_holy", pos5, 15),
      (else_try),  
        (gt,":damage",0),
        (particle_system_burst, "psys_Burning_Trail_holy", pos5, 1),
      (try_end),
      (try_for_agents,":possable_agent"),
        (gt,":damage",0),
        (agent_is_alive,":possable_agent"),
        (this_or_next|agent_is_ally,":shooter"),
        (agent_is_ally,":possable_agent"),
        (this_or_next|neg|agent_is_ally,":possable_agent"),
        (neg|agent_is_ally,":shooter"),

        (agent_get_position,pos3,":possable_agent"),
        (get_distance_between_positions,":dist",pos5,pos3),
        (le,":dist",":max_range"),
        (assign,":agent",":possable_agent"),
        
        (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":damage", holy_fire, ":power", 5),
        (assign,":damage",50),
      (try_end),
    (else_try),  
      (eq,":cast_spell","itm_magic_column_of_fire"),
      (try_begin),
        (eq, ":weapon", "itm_bishop_staff"),
        (val_add,":power",3),
      (else_try),
        (eq, ":weapon", "itm_war_clerics_warhammer_cast"),
        (val_add,":power",3),
      (else_try),
        (eq, ":weapon", "itm_war_clerics_warhammer_cast_2"),
        (val_add,":power",4),
      (else_try),
        (eq, ":weapon", "itm_bishop_staff_2"),
        (val_add,":power",5),
      (try_end),
      
      (try_begin),
        (assign,":max_range",100),
        (assign,":damage",100),
        (store_mul,":range_add",":power", 100),
        (val_add,":max_range",":range_add"),
        (store_mul,":damage_add",":power", 50),
        (store_add,":damage",":damage_add"),
        (store_mul,":spec_power",":power", 3),
      (try_end),
      
      (try_begin),
        (eq, ":weapon", "itm_bishop_staff"),
        (val_add,":max_range",50),
      (else_try),
        (eq, ":weapon", "itm_war_clerics_warhammer_cast"),
        (val_add,":max_range",80),
      (else_try),
        (eq, ":weapon", "itm_war_clerics_warhammer_cast_2"),
        (val_add,":max_range",110),
      (else_try),
        (eq, ":weapon", "itm_bishop_staff_2"),
        (val_add,":max_range",110),
      (try_end),

      (try_begin),
        (gt,":damage",0),
        (copy_position, pos40, pos5),
        (position_move_z, pos40, 400),
        (particle_system_burst, "psys_fright_aura2", pos40, 1),
        #(particle_system_burst, "psys_Freezing_Trail", pos5, 35),
      (try_end),
      (try_for_agents,":possable_agent"),
        (gt,":damage",0),
        (agent_is_alive,":possable_agent"),
        (this_or_next|agent_is_ally,":shooter"),
        (agent_is_ally,":possable_agent"),
        (this_or_next|neg|agent_is_ally,":possable_agent"),
        (neg|agent_is_ally,":shooter"),

        (agent_get_position,pos3,":possable_agent"),
        (get_distance_between_positions,":dist",pos5,pos3),
        (le,":dist",":max_range"),
        (assign,":agent",":possable_agent"),
        
        (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":damage", holy_fire, ":spec_power", ":power"),
      (try_end),
      (position_get_distance_to_ground_level, ":distance", pos5),
      (try_begin),
        (lt, ":distance", 0),
        (position_set_z_to_ground_level, pos5),
        (position_move_z, pos5, 200),
      (try_end),                
      (try_begin),
        (this_or_next|eq,":weapon","itm_grey_knight_staff"),
        (this_or_next|eq,":weapon","itm_dawnbreaker_1"),
        (this_or_next|eq,":weapon","itm_bishop_staff"),
        (this_or_next|eq,":weapon","itm_war_clerics_warhammer_cast"),
        (this_or_next|eq,":weapon","itm_war_clerics_warhammer_cast_2"),
        (eq,":weapon","itm_bishop_staff_2"),        
        (store_mul,":damage",":power", 10),

        (play_sound_at_position, "snd_cannon_shot", pos5),  
        (position_move_z, pos5, 500),
        (particle_system_burst, "psys_explosive_explosion_sparks_a", pos5, 35),
        (particle_system_burst, "psys_explosive_explosion_sparks_b", pos5, 35),
        (try_for_range, ":unused", 0, ":damage"),
          (copy_position, pos2, pos5),
          (store_random_in_range, ":x_offset", 1, 361),#Random Rotation of X
          (position_rotate_x, pos2, ":x_offset"),    
          (store_random_in_range, ":y_offset", 1, 361),#Random Rotation of Y
          (position_rotate_y, pos2, ":y_offset"),    
          (store_random_in_range, ":z_offset", 1, 361),#Random Rotation of Z
          (position_rotate_z, pos2, ":z_offset"),   
          (set_fixed_point_multiplier,10),
          (add_missile, ":shooter", pos2, 1000, ":weapon", 0, "itm_magic_sun_ray_dummy", 0),
        (try_end),    
      (try_end),    
    (else_try),  
      (eq,":cast_spell","itm_magic_entangling"),
      (try_begin),
        (assign,":max_range",50),
        (store_mul,":range_add",":power", 50),
        (val_add,":max_range",":range_add"),
        (store_mul,":spec_time",":power", 5),
      (try_end),
      (try_for_agents,":possable_agent"),
        (agent_is_active,":possable_agent"),
        (agent_is_alive,":possable_agent"),   
        (agent_get_position,pos6,":possable_agent"),
        (get_distance_between_positions,":dist",pos5,pos6),
        (lt,":dist",":max_range"),          	
        (try_begin),
          (agent_is_human, ":possable_agent"),
          (this_or_next|agent_is_ally,":shooter"),
          (agent_is_ally,":possable_agent"),
          (this_or_next|neg|agent_is_ally,":possable_agent"),
          (neg|agent_is_ally,":shooter"), 
          
          (agent_get_slot, ":special", ":possable_agent", slot_agent_special_ability_affect_type),
          (neg|eq,":special", stoneskin),
          (neg|eq,":special", holy_light),
           
          (position_move_z, pos62, 200),
          (particle_system_burst,"psys_stun_effect",pos62,1),
          (agent_set_animation, ":possable_agent", "anim_bash_knocked"),  
          (agent_set_slot, ":possable_agent", slot_agent_special_ability_affect_type, entangle),
          (agent_set_slot, ":possable_agent", slot_agent_special_ability_affect_time, ":spec_time"),
          (get_player_agent_no,":player_agent"),
          (try_begin),
            (eq, ":player_agent", ":possable_agent"),
            (str_store_troop_name, s1, ":troop_no"),
            (display_message, "@you are entangle by {s1}.", 0xFF0000),
          (try_end),
        (else_try),
          (neg|agent_is_human, ":possable_agent"),#stop if not human
          (agent_get_rider,":rider_agent",":possable_agent"),
          (assign, ":continue", 0),
          (try_begin),
            (gt,":rider_agent",-1),
            (agent_is_ally, ":rider_agent"),
            (neg|agent_is_ally, ":shooter"),
            (assign, ":continue", 1),
          (else_try),
            (gt,":rider_agent",-1),
            (neg|agent_is_ally, ":rider_agent"),
            (agent_is_ally, ":shooter"),
            (assign, ":continue", 1),
          (else_try),
            (le,":rider_agent",-1),
            (assign, ":continue", 1),
          (try_end),
          (eq, ":continue", 1),

          (agent_set_hit_points,":possable_agent",0,0),
          (agent_deliver_damage_to_agent,":shooter",":possable_agent"),
        (try_end),
      (try_end),
    (else_try),  
      (eq,":cast_spell","itm_magic_web"),
      (try_begin),
        (assign,":max_range",200),
        (store_mul,":range_add",":power", 100),
        (val_add,":max_range",":range_add"),
      (try_end),
      
      (try_for_agents,":possable_agent"),
        (agent_is_active,":possable_agent"),
        (agent_is_alive,":possable_agent"),   
        (agent_get_position,pos6,":possable_agent"),
        (get_distance_between_positions,":dist",pos5,pos6),
        (lt,":dist",":max_range"),          	
        (try_begin),
          (agent_is_human, ":possable_agent"),
          (this_or_next|agent_is_ally,":shooter"),
          (agent_is_ally,":possable_agent"),
          (this_or_next|neg|agent_is_ally,":possable_agent"),
          (neg|agent_is_ally,":shooter"), 
          
          (agent_get_slot, ":special", ":possable_agent", slot_agent_special_ability_affect_type),
          (neg|eq,":special", stoneskin),
          (neg|eq,":special", holy_light),
           
          (position_move_z, pos62, 200),
          (particle_system_burst,"psys_stun_effect",pos62,1),
          (agent_set_animation, ":possable_agent", "anim_bash_knocked"),  
          (agent_set_slot, ":possable_agent", slot_agent_special_ability_affect_type, entangle),
          (agent_set_slot, ":possable_agent", slot_agent_special_ability_affect_time, 3),
          (get_player_agent_no,":player_agent"),
          (try_begin),
            (eq, ":player_agent", ":possable_agent"),
            (str_store_troop_name, s1, ":troop_no"),
            (display_message, "@you are entangle by {s1}.", 0xFF0000),
          (try_end),
        (else_try),
          (neg|agent_is_human, ":possable_agent"),#stop if not human
          (agent_get_rider,":rider_agent",":possable_agent"),
          (assign, ":continue", 0),
          (try_begin),
            (gt,":rider_agent",-1),
            (agent_is_ally, ":rider_agent"),
            (neg|agent_is_ally, ":shooter"),
            (assign, ":continue", 1),
          (else_try),
            (gt,":rider_agent",-1),
            (neg|agent_is_ally, ":rider_agent"),
            (agent_is_ally, ":shooter"),
            (assign, ":continue", 1),
          (else_try),
            (le,":rider_agent",-1),
            (assign, ":continue", 1),
          (try_end),
          (eq, ":continue", 1),

          (agent_set_hit_points,":possable_agent",0,0),
          (agent_deliver_damage_to_agent,":shooter",":possable_agent"),
        (try_end),
      (try_end),
    (else_try),  
      (eq,":cast_spell","itm_magic_pyroblast"),
      (try_begin),
        (assign,":max_range",200),
        (assign,":damage",200),

        (store_mul,":range_add",":power", 50),
        (store_mul,":damage_add",":power", 100),
        (val_add,":max_range",":range_add"),
        (store_add,":max_damage",":damage",":damage_add"),
        (store_div,":spec_power",":power", 2),
        (val_add,":spec_power",1),
        (store_div,":spec_time",":power", 3),
        (val_add,":spec_time",2),
      (try_end),
      (copy_position,pos6,pos5),
      (position_move_z,pos6,150),
      (try_begin),
        (eq, "$g_weapon_fire_particle", 0),
        (gt,":damage",0),
        (gt,":power",0),
        (particle_system_burst, "psys_flame_explosion",pos5,50),
        (particle_system_burst, "psys_explosive_explosion_sparks_a", pos5, 35),
        (particle_system_burst, "psys_incediary_cloud", pos5, 35),
      (else_try),  
        (gt,":damage",0),
        (gt,":power",0),
        (particle_system_burst, "psys_flame_explosion",pos5,5),
        (particle_system_burst, "psys_explosive_explosion_sparks_a", pos5, 5),
        (particle_system_burst, "psys_incediary_cloud", pos5, 5),
      (try_end),
      (try_for_agents,":possable_agent"),
        (gt,":damage",0),
        (agent_is_alive,":possable_agent"),
        (this_or_next|agent_is_ally,":shooter"),
        (agent_is_ally,":possable_agent"),
        (this_or_next|neg|agent_is_ally,":possable_agent"),
        (neg|agent_is_ally,":shooter"),

        (agent_get_position,pos3,":possable_agent"),
        (get_distance_between_positions,":dist",pos5,pos3),
        (le,":dist",":max_range"),
        (assign,":agent",":possable_agent"),
        (try_begin),
          (agent_has_item_equipped,":shooter","itm_magic_book_4"),
          (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":max_damage", severe_burn, ":spec_power", ":spec_time"),        
        (try_end),
        
        
        (val_add,":spec_time",-1),
        (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":max_damage", severe_burn, ":spec_power", ":spec_time"),        
      (try_end),
    (else_try),  
      (eq,":cast_spell","itm_magic_fireball"),
      (try_begin),
        (eq, ":weapon", "itm_warlock_staff_1"),
        (val_add,":power",1),
      (else_try),
        (eq, ":weapon", "itm_thunder_staff_1"),
        (val_add,":power",1),
      (else_try),
        (eq, ":weapon", "itm_pit_lord_sword"),
        (val_add,":power",3),
      (else_try),
        (eq, ":weapon", "itm_balor_sword"),
        (val_add,":power",2),
      (try_end),
      (try_begin),
        (assign,":max_range",300),
        (assign,":damage",200),
        (store_random_in_range, ":randon_damage", 50, 75),
        (store_mul,":range_add",":power", 60),
        (store_mul,":damage_add",":power", ":randon_damage"),
        (val_add,":max_range",":range_add"),
        (store_add,":max_damage",":damage",":damage_add"),
        (store_mul,":spec_power",":power", 2),
      (try_end),
       
      (copy_position,pos6,pos5),
      (position_move_z,pos6,50),
      (try_begin),
        (eq, "$g_weapon_fire_particle", 0),
        (gt,":damage",0),
        (gt,":power",0),
        (particle_system_burst, "psys_flame_explosion",pos6,50),
        (particle_system_burst, "psys_explosive_explosion_sparks_a", pos6, 35),
        (particle_system_burst, "psys_explosive_explosion_sparks_b", pos6, 35),
      (else_try),  
        (gt,":damage",0),
        (gt,":power",0),
        (particle_system_burst, "psys_flame_explosion",pos6,5),
        (particle_system_burst, "psys_explosive_explosion_sparks_a", pos6, 5),
        (particle_system_burst, "psys_explosive_explosion_sparks_b", pos6, 5),
      (try_end),
      (try_for_agents,":possable_agent"),
        (gt,":damage",0),
        (agent_is_alive,":possable_agent"),
        (this_or_next|agent_is_ally,":shooter"),
        (agent_is_ally,":possable_agent"),
        (this_or_next|neg|agent_is_ally,":possable_agent"),
        (neg|agent_is_ally,":shooter"),

        (agent_get_position,pos3,":possable_agent"),
        (get_distance_between_positions,":dist",pos5,pos3),
        (le,":dist",":max_range"),
        (assign,":agent",":possable_agent"),
        (val_add,":power",-1),
        (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":max_damage", burn, ":spec_power", ":power"),
        (try_begin),
          (agent_has_item_equipped,":shooter","itm_magic_book_2"),
          (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":max_damage", burn, ":spec_power", ":power"),
        (try_end),
      (try_end),
    (else_try),  
      (eq,":cast_spell","itm_magic_fireball_2"),
      (try_begin),
        (assign,":max_range",300),
        (assign,":damage",150),
        (store_mul,":range_add",":power", 50),
        (store_mul,":damage_add",":power", 60),
        (val_add,":max_range",":range_add"),
        (store_add,":max_damage",":damage",":damage_add"),
        (store_mul,":spec_power",":power", 2),

        (store_mul,":add_missile",":power", 1),
        (val_add,":add_missile",1),
      (try_end),
        (try_begin),
          (agent_has_item_equipped,":shooter","itm_magic_book_2"),
          (val_mul,":add_missile",2),
        (try_end),
        
      (position_get_distance_to_ground_level, ":distance", pos5),
      (try_begin),
        (lt, ":distance", 0),
        (position_set_z_to_ground_level, pos5),
        (position_move_z, pos5, 200),
      (try_end),                
      (try_begin),
        (eq, "$g_weapon_fire_particle", 0),
        (gt,":damage",0),
        (gt,":power",0),
        (particle_system_burst, "psys_flame_explosion",pos5,50),
        (particle_system_burst, "psys_explosive_explosion_sparks_a", pos5, 35),
        (particle_system_burst, "psys_explosive_explosion_sparks_b", pos5, 35),
      (else_try),  
        (gt,":damage",0),
        (gt,":power",0),
        (particle_system_burst, "psys_flame_explosion",pos5,5),
        (particle_system_burst, "psys_explosive_explosion_sparks_a", pos5, 5),
        (particle_system_burst, "psys_explosive_explosion_sparks_b", pos5, 5),
      (try_end),
      (try_for_agents,":possable_agent"),
        (gt,":damage",0),
        (gt,":power",0),
        (agent_is_alive,":possable_agent"),
        (this_or_next|agent_is_ally,":shooter"),
        (agent_is_ally,":possable_agent"),
        (this_or_next|neg|agent_is_ally,":possable_agent"),
        (neg|agent_is_ally,":shooter"),

        (agent_get_position,pos3,":possable_agent"),
        (get_distance_between_positions,":dist",pos5,pos3),
        (le,":dist",":max_range"),
        (assign,":agent",":possable_agent"),
        
        (val_add,":power",-1),
        (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":max_damage", burn, ":spec_power", ":power"),
      (try_end),
      
      
      (play_sound_at_position, "snd_cannon_shot", pos5),          
      (position_move_z, pos5, 150),
      (try_for_range, ":unused", 0, ":add_missile"),
        (copy_position, pos2, pos5),
        (store_random_in_range, ":x_offset", 1, 361),#Random Rotation of X
        (position_rotate_x, pos2, ":x_offset"),    
        (store_random_in_range, ":y_offset", 1, 361),#Random Rotation of Y
        (position_rotate_y, pos2, ":y_offset"),    
        (store_random_in_range, ":z_offset", -10, 11),#Random Rotation of Z
        (position_rotate_z, pos2, ":z_offset"),   
        (set_fixed_point_multiplier,10),
        (add_missile, ":shooter", pos2, 80, ":weapon", 0, "itm_magic_poison_dummy", 0),
      (try_end),    
    (else_try),  
      (eq,":cast_spell","itm_magic_poison_dummy"),
      (try_begin),
        (assign,":max_range",300),
        (assign,":damage",100),
        (store_mul,":range_add",":power", 30),
        (store_mul,":damage_add",":power", 50),
        (val_add,":max_range",":range_add"),
        (store_add,":max_damage",":damage",":damage_add"),
      (try_end),
      
      
      (try_begin),
        (agent_has_item_equipped,":shooter","itm_magic_book_4"),
        (val_add,":max_damage",":damage_add"),
        (val_add,":max_range",":range_add"),
      (try_end),
      
      (try_begin),
        (eq, "$g_weapon_fire_particle", 0),
        (gt,":damage",0),
        (gt,":power",0),
         (particle_system_burst,"psys_bomb_fire_1",pos5,35),
         (particle_system_burst,"psys_Burning_Trail",pos5,50),
      (else_try),  
        (gt,":damage",0),
        (gt,":power",0),
         (particle_system_burst,"psys_bomb_fire_1",pos5,5),
         (particle_system_burst,"psys_Burning_Trail",pos5,5),
      (try_end),
            
      (try_for_agents,":possable_agent"),
        (gt,":damage",0),
        (agent_is_alive,":possable_agent"),
        (this_or_next|agent_is_ally,":shooter"),
        (agent_is_ally,":possable_agent"),
        (this_or_next|neg|agent_is_ally,":possable_agent"),
        (neg|agent_is_ally,":shooter"),

        (agent_get_position,pos3,":possable_agent"),
        (get_distance_between_positions,":dist",pos5,pos3),
        (le,":dist",":max_range"),
        (assign,":agent",":possable_agent"),
        (val_add,":power",-1),
        (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":max_damage", burn, ":power", 10),
         (try_begin),
           (neg|agent_is_human,":agent"),
           (agent_set_animation,":agent","anim_horse_rear"), 
           (agent_play_sound,":agent","snd_metal_hit_high_armor_high_damage"),
           (agent_deliver_damage_to_agent,":shooter",":agent"),
         (try_end),
      (try_end),
    (else_try),  
      (eq,":cast_spell","itm_magic_lightning"),
      (try_begin),
        (assign,":max_range",120),
        (assign,":damage",100),
        (store_random_in_range, ":randon_damage", 25, 101),
        (store_mul,":range_add",":power", 30),
        (store_mul,":damage_add",":power", ":randon_damage"),
        (val_add,":max_range",":range_add"),
        (store_add,":max_damage",":damage",":damage_add"),
      (try_end),
      (try_begin),
        (gt,":damage",0),
        (particle_system_burst, "psys_thunder", pos5, 1),
        (play_sound_at_position, "snd_thunder_hit", pos5),
      (try_end),
      
      (try_for_agents,":possable_agent"),
        (gt,":damage",0),
        (agent_is_alive,":possable_agent"),
        (this_or_next|agent_is_ally,":shooter"),
        (agent_is_ally,":possable_agent"),
        (this_or_next|neg|agent_is_ally,":possable_agent"),
        (neg|agent_is_ally,":shooter"),

        (agent_get_position,pos3,":possable_agent"),
        (get_distance_between_positions,":dist",pos5,pos3),
        (le,":dist",":max_range"),
        (assign,":agent",":possable_agent"),

        (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":max_damage", thunder, ":power", 15),
      (try_end),
    (else_try),  
      (eq,":cast_spell","itm_magic_poison"),
      (try_begin),
        (assign,":max_range",200),
        (assign,":damage",50),
        (store_mul,":range_add",":power", 10),
        (store_mul,":damage_add",":power", 30),
        (val_add,":max_range",":range_add"),
        (store_add,":max_damage",":damage",":damage_add"),
        (store_mul,":spec_power",":power", 3),
      (try_end),
      (try_begin),
        (agent_has_item_equipped,":shooter","itm_magic_book_8"),
        (val_add,":max_range",":range_add"),
        (val_mul,":spec_power",":power", 2),
      (try_end),
      (try_begin),
        (eq, "$g_weapon_fire_particle", 0),
        (gt,":damage",0),
        (particle_system_burst, "psys_poison_cloud", pos5, 30),
      (else_try), 
        (gt,":damage",0),
        (particle_system_burst, "psys_poison_cloud", pos5, 3),
      (try_end),
      (try_for_agents,":possable_agent"),
        (gt,":damage",0),
        (agent_is_alive,":possable_agent"),
        (this_or_next|agent_is_ally,":shooter"),
        (agent_is_ally,":possable_agent"),
        (this_or_next|neg|agent_is_ally,":possable_agent"),
        (neg|agent_is_ally,":shooter"),

        (agent_get_position,pos3,":possable_agent"),
        (get_distance_between_positions,":dist",pos5,pos3),
        (le,":dist",":max_range"),
        (assign,":agent",":possable_agent"),

        #(agent_deliver_damage_to_agent,":shooter",":agent", ":damage"),
        (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":max_damage", poison, ":spec_power", 15),
      (try_end),
    (else_try),  
      (eq,":cast_spell","itm_magic_paralysis_cloud"),
      (try_begin),
        (assign,":max_range",200),
        (assign,":damage",100),
        (store_mul,":range_add",":power", 40),
        (store_mul,":damage_add",":power", 50),
        (val_add,":max_range",":range_add"),
        (store_add,":max_damage",":damage",":damage_add"),
        (store_mul,":spec_power",":power", 3),
      (try_end),
      
      (try_begin),
        (agent_has_item_equipped,":shooter","itm_magic_book_8"),
        (val_add,":max_damage",":damage_add"),
        (val_add,":max_range",":range_add"),
        (val_mul,":spec_power",":power", 2),
      (try_end),
      (try_begin),
        (agent_has_item_equipped,":shooter","itm_magic_book_9"),
        (val_add,":max_damage",":damage_add"),
        (val_add,":max_range",":range_add"),
        (val_mul,":spec_power",":power", 2),
      (try_end),
      
      
        (particle_system_burst, "psys_death_cloud", pos5, 10),
        (agent_play_sound,":shooter","snd_death_cld"),
      
      (try_for_agents,":possable_agent"),
        (gt,":max_damage",0),
        (agent_is_alive,":possable_agent"),
        (this_or_next|agent_is_ally,":shooter"),
        (agent_is_ally,":possable_agent"),
        (this_or_next|neg|agent_is_ally,":possable_agent"),
        (neg|agent_is_ally,":shooter"),

        (agent_get_position,pos3,":possable_agent"),
        (get_distance_between_positions,":dist",pos5,pos3),
        (le,":dist",":max_range"),
        (assign,":agent",":possable_agent"),
        (store_div,":half_damage",":max_damage",2),
        (store_random_in_range, ":damage", ":half_damage",":max_damage"),
        #(agent_deliver_damage_to_agent,":shooter",":agent", ":damage"),
        (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":damage", power_poison, ":power", ":spec_power"),
      (try_end),
    (else_try),  
      (eq,":cast_spell","itm_magic_lightningball"),
      (try_begin),
        (assign,":max_range",300),
        (assign,":damage",90),
        (store_random_in_range, ":randon_damage", 10, 51),
        (store_mul,":range_add",":power", 40),
        (store_mul,":damage_add",":power", ":randon_damage"),
        (val_add,":max_range",":range_add"),
        (store_add,":max_damage",":damage",":damage_add"),
        (store_mul,":spec_power",":power", 2),
      (try_end),
      
      (try_begin),
        (this_or_next|eq, ":shooter_troop", "trp_knight_9_20"),
        (agent_has_item_equipped,":shooter","itm_magic_book_2"),
        (val_add,":max_range",":range_add"),
        (val_mul,":spec_power",":power", 2),
      (try_end),
      
      (try_begin),
        (eq, ":shooter_troop", "trp_knight_9_20"),
        (val_mul,":max_damage",":power", 4),
      (try_end),
      
      
      (copy_position,pos6,pos5),
      (position_move_z,pos6,300),
      (particle_system_burst, "psys_spark_explosion_small", pos6, 5),
      (try_for_agents,":possable_agent"),
        (gt,":damage",0),
        (agent_is_alive,":possable_agent"),
        (this_or_next|agent_is_ally,":shooter"),
        (agent_is_ally,":possable_agent"),
        (this_or_next|neg|agent_is_ally,":possable_agent"),
        (neg|agent_is_ally,":shooter"),

        (agent_get_position,pos3,":possable_agent"),
        (get_distance_between_positions,":dist",pos5,pos3),
        (le,":dist",":max_range"),
        (assign,":agent",":possable_agent"),
        (val_add,":power",-1),
        (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":max_damage", thunder, ":spec_power", ":power"),
      (try_end),
    (else_try),  
      (eq,":cast_spell","itm_magic_lightning_burst"),
      (try_begin),
        (assign,":range",100),
        (store_mul,":range_add",":power", 15),
        (store_div,":damage",":power", 3),
        (val_add,":range",":range_add"),
        (val_add,":damage",1),
      (try_end),
     
      (try_begin),
        (eq, ":shooter_troop", "trp_knight_9_20"),
        (val_add,":damage", 3),
      (try_end),
      
      (copy_position,pos4,pos5),
      (try_for_range,":posz",0,":damage"),
          (store_random_in_range, ":posx", -2,3),
          (store_random_in_range, ":posy", -2,3),
          (val_mul,":posx",20),
          (val_mul,":posy",20),
          (val_mul,":posz",500),
          (position_move_x,pos4,":posx"),
          (position_move_y,pos4,":posy"),
          (position_move_z,pos4,":posz"),
          (add_missile, ":shooter", pos4, 0, ":weapon", 0, "itm_magic_lightningball", 0),
      (try_end),
    (else_try),  
      (eq,":cast_spell","itm_magic_death_cloud"),
      
      (try_begin),
        (assign,":range",100),
        (store_mul,":range_add",":power", 15),
        (store_div,":damage",":power", 3),
        (val_add,":range",":range_add"),
        (val_add,":damage",2),
      (try_end),
      (try_begin),
        (agent_has_item_equipped,":shooter","itm_plague_staff_1"),
        (val_mul,":damage",2),
      (try_end),

      (copy_position,pos4,pos5),
      (try_for_range,":posz",0,":damage"),
        (store_random_in_range, ":posx", -2,3),
        (store_random_in_range, ":posy", -2,3),
        (val_mul,":posx",20),
        (val_mul,":posy",20),
        (try_begin),
          (agent_has_item_equipped,":shooter","itm_plague_staff_1"),
          (val_mul,":posx",5),
          (val_mul,":posy",5),
        (try_end),
        (val_mul,":posz",500),
        (position_move_x,pos4,":posx"),
        (position_move_y,pos4,":posy"),
        (position_move_z,pos4,":posz"),
        (add_missile, ":shooter", pos4, 0, ":weapon", 0, "itm_magic_death_cloud_dummy", 0),
      (try_end),
    (else_try),  
      (eq,":cast_spell","itm_magic_death_cloud_dummy"),
      (try_begin),
        (assign,":max_range",200),
        (assign,":damage",50),
        (store_mul,":range_add",":power", 40),
        (store_mul,":damage_add",":power", 30),
        (val_add,":max_range",":range_add"),
        (store_add,":max_damage",":damage",":damage_add"),
        (store_mul,":spec_power",":power", 3),
      (try_end),
      
        (particle_system_burst, "psys_death_cloud", pos5, 10),
        (agent_play_sound,":shooter","snd_death_cld"),
      
      (try_for_agents,":possable_agent"),
        (gt,":max_damage",0),
        (agent_is_alive,":possable_agent"),
        (this_or_next|agent_is_ally,":shooter"),
        (agent_is_ally,":possable_agent"),
        (this_or_next|neg|agent_is_ally,":possable_agent"),
        (neg|agent_is_ally,":shooter"),

        (agent_get_position,pos3,":possable_agent"),
        (get_distance_between_positions,":dist",pos5,pos3),
        (le,":dist",":max_range"),
        (assign,":agent",":possable_agent"),
        (store_div,":half_damage",":max_damage",2),
        (store_random_in_range, ":damage", ":half_damage",":max_damage"),
        #(agent_deliver_damage_to_agent,":shooter",":agent", ":damage"),
        (try_begin),
          (agent_has_item_equipped,":shooter","itm_magic_book_8"),
          (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":damage", power_poison, ":spec_power", ":power"),
        (else_try),
          (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":damage", poison, ":spec_power", ":power"),
        (try_end),
        (try_begin),
          (agent_has_item_equipped,":shooter","itm_magic_book_9"),
          (store_agent_hit_points, ":inflicted_agent_hp", ":agent", 0),
          (store_mul,":dead_power",":power", 5),
          (ge, ":dead_power", ":inflicted_agent_hp"),
          (agent_set_hit_points,":agent",0,0),
          (agent_deliver_damage_to_agent, ":shooter", ":agent", 100),
        (try_end),
      (try_end),
    (else_try),  
      (eq,":cast_spell","itm_magic_incediary_cloud"),
      (try_begin),
        (eq, ":weapon", "itm_pit_lord_sword"),
        (val_add,":power",3),
      (try_end),
      
      (try_begin),
        (assign,":range",100),
        (store_mul,":range_add",":power", 15),
        (store_div,":damage",":power", 3),
        (val_add,":range",":range_add"),
        (val_add,":damage",1),
      (try_end),
      
      (try_begin),
        (agent_has_item_equipped,":shooter","itm_magic_book_4"),
        (val_mul,":damage",2),
      (try_end),
      (copy_position,pos4,pos5),
      (try_for_range,":posz",0,":damage"),
        (store_random_in_range, ":posx", -2,3),
        (store_random_in_range, ":posy", -2,3),
        (val_mul,":posx",20),
        (val_mul,":posy",20),
        (val_mul,":posz",500),
        (position_move_x,pos4,":posx"),
        (position_move_y,pos4,":posy"),
        (position_move_z,pos4,":posz"),
        (add_missile, ":shooter", pos4, 0, ":weapon", 0, "itm_magic_incediary_cloud_dummy", 0),
      (try_end),
    (else_try),  
      (eq,":cast_spell","itm_magic_incediary_cloud_dummy"),
      (try_begin),
        (eq, ":weapon", "itm_pit_lord_sword"),
        (val_add,":power",3),
      (try_end),
      
      (try_begin),
        (assign,":max_range",200),
        (assign,":damage",50),
        (store_mul,":range_add",":power", 40),
        (store_mul,":damage_add",":power", 40),
        (val_add,":max_range",":range_add"),
        (store_add,":max_damage",":damage",":damage_add"),
        (store_div,":spec_power",":power", 2),
        (val_add,":spec_power",1),
        (store_div,":spec_time",":power", 3),
        (val_add,":spec_time",2),
      (try_end),


      (particle_system_burst, "psys_incediary_cloud", pos5, 10),
      (try_for_agents,":possable_agent"),
        (gt,":max_damage",0),
        (agent_is_alive,":possable_agent"),
        (this_or_next|agent_is_ally,":shooter"),
        (agent_is_ally,":possable_agent"),
        (this_or_next|neg|agent_is_ally,":possable_agent"),
        (neg|agent_is_ally,":shooter"),

        (agent_get_position,pos3,":possable_agent"),
        (get_distance_between_positions,":dist",pos5,pos3),
        (le,":dist",":max_range"),
        (assign,":agent",":possable_agent"),

        (store_div,":half_damage",":max_damage",2),
        (store_random_in_range, ":damage", ":half_damage",":max_damage"),
        #(agent_deliver_damage_to_agent,":shooter",":agent", ":damage"),
        (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":damage", severe_burn, ":spec_power", ":spec_time"),
      (try_end),
    (else_try),  
      (eq,":cast_spell","itm_magic_apocalypse"),
      (try_begin),
        (store_mul,":damage",":power", 6),
        (val_add,":damage",5),
        (assign,":range",100),
        (store_mul,":range_add",":power", 15),
        (val_add,":range",":range_add"),
      (try_end),
      
      (try_begin),
        (agent_has_item_equipped,":shooter","itm_magic_book_4"),
        (val_mul, ":damage", 4),
        (val_add,":range",":range_add"),
      (try_end),
      
      (try_for_range,":unused",0,":damage"),
        (assign, ":cost_stamina", 3),
        (try_begin),
          (agent_get_slot, ":stamina", ":shooter", slot_agent_mana),
          (ge, ":stamina", ":cost_stamina"),
          (val_sub, ":stamina", ":cost_stamina"),
          (agent_set_slot, ":shooter", slot_agent_mana, ":stamina"),
        (else_try),
          (assign, ":power", 1),
        (try_end),
        (copy_position,pos4,pos5),
        (store_random_in_range, ":posx", -25,26),
        (store_random_in_range, ":posy", -25,26),
        (store_random_in_range, ":posz", 30,70),
        (val_mul,":posx",50),
        (val_mul,":posy",50),
        (val_mul,":posz",100),
        (position_move_x,pos4,":posx"),
        (position_move_y,pos4,":posy"),
        (position_move_z,pos4,":posz"),
        #(position_move_z,pos5,":posz"),
        (add_missile, ":shooter", pos4, 0, ":weapon", 0, "itm_magic_fire_ray_dummy", 0),
        (try_begin),
          (eq, "$g_weapon_fire_particle", 0),
          (gt,":damage",0),
          (particle_system_burst, "psys_incediary_cloud", pos4, 5),
        (else_try),  
          (gt,":damage",0),
          (particle_system_burst, "psys_incediary_cloud", pos4, 1),
        (try_end),
        (try_for_agents,":possable_agent"),
          (gt,":damage",0),
          (gt,":power",0),
          (agent_is_alive,":possable_agent"),
          (this_or_next|agent_is_ally,":shooter"),
          (agent_is_ally,":possable_agent"),
          (this_or_next|neg|agent_is_ally,":possable_agent"),
          (neg|agent_is_ally,":shooter"),

          (agent_get_position,pos3,":possable_agent"),
          (get_distance_between_positions,":dist",pos4,pos3),
          (le,":dist",250),
          (assign,":agent",":possable_agent"),
          (val_add,":power",-1),
          (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", 200, severe_burn, ":power", 5),
        (try_end),
      (try_end),
    (else_try),  
      (eq,":cast_spell","itm_magic_fire_ray_dummy"),
      (try_begin),
        (assign,":max_range",150),
        (assign,":damage",50),
        (store_mul,":damage_add",":power", 50),
        (store_add,":max_damage",":damage",":damage_add"),
        (store_mul,":range_add",":power", 20),
        (val_add,":max_range",":range_add"),
      (try_end),
      
      (try_begin),
        (eq, "$g_weapon_fire_particle", 0),
        (gt,":damage",0),
        (particle_system_burst, "psys_Burning_Trail", pos5, 15),
      (else_try),  
        (gt,":damage",0),
        (particle_system_burst, "psys_Burning_Trail", pos5, 3),
      (try_end),
      (try_for_agents,":possable_agent"),
        (gt,":max_damage",0),
        (gt,":power",0),
        (agent_is_alive,":possable_agent"),
        (this_or_next|agent_is_ally,":shooter"),
        (agent_is_ally,":possable_agent"),
        (this_or_next|neg|agent_is_ally,":possable_agent"),
        (neg|agent_is_ally,":shooter"),

        (agent_get_position,pos3,":possable_agent"),
        (get_distance_between_positions,":dist",pos5,pos3),
        (le,":dist",":max_range"),
        (assign,":agent",":possable_agent"),
        
        (val_add,":power",-1),
        (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":max_damage", burn, ":power", 5),
      (try_end),
    (else_try),  
      (eq,":cast_spell","itm_magic_armageddon"),
      
      (try_begin),
        (store_div,":spec_power",":power", 2),
        (val_add,":damage",":spec_power"),
        (val_add,":damage",1),
      (try_end),
            
      (try_begin),
        (agent_has_item_equipped,":shooter","itm_magic_book_7"),
        (val_add,":damage",":spec_power"),
      (try_end),
      
        (copy_position, pos51, pos5),
        (call_script,"script_cf_agent_spawn_agent_to_pos51", ":shooter", "trp_huge_inferno", 1),
        
        (store_mul,":damage_2",":damage", -1),
        (val_add,":damage_2",1),
        (try_for_range,":unused",0,":damage"),
          (copy_position,pos4,pos5),
          (store_random_in_range, ":posx", ":damage_2",":damage"),
          (store_random_in_range, ":posy", ":damage_2",":damage"),
          (store_random_in_range, ":posz", 10,100),
          (val_mul,":posx",50),
          (val_mul,":posy",50),
          (val_mul,":posz",200),
          (position_move_x,pos4,":posx"),
          (position_move_y,pos4,":posy"),
          (position_move_z,pos4,":posz"),
          #(position_move_z,pos5,":posz"),
          (add_missile, ":shooter", pos4, 0, ":weapon", 0, "itm_magic_armageddon_dummy", 0),
        (try_end),
    (else_try),  
      (eq,":cast_spell","itm_magic_armageddon_dummy"),
      (try_begin),
        (assign,":max_range",100),
        (assign,":damage",166),
        (store_mul,":range_add",":power", 50),
        (store_mul,":damage_add",":power", 36),
        (val_add,":max_range",":range_add"),
        (store_add,":max_damage",":damage",":damage_add"),
        (store_div,":spec_power",":power", 2),
        (val_add,":spec_power",1),
      (try_end),
      
      (try_begin),
        (agent_has_item_equipped,":shooter","itm_magic_book_4"),
        (val_mul,":max_damage",2),
        (val_mul,":max_range",2),
      (try_end),
      
      (try_begin),
        (gt,":power",1),
        (eq, "$g_weapon_fire_particle", 0),
        
        (particle_system_burst, "psys_bomb_fire_1", pos5, 20),
        (particle_system_burst, "psys_bomb_smoke", pos5, 20),
        (particle_system_burst, "psys_bomb_dust", pos5, 10),
        
        (copy_position, pos51, pos5),
        (try_begin),
          (agent_has_item_equipped,":shooter","itm_nilfurs_boast"),
          (assign, ":troop", "trp_huge_inferno"),
        (else_try),
          (assign, ":troop", "trp_inferno"),
        (try_end),
        (call_script,"script_cf_agent_spawn_agent_to_pos51", ":shooter", ":troop", 1),
      (try_end),
      (position_move_z,pos5,90),
      (try_for_agents,":possable_agent"),
        (gt,":max_damage",0),
        (agent_is_alive,":possable_agent"),
        (this_or_next|agent_is_ally,":shooter"),
        (agent_is_ally,":possable_agent"),
        (this_or_next|neg|agent_is_ally,":possable_agent"),
        (neg|agent_is_ally,":shooter"),

        (agent_get_position,pos3,":possable_agent"),
        (get_distance_between_positions,":dist",pos5,pos3),
        (le,":dist",":max_range"),
        (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":possable_agent", ":max_damage", severe_burn, ":spec_power", ":power"),
      (try_end),
    (else_try),  
      (eq,":cast_spell","itm_magic_meteor_shower"),
      (try_begin),
        (agent_has_item_equipped,":shooter","itm_nilfurs_boast"),
        (val_mul,":power",2),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":weapon", "itm_pit_lord_sword"),
        (this_or_next|eq, ":weapon", "itm_bishop_staff_2"),
        (eq, ":weapon", "itm_archlich_staff_1"),
        (val_add,":power",3),
      (try_end),
      
      (try_begin),
        (assign,":range",100),
        (assign,":damage",3),
        (val_mul,":damage_add",":power", 2),
        (store_mul,":range_add",":power", 30),
        (val_add,":range",":range_add"),
        (val_add,":damage",":damage_add"),
      (try_end),
      (try_begin),
        (agent_has_item_equipped,":shooter","itm_magic_book_4"),
        (val_add,":range",":range_add"),
        (val_add,":damage",":power"),
      (try_end),
        

        #(val_mul,":damage",2),
        (try_for_range,":unused",0,":damage"),
          (copy_position,pos4,pos5),
          (store_random_in_range, ":posx", -50,51),
          (store_random_in_range, ":posy", -50,51),
          (store_random_in_range, ":posz", 10,100),
          (val_mul,":posx",30),
          (val_mul,":posy",30),
          (val_mul,":posz",100),
          (position_move_x,pos4,":posx"),
          (position_move_y,pos4,":posy"),
          (position_move_z,pos4,":posz"),
          #(position_move_z,pos5,":posz"),
          #(add_missile, ":shooter", pos4, 0, ":weapon", 0, "itm_magic_meteor_shower_dummy", 0),
          (add_missile, ":shooter", pos4, 80, ":weapon", 0, "itm_magic_poison_dummy", 0),
        (try_end),
    (else_try),  
      (eq,":cast_spell","itm_magic_heaven_fist"),
      (try_begin),
        (eq, ":weapon", "itm_bishop_staff"),
        (val_add,":power",2),
      (else_try),
        (eq, ":weapon", "itm_bishop_staff_2"),
        (val_add,":power",3),
      (try_end),
      
      (try_begin),
        (assign,":range",100),
        (assign,":damage",3),
        (store_mul,":range_add",":power", 30),
        (val_add,":range",":range_add"),
        (val_add,":damage",":power"),
        (val_div,":damage",3),
        (val_add,":damage",1),
      (try_end),

      (try_begin),
        (agent_has_item_equipped,":shooter","itm_magic_book_4"),
        (val_add,":range",":range_add"),
        (val_add,":damage",2),
      (try_end),

      (try_begin),
        (eq, ":weapon", "itm_war_clerics_warhammer_cast"),
        (assign,":damage",1),
      (else_try),
        (eq, ":weapon", "itm_war_clerics_warhammer_cast_2"),
        (assign,":damage",1),
      (try_end),
      
        (position_move_z,pos5,500),
        (try_for_range,":posz",0,":damage"),
          (copy_position,pos4,pos5),
          (store_random_in_range, ":posx", -10,11),
          (store_random_in_range, ":posy", -10,11),
          (val_mul,":posx",5),
          (val_mul,":posy",5),
          (val_mul,":posz",100),
          (position_move_x,pos4,":posx"),
          (position_move_y,pos4,":posy"),
          (position_move_z,pos4,":posz"),
          (position_move_z,pos5,":posz"),
          (add_missile, ":shooter", pos4, 0, ":weapon", 0, "itm_magic_heaven_fist_dummy", 0),
        (try_end),
    (else_try),  
      (eq,":cast_spell","itm_magic_heaven_fist_dummy"),
      (try_begin),
        (eq, ":weapon", "itm_bishop_staff"),
        (val_add,":power",1),
      (else_try),
        (eq, ":weapon", "itm_bishop_staff_2"),
        (val_add,":power",2),
      (else_try),
        (eq, ":weapon", "itm_war_clerics_warhammer_cast"),
        (val_add,":power",1),
      (else_try),
        (eq, ":weapon", "itm_war_clerics_warhammer_cast_2"),
        (val_add,":power",2),
      (try_end),
      
      (try_begin),
        (assign,":max_range",100),
        (assign,":damage",50),
        (store_mul,":range_add",":power", 30),
        (store_mul,":damage_add",":power", 30),
        (val_add,":max_range",":range_add"),
        (store_add,":max_damage",":damage",":damage_add"),
        (store_div,":spec_power",":power", 2),
        (val_add,":spec_power",1),
      (try_end),
      
            
      (try_begin),
        (gt,":max_damage",0),
        (particle_system_burst, "psys_holy_fire", pos5, 50),
      (try_end),
      (try_for_agents,":possable_agent"),
        (gt,":max_damage",0),
        (agent_is_alive,":possable_agent"),
        (this_or_next|agent_is_ally,":shooter"),
        (agent_is_ally,":possable_agent"),
        (this_or_next|neg|agent_is_ally,":possable_agent"),
        (neg|agent_is_ally,":shooter"),

        (agent_get_position,pos3,":possable_agent"),
        (get_distance_between_positions,":dist",pos5,pos3),
        (le,":dist",":max_range"),
        (assign,":agent",":possable_agent"),

        (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":max_damage", holy_fire, ":spec_power", ":power"),
      (try_end),
    (else_try),  
      (eq,":cast_spell","itm_magic_summon_blade"),
      
      (assign,":number",10),
      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_necromancy, ":shooter_troop"),
      (val_add,":power",1),
      (val_mul,":number",2),
      (store_mul,":number_2",":number", -1),
      (val_add,":number_2",1),
        
      (try_for_range,":unused",0,":power"),
          (copy_position,pos51,pos5),
          (store_random_in_range, ":posx", ":number_2",":number"),
          (store_random_in_range, ":posy", ":number_2",":number"),
          (val_mul,":posx",50),
          (val_mul,":posy",50),
          (position_move_x,pos51,":posx"),
          (position_move_y,pos51,":posy"),
          (agent_get_slot, ":stamina", ":shooter", slot_agent_mana),
          (ge, ":stamina", 5),
          (val_sub, ":stamina", 5),
          (agent_set_slot, ":shooter", slot_agent_mana, ":stamina"),
          (call_script,"script_cf_agent_spawn_agent_to_pos51", ":shooter", "trp_mercenaries_end", 1),
      (try_end),
      
    (else_try),  
      (eq,":cast_spell","itm_magic_summon_neutral"),
      (assign,":spawn_troop_id",0),
      (assign,":number",0),
      (store_skill_level, ":power", skl_necromancy, ":shooter_troop"),
      (store_character_level,":troop_level",":shooter_troop"),
      (val_mul,":power",5),
      (val_add,":power",":troop_level"),
      (try_begin),
        (ge, ":power", 60),
        (store_random_in_range, ":r", 0, 10),
        (assign,":number",1),
        (try_begin),
          (ge, ":r", 8),
          (assign,":spawn_troop_id","trp_fire_elemental_3"),
        (else_try),
          (ge, ":r", 6),
          (assign,":spawn_troop_id","trp_earth_elemental_3"),
        (else_try),
          (ge, ":r", 4),
          (assign,":spawn_troop_id","trp_water_elemental_3"),
        (else_try),
          (assign,":spawn_troop_id","trp_golem_4"),
        (try_end),
      (else_try),
        (ge, ":power", 40),
        (store_random_in_range, ":r", 0, 10),
        (assign,":number",1),
        (try_begin),
          (ge, ":r", 8),
          (assign,":spawn_troop_id","trp_gargoyle"),
        (else_try),
          (ge, ":r", 6),
          (assign,":spawn_troop_id","trp_earth_elemental_2"),
        (else_try),
          (ge, ":r", 4),
          (assign,":spawn_troop_id","trp_fire_elemental_2"),
        (else_try),
          (assign,":spawn_troop_id","trp_water_elemental_2"),
        (try_end),
      (else_try),
        (ge, ":power", 20),
        (store_random_in_range, ":r", 0, 10),
        (assign,":number",1),
        (try_begin),
          (ge, ":r", 8),
          (assign,":spawn_troop_id","trp_air_elemental_2"),
        (else_try),
          (ge, ":r", 6),
          (assign,":spawn_troop_id","trp_water_elemental"),
        (else_try),
          (ge, ":r", 4),
          (assign,":spawn_troop_id","trp_mercenaries_end"),
          (assign,":number",2),
        (else_try),
          (assign,":spawn_troop_id","trp_golem_3"),
        (try_end),
      (else_try),
        (store_random_in_range, ":r", 0, 10),
        (assign,":number",1),
        (try_begin),
          (eq, ":r", 1),
          (assign,":spawn_troop_id","trp_air_elemental"),
        (else_try),
          (ge, ":r", 8),
          (assign,":spawn_troop_id","trp_golem_1"),
        (else_try),
          (ge, ":r", 6),
          (assign,":spawn_troop_id","trp_firefly"),
          (assign,":number",2),
        (else_try),
          (assign,":spawn_troop_id","trp_dragonfly"),
          (assign,":number",2),
        (try_end),
      (try_end),
      
      (try_begin),
        (eq,"$background_answer_2",cb2_apprentice),
        (eq,"$background_answer_3",cb3_craftsman),
        (lt, ":power", 40),
        (assign,":spawn_troop_id","trp_golem_3"),
        (assign,":number",1),
      (else_try),
        (lt, ":power", 20),
        (eq,"$background_answer_3",cb3_craftsman),
        (assign,":spawn_troop_id","trp_golem_1"),
        (assign,":number",1),
      (try_end),
            
      (try_begin),
        (eq, ":shooter_troop", "trp_grandelf_mage_1"),
        (store_random_in_range, ":r", 0, 10),
        (try_begin),
          (assign, ":spawn_troop_id","trp_earth_elemental_3"),
          (assign,":number",2),
        (else_try),
          (assign, ":spawn_troop_id","trp_earth_elemental_2"),
          (assign,":number",2),
        (try_end),
      (else_try),
        (eq, ":shooter_troop", "trp_grandelf_mage_2"),
        (store_random_in_range, ":r", 0, 10),
        (try_begin),
          (ge, ":r", 6),
          (assign, ":spawn_troop_id","trp_ent_1"),
          (assign,":number",1),
        (else_try),
          (assign, ":spawn_troop_id","trp_pixie"),
          (assign,":number",2),
        (try_end),
      (else_try),
        (eq, ":shooter_troop", "trp_woodelf_druid_2"),
        (store_random_in_range, ":r", 0, 10),
        (try_begin),
          (ge, ":r", 9),
          (store_random_in_range, ":spawn_troop_id","trp_red_dragon","trp_werewolf_1"),
          (assign,":number",1),
        (else_try),
          (ge, ":r", 4),
          (assign, ":spawn_troop_id","trp_ent_2"),
          (assign,":number",1),
        (else_try),
          (store_random_in_range, ":spawn_troop_id","trp_air_elemental_2","trp_air_elemental_3"),
          (assign,":number",2),
        (try_end),
      (else_try),
        (eq, ":shooter_troop", "trp_woodelf_druid_1"),
        (store_random_in_range, ":r", 0, 10),
        (try_begin),
          (ge, ":r", 6),
          (assign, ":spawn_troop_id","trp_ent_2"),
          (assign,":number",1),
        (else_try),
          (ge, ":r", 4),
          (store_random_in_range, ":spawn_troop_id","trp_air_elemental","trp_air_elemental_2"),
          (assign,":number",2),
        (else_try),
          (assign, ":spawn_troop_id","trp_dryad"),
          (assign,":number",3),
        (try_end),
      (else_try),
        (eq, ":shooter_troop", "trp_human_magic_2"),
        (assign,":spawn_troop_id","trp_golem_1"),
        (assign,":number",2),
      (else_try),
        (eq, ":shooter_troop", "trp_human_magic_3"),
        (assign,":spawn_troop_id","trp_golem_3"),
        (assign,":number",2),
      (else_try),
        (eq, ":shooter_troop", "trp_human_magic_4"),
        (assign,":spawn_troop_id","trp_we_recruit"),
        (assign,":number",1),
      (try_end),
      
      (try_begin),
        (agent_has_item_equipped,":shooter","itm_magic_book_5"),
        (store_random_in_range, ":r", 0, 4),
        (assign,":number",2),
        (try_begin),
          (ge, ":r", 1),
          (assign,":spawn_troop_id","trp_fire_elemental_3"),
        (else_try),
          (ge, ":r", 2),
          (assign,":spawn_troop_id","trp_earth_elemental_3"),
        (else_try),
          (ge, ":r", 3),
          (assign,":spawn_troop_id","trp_water_elemental_3"),
        (else_try),
          (assign,":spawn_troop_id","trp_air_elemental_3"),
          (assign,":number",3),
        (try_end),
      (try_end),
      
      (gt,":spawn_troop_id",0),
      (gt,":number",0),
        
        
        (copy_position, pos51, pos5),
        (call_script,"script_cf_agent_spawn_agent_to_pos51", ":shooter", ":spawn_troop_id", ":number"),
    (else_try),  
      (eq,":cast_spell","itm_magic_summon_neutral_near_ememy"),
      (assign,":spawn_troop_id",0),
      (assign,":number",0),
      (store_skill_level, ":power", skl_necromancy, ":shooter_troop"),
      (store_character_level,":troop_level",":shooter_troop"),
      (val_mul,":power",5),
      (val_add,":power",":troop_level"),
      
      (try_begin),
        (ge, ":power", 60),
        (store_random_in_range, ":r", 0, 10),
        (assign,":number",3),
        (try_begin),
          (ge, ":r", 6),
          (assign,":spawn_troop_id","trp_draugr_lord"),
          (assign,":number",2),
        (else_try),
          (ge, ":r", 4),
          (assign,":spawn_troop_id","trp_wight"),
        (else_try),
          (assign,":spawn_troop_id","trp_dullahan"),
        (try_end),
      (else_try),
        (ge, ":power", 45),
        (store_random_in_range, ":r", 0, 10),
        (assign,":number",2),
        (try_begin),
          (ge, ":r", 6),
          (assign,":spawn_troop_id","trp_draugr_lord"),
          (assign,":number",1),
        (else_try),
          (ge, ":r", 4),
          (assign,":spawn_troop_id","trp_wight"),
        (else_try),
          (assign,":spawn_troop_id","trp_dullahan"),
        (try_end),
      (else_try),
        (ge, ":power", 30),
        (store_random_in_range, ":r", 0, 10),
        (assign,":number",1),
        (try_begin),
          (ge, ":r", 6),
          (assign,":spawn_troop_id","trp_dullahan"),
        (else_try),
          (ge, ":r", 4),
          (assign,":spawn_troop_id","trp_skeleton_lord"),
        (else_try),
          (assign,":spawn_troop_id","trp_draugr_3"),
        (try_end),
      (else_try),
        (ge, ":power", 15),
        (store_random_in_range, ":r", 0, 10),
        (assign,":number",2),
        (try_begin),
          (ge, ":r", 8),
          (assign,":spawn_troop_id","trp_draugr_2"),
        (else_try),
          (ge, ":r", 4),
          (assign,":spawn_troop_id","trp_skeleton_warrior"),
          (assign,":number",1),
        (else_try),
          (assign,":spawn_troop_id","trp_zombie_2"),
        (try_end),
      (else_try),
        (store_random_in_range, ":r", 0, 10),
        (assign,":number",2),
          (try_begin),
            (ge, ":r", 8),
            (assign,":spawn_troop_id","trp_draugr_1"),
          (else_try),
            (ge, ":r", 5),
            (assign,":spawn_troop_id","trp_se_billman_1"),
          (else_try),
            (assign,":spawn_troop_id","trp_zombie_1"),
          (try_end),
      (try_end),
      
      (try_begin),
        (eq, ":shooter_troop", "trp_mummy_3"),
        (assign,":spawn_troop_id","trp_mummy_2"),
        (assign,":number",2),
      (else_try),
        (eq, ":shooter_troop", "trp_adventurer_troop_15"),
        (assign,":spawn_troop_id","trp_demon_8"),
        (assign,":number",2),
      (else_try),
        (eq, ":shooter_troop", "trp_adventurer_troop_1"),
        (store_random_in_range, ":r", 0, 10),
        (assign,":number",2),
        (try_begin),
          (ge, ":r", 6),
          (assign,":spawn_troop_id","trp_wight"),
        (else_try),
          (assign,":spawn_troop_id","trp_ghost"),
          (assign,":number",4),
        (try_end),
      (else_try),
        (eq, ":shooter_troop", "trp_polish_which_1"),
        (store_random_in_range, ":r", 0, 10),
        (assign,":number",1),
        (try_begin),
          (ge, ":r", 6),
          (assign,":spawn_troop_id","trp_air_elemental"),
        (else_try),
          (assign,":spawn_troop_id","trp_ghost"),
          (assign,":number",2),
        (try_end),
      (else_try),
        (eq, ":shooter_troop", "trp_polish_which_2"),
        (store_random_in_range, ":r", 0, 10),
        (assign,":number",1),
        (try_begin),
          (ge, ":r", 5),
          (assign,":spawn_troop_id","trp_demon_4"),
        (else_try),
          (assign,":spawn_troop_id","trp_wight"),
          (assign,":number",2),
        (try_end),
      (else_try),
        (this_or_next|eq,":weapon","itm_dragonpriest_staff_1"),
        (this_or_next|eq, ":shooter_troop", "trp_lich_3"),
        (eq, ":shooter_troop", "trp_knight_10_14"),
        (assign,":spawn_troop_id","trp_draugr_lord"),
        (assign,":number",2),
      (else_try),
        (eq, ":shooter_troop", "trp_mummy_4"),
        (store_random_in_range, ":r", 0, 10),
        (assign,":number",2),
        (try_begin),
          (ge, ":r", 9),
          (assign,":spawn_troop_id","trp_werewolf_1_a"),
          (assign,":number",1),
        (else_try),
          (ge, ":r", 7),
          (assign,":spawn_troop_id","trp_werewolf_1"),
        (else_try),
          (ge, ":r", 5),
          (assign,":spawn_troop_id","trp_mummy_2_1"),
        (else_try),
          (assign,":spawn_troop_id","trp_mummy_2"),
        (try_end),
      (try_end),
      
      (try_begin),
        (agent_has_item_equipped,":shooter","itm_magic_book_9"),
        (store_random_in_range, ":r", 0, 10),
        (assign,":number",2),
        (try_begin),
          (ge, ":r", 8),
          (assign,":spawn_troop_id","trp_mummy_4"),
        (else_try),
          (ge, ":r", 5),
          (assign,":spawn_troop_id","trp_werewolf_1_a"),
        (else_try),
          (assign,":spawn_troop_id","trp_mummy_3"),
        (try_end),
      (else_try),
        (agent_has_item_equipped,":shooter","itm_magic_book_6"),
        (store_random_in_range, ":ran", 0, 8),
        (assign,":number",1),
        (try_begin),
          (eq,":ran",0),
          (assign,":spawn_troop_id","trp_lich_2"),
        (else_try),  
          (eq,":ran",1),
          (assign,":spawn_troop_id","trp_ghost_dragon"),
        (else_try),  
          (eq,":ran",2),
          (assign,":spawn_troop_id","trp_lich_dragon"),
        (else_try),  
          (eq,":ran",3),
          (assign,":spawn_troop_id","trp_wraith"),
        (else_try),  
          (eq,":ran",4),
          (assign,":spawn_troop_id","trp_death"),
        (else_try),  
          (eq,":ran",5),
          (assign,":spawn_troop_id","trp_bone_dragon"),
          (assign,":number",2),
        (else_try),  
          (eq,":ran",6),
          (assign,":spawn_troop_id","trp_draugr_lord"),
        (else_try),  
          (eq,":ran",7),
          (assign,":spawn_troop_id","trp_mummy_3"),
        (try_end),  
      (try_end),
      
      
      (gt,":spawn_troop_id",0),
      (gt,":number",0),
        
        
        (copy_position, pos51, pos5),
        (call_script,"script_cf_agent_spawn_agent_to_pos51", ":shooter", ":spawn_troop_id", ":number"),
      
    (else_try),  
      (eq,":cast_spell","itm_magic_summon_demon_near_ememy"),
      (assign,":spawn_troop_id",0),
      (assign,":number",0),
      (store_skill_level, ":power", skl_necromancy, ":shooter_troop"),
      (store_character_level,":troop_level",":shooter_troop"),
      (val_mul,":power",5),
      (val_add,":power",":troop_level"),
      
      (try_begin),
        (ge, ":power", 60),
        (store_random_in_range, ":r", 0, 10),
        (assign,":number",1),
        (try_begin),
          (ge, ":r", 9),
          (assign,":spawn_troop_id","trp_demon_6"),
        (else_try),
          (ge, ":r", 6),
          (assign,":spawn_troop_id","trp_demon_8"),
        (else_try),
          (ge, ":r", 4),
          (assign,":spawn_troop_id","trp_demon_5"),
        (else_try),
          (assign,":spawn_troop_id","trp_demon_human_5_2"),
        (try_end),
      (else_try),
        (ge, ":power", 45),
        (store_random_in_range, ":r", 0, 10),
        (assign,":number",2),
        (try_begin),
          (ge, ":r", 8),
          (assign,":spawn_troop_id","trp_werewolf_1_a"),
        (else_try),
          (ge, ":r", 6),
          (assign,":spawn_troop_id","trp_demon_4_2"),
        (else_try),
          (ge, ":r", 4),
          (assign,":spawn_troop_id","trp_huge_inferno"),
        (else_try),
          (assign,":spawn_troop_id","trp_demon_4"),
        (try_end),
      (else_try),
        (ge, ":power", 30),
        (store_random_in_range, ":r", 0, 10),
        (assign,":number",2),
        (try_begin),
          (ge, ":r", 8),
          (assign,":spawn_troop_id","trp_demon_human_4"),
        (else_try),
          (ge, ":r", 6),
          (assign,":spawn_troop_id","trp_demon_4"),
        (else_try),
          (ge, ":r", 4),
          (assign,":spawn_troop_id","trp_demon_3"),
        (else_try),
          (assign,":spawn_troop_id","trp_inferno"),
        (try_end),
      (else_try),
        (store_random_in_range, ":r", 0, 10),
        (assign,":number",2),
        (try_begin),
          (ge, ":r", 7),
          (assign,":spawn_troop_id","trp_demon_2"),
        (else_try),
          (ge, ":r", 3),
          (assign,":spawn_troop_id","trp_demon_1_2"),
        (else_try),
          (assign,":spawn_troop_id","trp_demon_1"),
        (try_end),
      (try_end),
     
        (try_begin),
          (eq, ":weapon", "itm_pit_lord_sword"),
          (store_random_in_range, ":r", 0, 10),
          (assign,":number",2),
          (try_begin),
            (ge, ":r", 9),
            (assign,":spawn_troop_id","trp_demon_6"),
          (else_try),
            (ge, ":r", 6),
            (assign,":spawn_troop_id","trp_demon_8"),
          (else_try),
            (ge, ":r", 4),
            (assign,":spawn_troop_id","trp_demon_5"),
          (else_try),
            (assign,":spawn_troop_id","trp_demon_human_5_2"),
          (try_end),
        (else_try),
          (eq, ":weapon", "itm_balor_sword"),
          (store_random_in_range, ":r", 0, 10),
          (assign,":number",2),
          (try_begin),
            (ge, ":r", 8),
            (assign,":spawn_troop_id","trp_demon_4_2"),
          (else_try),
            (ge, ":r", 6),
            (assign,":spawn_troop_id","trp_werewolf_1_a"),
          (else_try),
            (ge, ":r", 4),
            (assign,":spawn_troop_id","trp_huge_inferno"),
          (else_try),
            (assign,":spawn_troop_id","trp_demon_4"),
          (try_end),
        (else_try),
          (eq, ":weapon", "itm_mark_chaos_1"),
          (store_random_in_range, ":r", 0, 10),
          (assign,":number",1),
          
          (try_begin),
            (ge, ":r", 8),
            (assign,":spawn_troop_id","trp_demon_4_2"),
          (else_try),
            (ge, ":r", 6),
            (assign,":spawn_troop_id","trp_werewolf_1_a"),
          (else_try),
            (ge, ":r", 4),
            (assign,":spawn_troop_id","trp_huge_inferno"),
          (else_try),
            (assign,":spawn_troop_id","trp_demon_4"),
          (try_end),
        (else_try),
          (eq, ":weapon", "itm_shaman_staff_1"),
          (assign,":spawn_troop_id","trp_fire_elemental"),
          (assign,":number",2),
        (else_try),
          (eq, ":weapon", "itm_sorcerer_staff_1"),
          (store_random_in_range, ":r", 0, 10),
          (try_begin),
            (ge, ":r", 8),
            (assign,":spawn_troop_id","trp_demon_4"),
            (assign,":number",1),
          (else_try),
            (ge, ":r", 6),
            (assign,":spawn_troop_id","trp_demon_3"),
            (assign,":number",1),
          (else_try),
            (ge, ":r", 3),
            (assign,":spawn_troop_id","trp_demon_1_2"),
            (assign,":number",2),
          (else_try),
            (assign,":spawn_troop_id","trp_demon_1"),
            (assign,":number",2),
          (try_end),
        (else_try),
          (eq, ":weapon", "itm_demon_staff_1"),
          (store_random_in_range, ":r", 0, 10),
          (try_begin),
            (eq, ":r", 9),
            (assign,":spawn_troop_id","trp_demon_4_2"),
            (assign,":number",1),
          (else_try),
            (eq, ":r", 8),
            (assign,":spawn_troop_id","trp_werewolf_1_a"),
            (assign,":number",1),
          (else_try),
            (ge, ":r", 6),
            (assign,":spawn_troop_id","trp_demon_4"),
            (assign,":number",1),
          (else_try),
            (ge, ":r", 4),
            (assign,":spawn_troop_id","trp_demon_3"),
            (assign,":number",2),
          (else_try),
            (ge, ":r", 2),
            (assign,":spawn_troop_id","trp_demon_2"),
            (assign,":number",2),
          (else_try),
            (assign,":spawn_troop_id","trp_demon_1_2"),
            (assign,":number",3),
          (try_end),
          
        (try_end),
        
        
      (gt,":spawn_troop_id",0),
      (gt,":number",0),
      (try_begin),
        (agent_has_item_equipped,":shooter","itm_magic_book_7"),
        (gt,":spawn_troop_id",0),
        (val_add,":number",2),
      (try_end),
      
        (copy_position, pos51, pos5),
        (call_script,"script_cf_agent_spawn_agent_to_pos51", ":shooter", ":spawn_troop_id", ":number"),
    (else_try),  
      (eq,":cast_spell","itm_magic_soul_leech"),
      (assign, ":num_hit", 1),
      (try_begin),
        (assign,":max_range",200),
        (assign,":damage",50),
        (assign,":heal",50),
        (store_mul,":range_add",":power", 40),
        (store_mul,":damage_add",":power", 30),
        (val_add,":max_range",":range_add"),
        (store_add,":max_damage",":damage",":damage_add"),
        (store_mul,":spec_power",":power", 3),
        (val_add,":heal",":damage_add"),
      (try_end),
        (try_begin),
          (agent_has_item_equipped,":shooter","itm_magic_book_8"),
          (val_add,":max_range",":range_add"),
        (try_end),
        (try_begin),
          (agent_has_item_equipped,":shooter","itm_magic_book_9"),
          (val_add,":max_range",":range_add"),
        (try_end),
      
        (particle_system_burst, "psys_death_cloud_blue", pos5, 10),
        (agent_play_sound,":shooter","snd_death_cld"),
        (store_div,":half_damage",":max_damage",2),
      (try_for_agents,":possable_agent"),
        (gt,":max_damage",0),
        (agent_is_alive,":possable_agent"),
        (this_or_next|agent_is_ally,":shooter"),
        (agent_is_ally,":possable_agent"),
        (this_or_next|neg|agent_is_ally,":possable_agent"),
        (neg|agent_is_ally,":shooter"),

        (agent_get_position,pos3,":possable_agent"),
        (get_distance_between_positions,":dist",pos5,pos3),
        (le,":dist",":max_range"),
        (assign,":agent",":possable_agent"),
        (store_random_in_range, ":damage", ":half_damage",":max_damage"),
        #(agent_deliver_damage_to_agent,":shooter",":agent", ":damage"),
        (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":damage", curse, ":spec_power", ":power"),
        (val_add, ":num_hit", 1),
        (try_begin),
          #(agent_has_item_equipped,":shooter","itm_magic_book_8"),
          (store_agent_hit_points, ":hp", ":agent"),
          (le, ":hp", 5),
          (store_random_in_range, ":r", 0, 2),
          (try_begin),
            (eq, ":r", 0),
            (store_random_in_range, ":spawn_troop_id", "trp_zombie_1", "trp_skeleton"),
          (else_try),
            (store_random_in_range, ":spawn_troop_id", "trp_draugr_1", "trp_mummy_2_1"),
          (try_end),
          (call_script,"script_cf_agent_spawn_agent_to_pos51", ":shooter", ":spawn_troop_id", 1),
        (try_end),
        (try_begin),
          (agent_has_item_equipped,":shooter","itm_magic_book_9"),
          (store_agent_hit_points, ":inflicted_agent_hp", ":agent", 0),
          (store_mul,":dead_power",":power", 5),
          (ge, ":dead_power", ":inflicted_agent_hp"),
          (agent_set_hit_points,":agent",0,0),
          (agent_deliver_damage_to_agent, ":shooter", ":agent", 100),
        (try_end),
        
      (try_end),
        
      (store_agent_hit_points, ":hp", ":shooter"),
      (store_mul,":spec_power",":num_hit", 25),
      (val_add, ":hp", 50),
      (val_add, ":hp", ":spec_power"),
      (agent_set_hit_points, ":shooter", ":hp"),
        
      (agent_get_position,pos6,":shooter"),
      (try_for_agents,":possable_agent"),
          (gt,":num_hit",0),
          (agent_is_alive,":possable_agent"),

          (this_or_next|agent_is_ally,":shooter"),
          (neg|agent_is_ally,":possable_agent"),
          (this_or_next|agent_is_ally,":possable_agent"),
          (neg|agent_is_ally,":shooter"),


          (agent_get_position,pos3,":possable_agent"),
          (get_distance_between_positions,":dist",pos6,pos3),
          (le,":dist",":max_range"),
          (assign,":agent",":possable_agent"),
          (val_add, ":num_hit", -1),
          (store_agent_hit_points, ":hp", ":agent"),
          (val_add, ":hp", ":heal"),
          (agent_set_hit_points, ":agent", ":hp"),
          (position_move_z,pos3,100),
          (particle_system_burst, "psys_heal_effect", pos3, 30), 
      (try_end),
    (else_try),  
      (eq,":cast_spell","itm_magic_heal"),
      (try_begin),
        (assign,":max_range",100),
        (assign,":heal",50),
        (store_mul,":range_add",":power", 40),
        (store_mul,":damage_add",":power", 10),
        (val_add,":max_range",":range_add"),
        (val_add,":heal",":damage_add"),
      (try_end),
      
        (try_for_agents,":possable_agent"),
          (gt,":heal",0),
          (agent_is_alive,":possable_agent"),

          (this_or_next|agent_is_ally,":shooter"),
          (neg|agent_is_ally,":possable_agent"),
          (this_or_next|agent_is_ally,":possable_agent"),
          (neg|agent_is_ally,":shooter"),


          (agent_get_position,pos3,":possable_agent"),
          (get_distance_between_positions,":dist",pos5,pos3),
          (le,":dist",":max_range"),
          (assign,":agent",":possable_agent"),

          (store_agent_hit_points, ":hp", ":agent"),
          (val_add, ":hp", ":heal"),
          (agent_set_hit_points, ":agent", ":hp"),
          (position_move_z,pos3,100),
          (particle_system_burst, "psys_heal_effect", pos3, 30), 
        (try_end),
    (else_try),  
      (eq,":cast_spell","itm_magic_curse"),
      
      (try_begin),
        (eq, ":weapon", "itm_lich_staff_1"),
        (val_add,":power",1),
      (else_try),
        (eq, ":weapon", "itm_archlich_staff_1"),
        (val_add,":power",2),
      (try_end),
      (try_begin),
        (assign,":max_range",100),
        (assign,":damage",50),
        (store_mul,":range_add",":power", 20),
        (store_mul,":damage_add",":power", 50),
        (val_add,":max_range",":range_add"),
        (store_add,":max_damage",":damage",":damage_add"),
      (try_end),
      
      (copy_position,pos6,pos5),
      (position_move_z,pos6,200),
      (particle_system_burst, "psys_magic_curse_small", pos6, 3),
        (try_for_agents,":possable_agent"),
          (gt,":damage",0),
          (agent_is_alive,":possable_agent"),
          (this_or_next|agent_is_ally,":shooter"),
          (agent_is_ally,":possable_agent"),
          (this_or_next|neg|agent_is_ally,":possable_agent"),
          (neg|agent_is_ally,":shooter"),

          (agent_get_position,pos3,":possable_agent"),
          (get_distance_between_positions,":dist",pos5,pos3),
          (le,":dist",":max_range"),
          (assign,":agent",":possable_agent"),

          #(agent_deliver_damage_to_agent,":shooter",":agent", ":damage"),
          (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":max_damage", curse, ":power", 15),
          (agent_set_slot, ":agent", slot_agent_special_ability_affect_type, mummy_curse),
          (agent_set_slot, ":agent", slot_agent_special_ability_affect_time, 15),
          
          
          (assign,":max_damage",100),
        (try_end),
    (else_try),  
      (eq,":cast_spell","itm_magic_slow"),
      (try_begin),
        (eq, ":weapon", "itm_lich_staff_1"),
        (val_add,":power",1),
      (else_try),
        (eq, ":weapon", "itm_archlich_staff_1"),
        (val_add,":power",2),
      (try_end),
      (try_begin),
        (assign,":max_range",100),
        (assign,":damage",50),
        (store_mul,":range_add",":power", 20),
        (store_mul,":damage_add",":power", 50),
        (val_add,":max_range",":range_add"),
        (store_add,":max_damage",":damage",":damage_add"),
      (try_end),
      (copy_position,pos6,pos5),
      (position_move_z,pos6,200),
      (particle_system_burst, "psys_magic_curse_small", pos6, 3),
      
        (try_for_agents,":possable_agent"),
          (gt,":damage",0),
          (agent_is_alive,":possable_agent"),
          (this_or_next|agent_is_ally,":shooter"),
          (agent_is_ally,":possable_agent"),
          (this_or_next|neg|agent_is_ally,":possable_agent"),
          (neg|agent_is_ally,":shooter"),

          (agent_get_position,pos3,":possable_agent"),
          (get_distance_between_positions,":dist",pos5,pos3),
          (le,":dist",":max_range"),
          (assign,":agent",":possable_agent"),

          #(agent_deliver_damage_to_agent,":shooter",":agent", ":damage"),
          (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":max_damage", curse, ":power", 15),
          (agent_set_slot, ":agent", slot_agent_special_ability_affect_type, slow),
          (agent_set_slot, ":agent", slot_agent_special_ability_affect_time, 15),
          (assign,":max_damage",100),
        (try_end),
    (else_try),  
      (eq,":cast_spell","itm_magic_weakness"),
      (try_begin),
        (eq, ":weapon", "itm_lich_staff_1"),
        (val_add,":power",1),
      (else_try),
        (eq, ":weapon", "itm_archlich_staff_1"),
        (val_add,":power",2),
      (try_end),
      
      (try_begin),
        (assign,":max_range",100),
        (assign,":damage",50),
        (store_mul,":range_add",":power", 20),
        (store_mul,":damage_add",":power", 50),
        (val_add,":max_range",":range_add"),
        (store_add,":max_damage",":damage",":damage_add"),
      (try_end),
        (try_for_agents,":possable_agent"),
          (gt,":damage",0),
          (agent_is_alive,":possable_agent"),
          (this_or_next|agent_is_ally,":shooter"),
          (agent_is_ally,":possable_agent"),
          (this_or_next|neg|agent_is_ally,":possable_agent"),
          (neg|agent_is_ally,":shooter"),

          (agent_get_position,pos3,":possable_agent"),
          (get_distance_between_positions,":dist",pos5,pos3),
          (le,":dist",":max_range"),
          (assign,":agent",":possable_agent"),

          #(agent_deliver_damage_to_agent,":shooter",":agent", ":damage"),
          (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":max_damage", curse, ":power", 15),
          (agent_set_slot, ":agent", slot_agent_special_ability_affect_type, weakness),
          (agent_set_slot, ":agent", slot_agent_special_ability_affect_time, 15),
          (assign,":max_damage",100),
        (try_end),
    (else_try),  
      (eq,":cast_spell","itm_skill_frozen_orb"),
    (else_try),  
      (eq,":cast_spell","itm_skill_frozen_orb"),
    (else_try),  
      (eq,":cast_spell","itm_skill_frozen_orb"),
    (else_try),  
      (eq,":cast_spell","itm_skill_frozen_orb"),
    (else_try),  
      (eq,":cast_spell","itm_skill_frozen_orb"),
    (else_try),  
      (eq,":cast_spell","itm_skill_frozen_orb"),
    (else_try),  
      (eq,":cast_spell","itm_skill_frozen_orb"),
    (try_end),  
  ]),   



